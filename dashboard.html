<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Plateforme Ballanfat</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f7fafc;
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logo {
      height: 40px;
      width: auto;
    }
    
    .header-title {
      font-size: 20px;
      font-weight: 600;
      color: #1a202c;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: #f7fafc;
      border-radius: 8px;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    
    .user-details {
      display: flex;
      flex-direction: column;
    }
    
    .user-email {
      font-size: 14px;
      color: #2d3748;
      font-weight: 500;
    }
    
    .user-role {
      font-size: 12px;
      color: #718096;
    }
    
    .btn-logout {
      padding: 8px 16px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      color: #e53e3e;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-logout:hover {
      background: #fff5f5;
      border-color: #feb2b2;
    }
    
    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 48px 32px;
    }
    
    .welcome {
      margin-bottom: 48px;
    }
    
    .welcome h1 {
      font-size: 32px;
      color: #1a202c;
      margin-bottom: 8px;
    }
    
    .welcome p {
      font-size: 16px;
      color: #718096;
    }
    
    /* Modules Grid */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 48px;
    }
    
    .module-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.3s;
      cursor: pointer;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }
    
    .module-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--module-color-start), var(--module-color-end));
    }
    
    .module-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
      border-color: var(--module-color-start);
    }
    
    .module-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .module-card.disabled::after {
      content: 'ðŸ”’ AccÃ¨s restreint';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .module-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .module-title {
      font-size: 20px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 8px;
    }
    
    .module-description {
      font-size: 14px;
      color: #718096;
      line-height: 1.5;
      margin-bottom: 16px;
    }
    
    .module-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .module-status.operational {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .module-status.beta {
      background: #feebc8;
      color: #7c2d12;
    }
    
    .module-status.planned {
      background: #e6fffa;
      color: #234e52;
    }
    
    .module-status.development {
      background: #bee3f8;
      color: #2c5282;
    }
    
    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 48px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stat-label {
      font-size: 14px;
      color: #718096;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #1a202c;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 24px 16px;
      }
      
      .header {
        padding: 12px 16px;
        flex-direction: column;
        gap: 12px;
      }
      
      .modules-grid {
        grid-template-columns: 1fr;
      }
      
      .welcome h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <img src="logo_ballanfat.png" alt="Logo" class="logo" onerror="this.style.display='none'">
      <div class="header-title">Plateforme Ballanfat</div>
    </div>
    
    <div class="header-right">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-details">
          <div class="user-email" id="userEmail">Chargement...</div>
          <div class="user-role" id="userRole">Utilisateur</div>
        </div>
      </div>
      
      <button class="btn-logout" id="btnLogout">
        ðŸšª DÃ©connexion
      </button>
    </div>
  </div>
  
  <!-- Container -->
  <div class="container">
    <!-- Welcome -->
    <div class="welcome">
      <h1>Bienvenue sur votre espace de gestion ðŸ‘‹</h1>
      <p>AccÃ©dez Ã  tous vos outils de gestion administrative digitale</p>
    </div>
    
    <!-- Stats (optionnel - Ã  remplir dynamiquement) -->
    <div class="stats" id="stats" style="display: none;">
      <div class="stat-card">
        <div class="stat-label">Factures traitÃ©es</div>
        <div class="stat-value" id="statFactures">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Grilles tarifaires</div>
        <div class="stat-value" id="statGrilles">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Modules actifs</div>
        <div class="stat-value" id="statModules">-</div>
      </div>
    </div>
    
    <!-- Modules Grid -->
    <div class="modules-grid" id="modulesGrid">
      <!-- Modules chargÃ©s dynamiquement -->
    </div>
  </div>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Configuration -->
  <script src="./config.js"></script>
  
  <!-- Auth Manager -->
  <script src="./scripts/auth-manager.js"></script>
  
  <!-- Script Dashboard -->
  <script>
    // Initialiser Supabase Client
    window.supabaseClient = supabase.createClient(
      window.SUPABASE_CONFIG.url,
      window.SUPABASE_CONFIG.anonKey,
      window.SUPABASE_CONFIG.options
    );
    
    // Configuration modules
    const MODULES = [
      {
        id: 'gestion_factures',
        icon: 'ðŸ“„',
        title: 'Gestion Factures',
        description: 'Upload, extraction, validation et export vers grilles tarifaires',
        url: 'gestion-factures.html',
        status: 'operational',
        statusLabel: 'âœ… OpÃ©rationnel',
        permission: 'extraction_factures.view',
        colors: ['#667eea', '#764ba2']
      },
      {
        id: 'grille_tarifaire',
        icon: 'ðŸ“Š',
        title: 'Tarification',
        description: 'Gestion des tarifs par client, annÃ©e et catÃ©gorie de vÃ©hicule',
        url: 'tarification.html',
        status: 'operational',
        statusLabel: 'âœ… OpÃ©rationnel',
        permission: 'grille_tarifaire.view',
        colors: ['#f093fb', '#f5576c']
      },
      {
        id: 'paye_chauffeurs',
        icon: 'ðŸ’°',
        title: 'Paye Chauffeurs',
        description: 'Saisie mensuelle des donnÃ©es de paye et export PDF',
        url: 'paye-chauffeurs.html',
        status: 'planned',
        statusLabel: 'ðŸ“‹ Janvier 2026',
        permission: 'paye_chauffeurs.view',
        colors: ['#4facfe', '#00f2fe']
      },
      {
        id: 'tresorerie',
        icon: 'ðŸ’µ',
        title: 'TrÃ©sorerie',
        description: 'Suivi flux financiers, prÃ©visions et rapprochement bancaire',
        url: '/tresorerie.html',
        status: 'planned',
        statusLabel: 'ðŸ“‹ FÃ©vrier-Mai 2026',
        permission: 'tresorerie.view',
        colors: ['#43e97b', '#38f9d7']
      },
      {
        id: 'outils_admin',
        icon: 'ðŸ§¾',
        title: 'Outils Administratifs',
        description: 'Registres, calculateur trajets, attestations conformitÃ©',
        url: '/outils-admin.html',
        status: 'planned',
        statusLabel: 'ðŸ“‹ Juin+ 2026',
        permission: 'extraction_factures.view', // MÃªme permission que factures pour l'instant
        colors: ['#fa709a', '#fee140']
      },
      {
        id: 'documents',
        icon: 'ðŸ“',
        title: 'Gestion Documentaire',
        description: 'Stockage et organisation des documents administratifs',
        url: '/documents.html',
        status: 'planned',
        statusLabel: 'ðŸ“‹ Ã€ venir',
        permission: 'extraction_factures.view',
        colors: ['#30cfd0', '#330867']
      }
    ];
    
    // Ã‰lÃ©ments DOM
    const userEmailEl = document.getElementById('userEmail');
    const userRoleEl = document.getElementById('userRole');
    const userAvatarEl = document.getElementById('userAvatar');
    const btnLogout = document.getElementById('btnLogout');
    const modulesGrid = document.getElementById('modulesGrid');
    
    // Initialisation
    async function init() {
      console.log("ðŸš€ Initialisation Dashboard");
      
      // ProtÃ©ger page (redirection si non connectÃ©)
      const isAuthenticated = await AuthManager.protectPage();
      if (!isAuthenticated) return;
      
      // Afficher infos utilisateur
      displayUserInfo();
      
      // Charger modules
      loadModules();
      
      // Ã‰vÃ©nement dÃ©connexion
      btnLogout.addEventListener('click', () => {
        if (confirm('ÃŠtes-vous sÃ»r de vouloir vous dÃ©connecter ?')) {
          AuthManager.signOut();
        }
      });
    }
    
    // Afficher informations utilisateur
    function displayUserInfo() {
      const email = AuthManager.getUserEmail();
      const role = AuthManager.getUserRole();
      
      userEmailEl.textContent = email;
      
      const roleLabels = {
        admin: 'Administrateur',
        editor: 'Ã‰diteur',
        viewer: 'Lecteur'
      };
      userRoleEl.textContent = roleLabels[role] || 'Utilisateur';
      
      // Avatar (premiÃ¨re lettre email)
      userAvatarEl.textContent = email.charAt(0).toUpperCase();
    }
    
    // Charger modules
    function loadModules() {
      modulesGrid.innerHTML = '';
      
      let accessibleCount = 0;
      
      MODULES.forEach(module => {
        const hasAccess = AuthManager.hasPermission(module.permission);
        
        if (hasAccess) accessibleCount++;
        
        const card = document.createElement('div');
        card.className = 'module-card' + (hasAccess ? '' : ' disabled');
        card.style.setProperty('--module-color-start', module.colors[0]);
        card.style.setProperty('--module-color-end', module.colors[1]);
        
        card.innerHTML = `
          <div class="module-icon">${module.icon}</div>
          <div class="module-title">${module.title}</div>
          <div class="module-description">${module.description}</div>
          <div class="module-status ${module.status}">${module.statusLabel}</div>
        `;
        
        // Navigation si accessible ET opÃ©rationnel
        if (hasAccess && module.status === 'operational') {
          card.addEventListener('click', () => {
            window.location.href = module.url;
          });
        } else if (hasAccess && module.status !== 'operational') {
          card.style.cursor = 'not-allowed';
          card.title = 'Module en dÃ©veloppement';
        }
        
        modulesGrid.appendChild(card);
      });
      
      // Afficher stat modules accessibles
      document.getElementById('statModules').textContent = accessibleCount;
    }
    
    // Lancer initialisation
    init();
  </script>
</body>
</html>
