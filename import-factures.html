<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Import Factures - v2.7.0</title>

  <!-- Styles CSS -->
  <link rel="stylesheet" href="./styles/main.css">
  <link rel="stylesheet" href="./styles/modal.css">

  <!-- PDF.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- Supabase JS Client (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Configuration Supabase -->
  <script src="./config.js"></script>
</head>

<body>
<!-- ===========================
     HEADER
     =========================== -->
<header>
  <div class="row" style="align-items:center;">
    <button class="btn" id="backBtn">â¬…ï¸ Retour</button>
    <div>
      <div style="font-weight:900;">ğŸ“¤ Import Factures â€” v2.7.0 Refacto</div>
      <div class="muted small">Architecture modulaire + validation stricte + JSDoc complÃ¨te</div>
    </div>
  </div>

  <div class="row" style="align-items:center;">
    <span class="muted" id="authStatus">Connexionâ€¦</span>
    <input class="field" id="email" type="email" placeholder="Email">
    <input class="field" id="pass" type="password" placeholder="Mot de passe">
    <button class="btn primary" id="loginBtn">Se connecter</button>
    <button class="btn" id="logoutBtn" disabled>Se dÃ©connecter</button>
  </div>
</header>

<!-- ===========================
     MAIN CONTENT
     =========================== -->
<main>
  <!-- Messages -->
  <div id="msg" class="msg warn" style="display:none;"></div>

  <!-- Notice -->
  <div class="notice">
    âœ… Upload + extraction texte automatique<br>
    âœ… Table detector v2 robuste (mÃªme si header introuvable)<br>
    âœ… Edition complÃ¨te + validation stricte + autosave
  </div>

  <!-- Upload Zone -->
  <div class="card">
    <div class="drop" id="drop">
      <div style="font-size:18px; font-weight:900;">Glisse-dÃ©pose tes PDFs ici</div>
      <div class="muted">PDF uniquement â€¢ max 10 MB/fichier â€¢ max 20 fichiers</div>
      <div style="margin-top:12px;">
        <input type="file" id="fileInput" accept="application/pdf" multiple>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="startBtn" disabled>ğŸš€ Uploader & Extraire</button>
      <button class="btn" id="clearBtn" disabled>ğŸ§¹ Vider la liste</button>
      <button class="btn" id="reloadBtn">ğŸ”„ Recharger la liste</button>
    </div>

    <div class="muted small" style="margin-top:10px;">
      ğŸ’¾ La liste est sauvegardÃ©e (localStorage). Les factures dÃ©jÃ  importÃ©es restent visibles.
    </div>
  </div>

  <!-- Liste Factures -->
 <!-- Liste Factures avec Filtres -->
<div class="card">
  <!-- Header avec compteur + bouton filtres -->
<div class="row" style="align-items:center; justify-content:space-between;">
  <div style="font-weight:900;">ğŸ“„ Factures</div>
  <div class="row" style="gap:12px; align-items:center;">
    <button class="btn small" id="btnToggleFilters" title="Afficher/masquer filtres">
      ğŸ”½ Filtres
    </button>
    <div class="muted" id="count">0</div>
  </div>
</div>

  <!-- ===== BARRE FILTRES (NOUVEAU) ===== -->
  <div class="filters-bar" style="margin-top:16px; padding:16px; background:#f5f5f5; border-radius:8px;">
    
    <!-- Ligne 1 : Recherche + Statut + Dates -->
    <div class="row" style="gap:12px; margin-bottom:12px; flex-wrap:wrap;">
      
      <!-- Recherche texte -->
      <div style="flex:1; min-width:200px;">
        <label class="muted small">ğŸ” Rechercher</label>
        <input 
          type="text" 
          class="field" 
          id="filterSearch" 
          placeholder="Nom fichier, client..."
          style="width:100%; margin-top:4px;"
        >
      </div>

      <!-- Filtre statut -->
      <div style="min-width:150px;">
        <label class="muted small">ğŸ“Š Statut</label>
        <select class="field" id="filterStatus" style="width:100%; margin-top:4px;">
          <option value="all">Tous</option>
          <option value="pending">En attente</option>
          <option value="processing">Traitement</option>
          <option value="extracted">Extrait</option>
          <option value="done">TerminÃ©</option>
          <option value="error">Erreur</option>
        </select>
      </div>

      <!-- Date dÃ©but -->
      <div style="min-width:140px;">
        <label class="muted small">ğŸ“… Du</label>
        <input 
          type="date" 
          class="field" 
          id="filterDateFrom"
          style="width:100%; margin-top:4px;"
        >
      </div>

      <!-- Date fin -->
      <div style="min-width:140px;">
        <label class="muted small">ğŸ“… Au</label>
        <input 
          type="date" 
          class="field" 
          id="filterDateTo"
          style="width:100%; margin-top:4px;"
        >
      </div>

    </div>

    <!-- Ligne 2 : Items par page + Actions -->
    <div class="row" style="gap:12px; align-items:flex-end; flex-wrap:wrap;">
      
      <!-- Items par page -->
      <div style="min-width:120px;">
        <label class="muted small">ğŸ“„ Par page</label>
        <select class="field" id="filterPerPage" style="width:100%; margin-top:4px;">
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="999999">Tous</option>
        </select>
      </div>

      <!-- Boutons actions -->
      <div style="flex:1; display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn small" id="btnResetFilters" title="RÃ©initialiser filtres">
          ğŸ”„ RAZ
        </button>
        <button class="btn small primary" id="btnExportCSV" title="Exporter CSV">
          ğŸ“¥ Export CSV
        </button>
      </div>

    </div>

  </div>
  <!-- ===== FIN BARRE FILTRES ===== -->

  <!-- Info rÃ©sultats (nouveau) -->
  <div class="muted small" id="filterInfo" style="margin-top:12px; padding:8px; background:#e3f2fd; border-radius:4px; display:none;">
    Affichage <span id="rangeStart">1</span>-<span id="rangeEnd">20</span> sur <span id="totalFiltered">0</span> factures
  </div>

  <!-- Tableau factures -->
  <div style="overflow:auto; margin-top:10px;">
    <table style="table-layout:fixed; width:100%;">
      <colgroup>
        <col style="width:35%">  <!-- FICHIER -->
        <col style="width:12%">  <!-- TAILLE -->
        <col style="width:15%">  <!-- STATUT -->
        <col style="width:13%">  <!-- DATE -->
        <col style="width:12%">  <!-- ID -->
        <col style="width:13%">  <!-- ACTIONS -->
      </colgroup>
      <thead>
        <tr>
          <th data-sort="fileName" style="cursor:pointer; user-select:none;">
            Fichier <span id="sortFileName"></span>
          </th>
          <th data-sort="size" style="cursor:pointer; user-select:none;">
            Taille <span id="sortSize"></span>
          </th>
          <th data-sort="status" style="cursor:pointer; user-select:none;">
            Statut <span id="sortStatus"></span>
          </th>
          <th data-sort="created_at" style="cursor:pointer; user-select:none;">
            Date <span id="sortCreatedAt"></span>
          </th>
          <th>ID</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="6" class="muted">Aucune facture</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination (nouveau) -->
  <div class="row" id="pagination" style="margin-top:16px; justify-content:space-between; align-items:center; display:none;">
    <button class="btn small" id="btnPrevPage" disabled>â—€ PrÃ©cÃ©dent</button>
    <div class="muted">
      Page <span id="currentPage">1</span> / <span id="totalPages">1</span>
    </div>
    <button class="btn small" id="btnNextPage" disabled>Suivant â–¶</button>
  </div>

</div>

<!-- ===========================
     MODAL VIEWER
     =========================== -->
<div id="modal">
  <div class="modalBox">
    <!-- Modal Header -->
    <div class="modalHead">
      <div class="row" style="align-items:center;">
        <div style="font-weight:900;" id="meta">Facture</div>
        <div id="tags"></div>
        <span class="muted small" id="autosaveInfo" style="display:none;"></span>
      </div>
      <div class="row" style="align-items:center;">
        <button class="btn small" id="reparseBtn">ğŸ”„ Re-parser</button>
        <button class="btn small primary" id="saveBtn">ğŸ’¾ Sauvegarder</button>
        <button class="btn small" id="closeBtn">âœ–ï¸ Fermer</button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="modalBody">
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="edit">âœï¸ Ã‰dition</div>
        <div class="tab" data-tab="table">ğŸ“Š Tableau extrait</div>
        <div class="tab" data-tab="text">ğŸ“„ Texte OCR</div>
        <div class="tab" data-tab="debug">ğŸ” Debug JSON</div>
      </div>

      <!-- Tab: Ã‰dition -->
      <div id="tab-edit" class="active">
        <div class="muted small" style="margin:8px 0;">
          Champs principaux dÃ©tectÃ©s automatiquement. Tu peux les corriger.
        </div>

        <div id="editHeader" class="grid2"></div>

        <div style="margin:12px 0;">
          <div style="font-weight:900; margin-bottom:8px;">Lignes Services / DÃ©bours</div>
          <div id="editLines"></div>
          <button class="btn small" id="addLineBtn" style="margin-top:8px;">â• Ajouter une ligne</button>
        </div>
      </div>

      <!-- Tab: Tableau extrait -->
      <div id="tab-table" style="display:none;">
        <div class="muted small" style="margin:8px 0;">
          Tableau reconstruit depuis tokens PDF (X/Y). Si header introuvable â†’ mode headerless.
        </div>
        <div id="tableHtml"></div>
      </div>

      <!-- Tab: Texte OCR -->
      <div id="tab-text" style="display:none;">
        <div class="muted small" style="margin:8px 0;">
          Les Ã©lÃ©ments reconnus sont surlignÃ©s.
        </div>
        <div id="textHtml" style="white-space:pre-wrap; word-break:break-word; background:#fafafa; border:1px solid #eee; border-radius:14px; padding:12px; font-size:13px; line-height:1.35;"></div>
      </div>

      <!-- Tab: Debug JSON -->
      <div id="tab-debug" style="display:none;">
        <div class="muted small" style="margin:8px 0;">donnees_brutes (JSON)</div>
        <pre id="debugJson" class="mono" style="background:#0b1020; color:#e5e7eb; border-radius:14px; padding:12px; overflow:auto; max-height:55vh;"></pre>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     SCRIPTS MODULES
     =========================== -->
<!-- Configuration -->
<script src="./config.js"></script>

  <!-- Initialiser Supabase Client -->
<script>
  if (!window.supabaseClient && window.SUPABASE_CONFIG) {
    window.supabaseClient = supabase.createClient(
      window.SUPABASE_CONFIG.url,
      window.SUPABASE_CONFIG.anonKey,
      window.SUPABASE_CONFIG.options
    );
    console.log("âœ… Supabase client initialisÃ©");
  }
</script>

<!-- Modules JS (ordre important) -->
<!-- Auth Manager (doit Ãªtre chargÃ© AVANT les autres modules) -->
<script src="./scripts/auth-manager.js"></script>

<script src="./scripts/state.js"></script>
<script src="./scripts/validation.js"></script>
<script src="./scripts/parser.js"></script>
<script src="./scripts/pdf-extractor.js"></script>
<script src="./scripts/supabase-client.js"></script>
<script src="./scripts/filters.js"></script>
<script src="./scripts/ui-renderer.js"></script>
<!-- Protection page : redirection si non connectÃ© -->
<script>
(async () => {
  await AuthManager.protectPage("extraction_factures.view");
})();
</script>
<script src="./scripts/main.js"></script>

<!-- PATCH v3.2 - Tout dans donnees_brutes -->
<script>
(function() {
  console.log('ğŸ”§ Patch v3.2 - DonnÃ©es complÃ¨tes');
  
  setTimeout(async function() {
    const btn = document.getElementById('startBtn');
    
    if (!btn) {
      console.error('âŒ Bouton introuvable');
      return;
    }
    
    console.log('âœ… Bouton trouvÃ©');
    btn.disabled = false;
    
    const newBtn = btn.cloneNode(true);
    newBtn.disabled = false;
    btn.parentNode.replaceChild(newBtn, btn);
    
    newBtn.addEventListener('click', async function(e) {
      console.log('ğŸ”¥ CLICK !');
      e.preventDefault();
      
      const files = StateManager?.getFiles() || [];
      console.log('ğŸ“ Total fichiers:', files.length);
      
      const toProcess = files.filter(f => f.kind === "local" && f.status === "ready");
      console.log('âœ… Ã€ traiter:', toProcess.length);
      
      if (toProcess.length === 0) {
        UIRenderer.showMessage("warn", "âš ï¸ Aucun fichier Ã  traiter");
        return;
      }
      
      console.log('â³ DÃ©but traitement...');
      UIRenderer.showMessage("warn", "â³ Traitement de " + toProcess.length + " fichier(s)...");
      
      try {
        for(let i = 0; i < toProcess.length; i++) {
          const fileEntry = toProcess[i];
          const file = fileEntry.file;
          const fileName = file.name;
          
          console.log(`ğŸ“„ Traitement ${i+1}/${toProcess.length}: ${fileName}`);
          
          StateManager.updateFile(fileName, { status: "uploading" });
          
          const timestamp = Date.now();
          const sanitized = fileName.replace(/[^a-zA-Z0-9.\-_]/g, "_");
          const storagePath = "2025/" + timestamp + "_" + sanitized;
          
          console.log('ğŸ“¤ Upload vers:', storagePath);
          const uploadResult = await SupabaseClient.uploadFile(file, storagePath);
          
          if(uploadResult.error) {
            console.error('âŒ Erreur upload:', uploadResult.error);
            throw new Error("Upload failed: " + uploadResult.error.message);
          }
          
          console.log('âœ… Upload OK');
          
          const { data: { user } } = await window.supabaseClient.auth.getUser();
          
          console.log('ğŸ’¾ CrÃ©ation facture DB...');
          const createResult = await SupabaseClient.createFacture({
            fichier_url: storagePath,
            fichier_nom: fileName,
            statut: "pending",
            user_id: user?.id
          });
          
          if(createResult.error) {
            console.error('âŒ Erreur crÃ©ation DB:', createResult.error);
            throw new Error("Create failed: " + createResult.error.message);
          }
          
          const factureId = createResult.data.id;
          console.log('âœ… Facture crÃ©Ã©e, ID:', factureId);
          
          StateManager.updateFile(fileName, { status: "extracting", factureId: factureId });
          
          console.log('ğŸ“„ Extraction PDF...');
          const arrayBuffer = await file.arrayBuffer();
          const arrayBufferCopy1 = arrayBuffer.slice(0);
          const arrayBufferCopy2 = arrayBuffer.slice(0);
          
          const fullText = await PDFExtractor.extractPdfTextFromArrayBuffer(arrayBufferCopy1);
          console.log('âœ… Texte extrait (longueur):', fullText.length);
          console.log('ğŸ“„ AperÃ§u texte:', fullText.substring(0, 200));
          
          const pagesXY = await PDFExtractor.extractPdfItemsXY(arrayBufferCopy2);
          console.log('âœ… Items XY extraits:', pagesXY.length, 'pages');
          
          console.log('ğŸ” Parsing champs...');
          const fields = ParserModule.parseFieldsRobust(fullText);
          console.log('âœ… Champs parsÃ©s:', JSON.stringify(fields));
          
          const table = [];
          for(let p = 0; p < pagesXY.length; p++) {
            const pageItems = pagesXY[p].items;
            const extracted = ParserModule.extractTableFromXY(pageItems, fullText);
            
            console.log(`ğŸ“Š Page ${p+1}: ${extracted.services.length} services trouvÃ©s`);
            
            if(extracted.services.length > 0) {
              table.push(extracted);
            }
          }
          
          console.log('âœ… Tableau extrait:', JSON.stringify(table));
          
          // SOLUTION : Tout sauvegarder dans donnees_brutes + texte_ocr
          const donneesCompletes = {
            fullText: fullText,
            fields: fields,
            table: table,
            _meta: {
              extracted_at: new Date().toISOString(),
              version: "v3.2"
            }
          };
          
          console.log('ğŸ’¾ Sauvegarde complÃ¨te...');
          const updateResult = await SupabaseClient.updateFacture(factureId, {
            statut: "extracted",
            texte_ocr: fullText,           // Pour l'onglet Texte OCR
            donnees_brutes: donneesCompletes  // Tout le reste
          });
          
          if(updateResult.error) {
            console.error('âš ï¸ Erreur update:', updateResult.error);
          } else {
            console.log('âœ… DonnÃ©es sauvegardÃ©es complÃ¨tement');
          }
          
          StateManager.updateFile(fileName, { 
            status: "done",
            factureId: factureId,
            extracted: { fields, table, fullText }
          });
          
          console.log(`âœ… Fichier ${i+1}/${toProcess.length} terminÃ©`);
        }
        
        UIRenderer.showTempMessage("ok", "âœ… Traitement terminÃ© !");
        console.log('ğŸ‰ TOUS LES FICHIERS TRAITÃ‰S !');
        
        // Recharger pour voir les rÃ©sultats
        setTimeout(() => {
          console.log('ğŸ”„ Rechargement page...');
          location.reload();
        }, 1500);
        
      } catch(err) {
        console.error('âŒ ERREUR TRAITEMENT:', err);
        UIRenderer.showMessage("err", "âŒ Erreur: " + err.message);
      }
    });
    
    console.log('âœ… Patch v3.2 appliquÃ©');
    
  }, 1500);
})();
</script>

  <!-- PATCH v3.3 - Fix onglets modale -->
<script>
(function() {
  console.log('ğŸ”§ Patch v3.3 - Fix affichage onglets');
  
  // Attendre que l'app soit initialisÃ©e
  setTimeout(function() {
    
    // Intercepter les clics sur les lignes du tableau
    const tbody = document.getElementById('tbody');
    if (!tbody) return;
    
    tbody.addEventListener('click', function(e) {
      const row = e.target.closest('tr[data-idx]');
      if (!row) return;
      
      console.log('ğŸ” Intercept click ligne facture');
      
      // Attendre que la modale soit ouverte
      setTimeout(function() {
        const viewerData = StateManager?.getViewerData();
        
        if (!viewerData) {
          console.warn('âš ï¸ Pas de viewerData');
          return;
        }
        
        console.log('ğŸ“Š ViewerData:', viewerData);
        
        // CORRECTION : Si rawText vide, utiliser fullText
        if (!viewerData.rawText && viewerData.data?.fullText) {
          console.log('ğŸ”§ Correction: rawText vide, utilisation fullText');
          const fullText = viewerData.data.fullText;
          
          // Mettre Ã  jour l'Ã©tat
          StateManager.setViewerData(
            viewerData.data, 
            viewerData.factureId, 
            fullText
          );
          
          // RafraÃ®chir les onglets
          UIRenderer.renderHighlightedText(fullText, []);
          UIRenderer.renderDebugJson(viewerData.data);
          
          console.log('âœ… Onglets corrigÃ©s avec fullText');
        } else if (viewerData.rawText) {
          console.log('âœ… rawText prÃ©sent, pas de correction nÃ©cessaire');
        }
      }, 500);
      
    }, true); // true = capture phase
    
    console.log('âœ… Patch v3.3 appliquÃ©');
    
  }, 2000);
})();
</script>

  <!-- PATCH v3.4 - Fix onglet Texte OCR -->
<script>
(function() {
  console.log('ğŸ”§ Patch v3.4 - Fix Texte OCR');
  
  // Attendre chargement complet
  setTimeout(function() {
    
    // Intercepter changement d'onglet
    const tabs = document.querySelectorAll('.tab');
    
    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        const tabName = this.dataset.tab;
        
        console.log('ğŸ“‘ Onglet cliquÃ©:', tabName);
        
        if (tabName === 'text') {
          // Forcer affichage texte OCR
          setTimeout(function() {
            const vd = StateManager?.getViewerData();
            
            if (!vd || !vd.rawText) {
              console.warn('âš ï¸ Pas de rawText disponible');
              return;
            }
            
            console.log('ğŸ“„ Affichage texte:', vd.rawText.length, 'caractÃ¨res');
            
            const textDiv = document.getElementById('textHtml');
            if (!textDiv) {
              console.error('âŒ Ã‰lÃ©ment textHtml introuvable');
              return;
            }
            
            // Affichage simple sans highlight
            textDiv.style.whiteSpace = 'pre-wrap';
            textDiv.style.wordBreak = 'break-word';
            textDiv.textContent = vd.rawText;
            
            console.log('âœ… Texte OCR affichÃ©');
            
          }, 100);
          
        } else if (tabName === 'debug') {
          // Forcer affichage debug JSON
          setTimeout(function() {
            const vd = StateManager?.getViewerData();
            
            if (!vd || !vd.data) {
              console.warn('âš ï¸ Pas de data disponible');
              return;
            }
            
            console.log('ğŸ› Affichage debug JSON');
            
            const debugDiv = document.getElementById('debugJson');
            if (!debugDiv) {
              console.error('âŒ Ã‰lÃ©ment debugJson introuvable');
              return;
            }
            
            debugDiv.textContent = JSON.stringify(vd.data, null, 2);
            
            console.log('âœ… Debug JSON affichÃ©');
            
          }, 100);
          
        } else if (tabName === 'table') {
          // Forcer affichage tableau
          setTimeout(function() {
            const vd = StateManager?.getViewerData();
            
            if (!vd || !vd.data || !vd.data.table) {
              console.warn('âš ï¸ Pas de tableau disponible');
              return;
            }
            
            console.log('ğŸ“Š Affichage tableau');
            
            const services = [];
            vd.data.table.forEach(function(t) {
              if (t.services) services.push(...t.services);
            });
            
            console.log('ğŸ“Š Services trouvÃ©s:', services.length);
            
            UIRenderer.renderExtractedTable(services);
            
            console.log('âœ… Tableau affichÃ©');
            
          }, 100);
        }
      });
    });
    
    console.log('âœ… Patch v3.4 appliquÃ© - Onglets forcÃ©s');
    
  }, 2000);
})();
</script>
  
</body>
</html>
