<!doctype html>
<!--
=========================================================================================
AUTOCARS BALLANFAT - GRILLE TARIFAIRE
Version : v11.0.24 FINAL
Date : 5 Janvier 2026
Testeur : Alexis Ballanfat
=========================================================================================

CHANGELOG v11.0.24 FINAL (5 Jan 2026 - 11:30):
-----------------------------------------------
ğŸ› BUGFIX CRITIQUE: SyntaxError await ligne 2322
  - resetGridToInitial() appelait "await computeEvolutions()" sans Ãªtre async
  - Console: "Uncaught SyntaxError: await is only valid in async functions"
  - CORRECTION: Retrait du await, computeEvolutions() s'exÃ©cute en parallÃ¨le
  - markUnchangedPrices() ne dÃ©pend pas de computeEvolutions()
  - RÃ‰SULTAT: 0 erreur console, grille fonctionne correctement

CHANGELOG v11.0.23 FINAL (5 Jan 2026):
---------------------------------------
âœ… BUGFIX #3-4: triggerAutoSave dÃ©finie en scope global (ligne 2116)
  - Variables auto-save dÃ©clarÃ©es globalement (lignes 1736-1738)
  - Fonctions showSaveIndicator, updateLastSavedIndicator, triggerAutoSave, autoSaveGrid en scope global
  - Suppression duplications dans DOMContentLoaded
  - RÃ‰SULTAT: Sauvegarde auto TTC et Drag&Drop fonctionnelle

âœ… BUGFIX #2: AnnÃ©es chargÃ©es prioritairement depuis cloud (ligne 2142)
  - getStoredYearsForClient() priorise Supabase sur localStorage
  - Logs dÃ©taillÃ©s pour debug (cloud vs localStorage)
  - AnnÃ©e courante ajoutÃ©e par dÃ©faut si aucune trouvÃ©e
  - RÃ‰SULTAT: AnnÃ©es chargÃ©es depuis Supabase aprÃ¨s RLS dÃ©sactivÃ©

âœ… BUGFIX TEST 1.1: Import JSON + rechargement annÃ©es (ligne 2778)
  - populateYearSelectForClient() appelÃ©e aprÃ¨s saveGrid()
  - AnnÃ©e importÃ©e visible immÃ©diatement dans sÃ©lecteur
  - Re-sÃ©lection automatique de l'annÃ©e importÃ©e
  - RÃ‰SULTAT: Import JSON complet fonctionnel

=========================================================================================
-->
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Grille tarifaire V11.0.24 V.2 â€“ Autocars Ballanfat</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Supabase Client CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#f4f7fc;
    --card:#ffffff;
    --accent:#1a3c6e;
    --accent-soft:#dce7ff;
    --border:#c7d4f1;
    --text:#172133;
    --muted:#607098;
    --danger:#b3261e;
  }
  /* === HEADER V11.0.26 === */
  .header-bar-v26{
    display:grid;
    grid-template-columns:1fr auto 1fr;
    align-items:center;
    padding:20px 30px;
    background:linear-gradient(135deg,#ffffff 0%,#f8faff 100%);
    border-bottom:2px solid var(--border);
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    gap:20px;
  }

  /* GAUCHE */
  .header-left-v26{
    justify-self:start;
  }
  .title-main-v26{
    font-size:1.8rem;
    font-weight:700;
    color:var(--accent);
    letter-spacing:0.5px;
  }
  .title-sub-v26{
    font-size:0.95rem;
    color:var(--muted);
    font-weight:500;
    margin-top:4px;
  }

  /* CENTRE */
  .header-center-v26{
    justify-self:center;
  }
  .logo-center-v26{
    max-width:420px;
    max-height:140px;
    object-fit:contain;
  }

  /* DROITE */
  .header-right-v26{
    justify-self:end;
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .control-label-v26{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:0.9rem;
    color:var(--text);
  }

  .control-select-v26{
    padding:6px 10px;
    border-radius:6px;
    border:1px solid var(--border);
    background:white;
    font-size:0.9rem;
  }

  .btn-v26{
    padding:8px 12px;
    border-radius:6px;
    border:1px solid var(--border);
    background:white;
    color:var(--text);
    font-size:0.85rem;
    cursor:pointer;
    transition:all 0.2s;
    white-space:nowrap;
  }

  .btn-v26:hover{
    background:var(--accent-soft);
    border-color:var(--accent);
  }

  .btn-primary-v26{
    background:var(--accent);
    color:white;
    border-color:var(--accent);
  }

  .btn-primary-v26:hover{
    background:#142d5a;
  }

  *{box-sizing:border-box;}
  html,body{height:100%;}
  body{
    margin:0;
    padding:0;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    color:var(--text);
    background:radial-gradient(circle at top,#e9f1ff 0,#f4f7fc 40%,#eef2f9 100%);
    position:relative;
  }
  
  /* === HEADER REFONTE V11.0.26 === */
  

  /* GAUCHE: Titre */
  .header-left{
    flex:0 0 auto;
  }
  .title-block{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .title-main{
    font-size:1.8rem;
    font-weight:700;
    color:var(--accent);
    letter-spacing:0.5px;
  }
  .title-sub{
    font-size:0.95rem;
    color:var(--muted);
    font-weight:500;
  }

  /* CENTRE: Logo agrandi */
  .header-center{
    flex:1 1 auto;
    display:flex;
    justify-content:center;
  }
  .header-logo-center img{
    max-width:420px; /* Agrandi de 320px */
    max-height:140px; /* Agrandi de 110px */
    object-fit:contain;
  }

  /* DROITE: Boutons */
  .header-right{
    flex:0 0 auto;
  }
  .button-group{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
/* Logo fond fixe watermark V11.0.6 */
  body::before{
    content:"ğŸšŒ";
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    font-size:400px;
    opacity:0.03;
    z-index:-1;
    pointer-events:none;
    color:#1e3a8a;
  z-index:-1;
}


  .page{
  width:100%;
  max-width:100%;
  margin:0 auto;
  padding:24px 40px 40px;
  box-sizing:border-box;
}


  
  
  .header-left{
    display:flex;
    align-items:center;
    gap:16px;
    flex:1; /* Zone gauche */
  }
  

  .title-block{
    display:flex;
    flex-direction:column;
    gap:4px;
    /* BUGFIX V11.0.15: Centrage absolu du titre au milieu de la page */
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    text-align:center;
    pointer-events:none; /* Ne bloque pas les clics sur les Ã©lÃ©ments en dessous */
  }
  .title-block > * {
    pointer-events:auto; /* Les Ã©lÃ©ments enfants peuvent recevoir les clics */
  }
  .title-main{
    font-size:2rem; /* V11.0.6 - Agrandi */
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:0.08em;
    color:var(--accent);
  }
  .title-sub{
    font-size:1.1rem; /* V11.0.6 - Agrandi */
    color:var(--muted);
  }
  .tag{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    background:var(--accent-soft);
    color:var(--accent);
    font-size:0.72rem;
    text-transform:uppercase;
    letter-spacing:0.08em;
  }

	<button class="btn" onclick="window.location.href='gestion-factures.html'">
  ğŸ“„ Gestion Factures
</button>

  .header-right{
    display:flex;
    flex-direction:column;
    gap:6px;
    align-items:flex-end;
    flex:1; /* Zone droite - Ã©quilibre avec zone gauche */
  }
  .selectors{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    justify-content:flex-end;
  }
  .selectors label{
    font-size:0.8rem;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:4px;
  }
  select{
    font:inherit;
    font-size:0.8rem;
    padding:2px 6px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#f8fbff;
  }
  .btn{
    border-radius:999px;
    border:1px solid var(--border);
    background:#f8fbff;
    padding:3px 8px;
    font-size:0.78rem;
    font-family:inherit;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .btn-primary{
    background:var(--accent);
    color:#fff;
    border-color:var(--accent);
  }
  .btn-ghost{
    background:transparent;
  }
  .btn-icon{
    width:18px;
    height:18px;
    border-radius:50%;
    border:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:0.7rem;
  }
  .status{
    font-size:0.76rem;
    color:var(--muted);
  }
  #lastSaved{
    font-size:0.76rem;
    color:var(--muted);
  }

  .card{
    background:rgba(255,255,255,0.86);
    border-radius:14px;
    border:1px solid rgba(199,212,241,0.9);
    padding:10px 12px 12px;
    box-shadow:0 8px 22px rgba(15,35,80,0.08);
    margin-bottom:10px;
  }
  .card h2{

.params-separator{
  border:none;
  border-top:1px dashed rgba(0,0,0,0.08);
  margin:8px 0 12px;
}
.params-subtitle{
  font-size:0.85rem;
  font-weight:600;
  margin-bottom:4px;
  color:var(--muted-strong, #444);
}

/* V10.10.0 - Sections paramÃ¨tres */
.params-section{
  margin-bottom: 30px;
  padding: 20px;
  background: #f9f9f9;
  border-radius: 8px;
  border-left: 4px solid #428bca;
}
.params-section-title{
  margin: 0 0 15px 0;
  font-size: 1.1rem;
  color: #428bca;
  font-weight: 600;
}

.params-categories .table-wrapper{
  margin-top:4px;
}
.params-categories table{
  font-size:0.85rem;
}
.params-categories td:first-child label{
  display:flex;
  align-items:center;
  gap:6px;
}

.card-header-inline{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  margin-bottom:4px;
}
#categoriesContent.collapsed{
  display:none;
}
    margin:0 0 4px;
    font-size:0.98rem;
    color:var(--accent);
  }
  .card p{
    margin:0 0 6px;
    font-size:0.8rem;
    color:var(--muted);
  }
  .muted{font-size:0.78rem;color:var(--muted);}

  .params-toggle{
    display:flex;
    align-items:center;
    gap:6px;
    cursor:pointer;
    font-size:0.8rem;
    color:var(--muted);
  }
  .params-panel{
    margin-top:6px;
    padding-top:6px;
    border-top:1px dashed rgba(199,212,241,0.9);
    display:none;
    font-size:0.8rem;
  }
  .params-row{
    display:flex;
    flex-wrap:wrap;
    gap:14px;
    align-items:center;
    margin-bottom:6px;
  }
  .params-panel input[type="number"],
  .params-panel select{
    font:inherit;
    font-size:0.8rem;
    padding:2px 6px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#f8fbff;
  }
  .toggle-cat{margin-right:2px;}

  .table-wrapper{
    width:100%;
    overflow-x:auto;
    padding-bottom:4px;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:6px;
    font-size:0.81rem;
    min-width:950px;
  }
  thead th{
    background:linear-gradient(to bottom,#edf2ff,#dde7ff);
    border:1px solid rgba(199,212,241,0.95);
    padding:4px 6px;
    text-align:left;
    color:var(--accent);
    font-weight:600;
    position:sticky;
    top:0;
    z-index:3;
  }
  tbody td{
    border:1px solid rgba(180,190,215,0.4);
    padding:4px 6px;
    background:rgba(255,255,255,0.45);
  }
  tbody tr:nth-child(even) td{
    background:rgba(255,255,255,0.64);
  }

  .pricing-table{
    table-layout:fixed;
    min-width:1350px;
  }
  th.highlight-col,td.highlight-col{width:32px;min-width:32px;text-align:center;}
  
  /* Drag handle styling */
  .drag-handle {
    display: inline-block;
    cursor: grab;
    font-size: 1.1rem;
    color: var(--muted);
    padding: 4px 6px;
    margin-right: 4px;
    border-radius: 3px;
    user-select: none;
    transition: all 0.2s;
  }
  .drag-handle:hover {
    background: var(--accent-soft);
    color: var(--accent);
  }
  .drag-handle:active {
    cursor: grabbing;
    background: var(--accent);
    color: white;
  }
  
  th.dest,td.dest{min-width:500px; max-width:600px; font-weight:bold; position:relative;} /* V10.10.0 - Agrandi + bold */
  th.trajet,td.trajet{min-width:90px;}
  th.col-no,td.col-no{min-width:70px;}
  th.col-ht,td.col-ht{
    min-width:115px;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); /* V11.0.5 - Gris clair */
  }
  th.col-ttc,td.col-ttc{
    min-width:115px;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); /* V11.0.5 - Bleu clair */
  }
  th.col-evol,td.col-evol{min-width:80px;}
  th.col-note,td.col-note{min-width:200px;}

  /* Inputs prix avec â‚¬ automatique V11.0.2 */
  .price-input, .ttc-input {
    font-weight: 700 !important;
    font-size: 0.98rem !important;
    color: #334155 !important; /* V11.0.5 - Gris foncÃ© */
    padding-right: 28px !important; /* V11.0.6 - Espace pour â‚¬ */
  }
  
  .ttc-input {
    color: #1e3a8a !important; /* V11.0.5 - Bleu foncÃ© */
  }
  
  /* Prix dupliquÃ©s non modifiÃ©s V11.0.6 */
  .price-unchanged {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%) !important;
    font-style: italic !important;
    opacity: 0.75 !important;
    border-left: 2px solid #fbbf24 !important;
  }
  
  /* Effet â‚¬ aprÃ¨s input V11.0.6 - Place rÃ©servÃ©e */
  td.col-ht::after, td.col-ttc::after {
    content: 'â‚¬';
    pointer-events: none;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
    font-weight: 600;
    font-size: 0.92rem;
  }
  
  td.col-ht, td.col-ttc {
    position: relative;
  }

  .dest-name{
    width:100%;
    font-weight:bold; /* V10.10.0 */
    font-size:1.05rem; /* V10.10.0 */
    border:none;
    background:transparent;
    font:inherit;
    padding:0;
    margin:0;
    white-space:nowrap;
    text-overflow:ellipsis;
    overflow:hidden;
    text-align:left !important; /* V11.0.6 - Toujours gauche */
    direction:ltr;
  }
  .dest-name:focus{
    outline:none;
    background-color:rgba(255,255,255,0.9);
    border-radius:4px;
  }
  .trajet-select{
    width:100%;
    border-radius:6px;
    border:1px solid var(--border);
    font:inherit;
    font-size:0.8rem;
    padding:2px 3px;
    background:#f8fbff;
  }
  .price-input,
  .facture-input,
  .ttc-input,
  .note-input{
    width:100%;
    border-radius:6px;
    border:1px solid var(--border);
    font:inherit;
    font-size:0.8rem;
    padding:2px 4px;
    background:#f8fbff;
  }
  .price-input,
  .ttc-input{
    text-align:right;
    font-variant-numeric:tabular-nums;
  }
  .evol-cell{
    text-align:right;
    font-variant-numeric:tabular-nums;
    font-weight:600;
  }
  .evol-pos{
    color:#166534; /* vert foncÃ© */
  }
  .evol-neg{
    color:#b91c1c; /* rouge foncÃ© */
  }
  .right{text-align:right;}

  .delete-cell{
    text-align:center;
    width:40px;
  }

  .highlight-cell{
    text-align:center;
  }
  .highlight-toggle{
    width:14px;
    height:14px;
  }
  .row-highlight td{
    background:rgba(255,245,200,0.8) !important;
  }

  .btn-delete{
    border-radius:50%;
    border:1px solid rgba(179,38,30,0.35);
    background:rgba(245,200,196,0.4);
    width:20px;
    height:20px;
    cursor:pointer;
    font-size:0.7rem;
    line-height:1;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color:#7c1f19;
  }

  .sort-controls,
  .toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    font-size:0.8rem;
    margin-top:4px;
  }
  .sort-controls select{
    padding:2px 6px;
    border-radius:6px;
    border:1px solid var(--border);
    background:#f8fbff;
    font:inherit;
    font-size:0.8rem;
  }
  .search-input{
    min-width:220px;
  }

  .print-note{
    margin-top:6px;
    font-size:0.75rem;
    color:var(--muted);
  }

  @media (max-width:900px){
    
    .header-right{
      align-items:flex-start;
    }
    th.dest,td.dest{min-width:500px; max-width:600px; font-weight:bold; position:relative;}
  }

  
  /* Mode impression client : HT uniquement, pas de nÂ° facture, pas de colonnes TTC/Ã©volution, pas de notes */
  body.client-print .col-no,
  body.client-print .col-ttc,
  body.client-print .col-evol,
  body.client-print .col-note{
    display:none !important;
  }
  body.client-print #paramsCard,
  body.client-print #searchBox,
  body.client-print .toolbar .btn,
  body.client-print #btnSave,
  body.client-print #btnLoad{
    display:none !important;
  }

  @media print{
    body{
      background:#ffffff;
    }
    body::before{
      opacity:0.12 !important;
      -webkit-print-color-adjust:exact;
      print-color-adjust:exact;
    }
    .page{
      max-width:none;
      padding:8mm;
    }
    
    .btn,
    .params-toggle,
    .params-panel,
    .toolbar .btn,
    #searchBox{
      display:none !important;
    }
    .card{
      box-shadow:none;
      border-radius:0;
      border:1px solid #ccc;
    }
  }
  
/* === TABLEAUX DYNAMIQUES V10.4.0 === */
.tables-manager{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin:12px 0;
}
.table-item{
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px;
  border:1px solid rgba(199,212,241,0.5);
  border-radius:4px;
  background:#fff;
  transition:all 0.2s;
}
.table-item:hover{
  border-color:var(--accent);
  background:rgba(199,212,241,0.1);
}
.table-drag-handle{
  cursor:grab;
  font-size:1.2rem;
  color:#999;
  user-select:none;
}
.table-actions{
  display:flex;
  gap:4px;
}
/* === FIN TABLEAUX DYNAMIQUES === */

/* === MASQUAGE COLONNES FACTURE V10.8.2 === */
body.hide-facture-columns .col-no {
  display: none !important;
}
/* === FIN MASQUAGE === */

/* === MODALE RÃ‰ORGANISATION CLIENTS V11.0.16 === */
#reorderModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}
#reorderModal.active {
  display: flex;
}
.reorder-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
.reorder-content h3 {
  margin-top: 0;
  color: var(--accent);
}
.client-item {
  background: white;
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 8px;
  cursor: move;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all 0.2s;
}
.client-item:hover {
  background: var(--accent-soft);
  border-color: var(--accent);
}
.client-item.dragging {
  opacity: 0.5;
  transform: scale(0.95);
}
.client-item.drag-over {
  border-top: 3px solid var(--accent);
}
.client-item .drag-handle {
  font-size: 1.2rem;
  color: var(--muted);
}
.client-item .client-name {
  flex: 1;
  font-weight: 500;
  color: var(--text);
}
.reorder-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  justify-content: flex-end;
}
/* === FIN MODALE RÃ‰ORGANISATION === */

	/* Drag & Drop Cards */
.card-draggable {
  position: relative;
  cursor: move;
}

.card-drag-handle {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 20px;
  color: #999;
  cursor: grab;
  user-select: none;
  padding: 5px;
  line-height: 1;
}

.card-drag-handle:hover {
  color: #333;
  background: rgba(0,0,0,0.05);
  border-radius: 4px;
}

.card-drag-handle:active {
  cursor: grabbing;
}

.card-dragging {
  opacity: 0.5;
  border: 2px dashed #2196f3;
}

.card-fixed {
  /* Cards non dÃ©plaÃ§ables */
  cursor: default;
}

/* ===== SECTION DESTINATIONS IMPORTÃ‰ES - SPRINT 2.6 ===== */
.imported-section {
  background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
  border: 2px solid #ffc107;
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0 30px 0;
  box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.imported-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid rgba(255, 193, 7, 0.3);
}

.imported-header h3 {
  margin: 0;
  color: #856404;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.imported-actions {
  display: flex;
  gap: 8px;
}

.imported-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-height: 400px;
  overflow-y: auto;
}

/* ===== ITEMS IMPORTÃ‰S ===== */
.imported-item {
  background: white;
  border: 2px solid #ffc107;
  border-radius: 8px;
  padding: 14px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  cursor: move;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.imported-item:hover {
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
  border-color: #ff9800;
}

.imported-item.dragging {
  opacity: 0.6;
  transform: rotate(3deg) scale(0.95);
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  cursor: grabbing;
}

.import-content {
  flex: 1;
}

.import-desc {
  font-weight: 600;
  color: #333;
  margin-bottom: 6px;
  font-size: 14px;
}

.import-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  font-size: 13px;
  color: #666;
}

.import-prix {
  font-weight: 700;
  color: #2563eb;
}

.import-qty {
  background: #e0e7ff;
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 600;
}

.import-tva {
  color: #059669;
}

.import-facture {
  color: #7c3aed;
  font-weight: 500;
}

.import-suggestion {
  margin-top: 8px;
  padding: 8px 12px;
  background: #d1fae5;
  border-left: 3px solid #10b981;
  border-radius: 4px;
  font-size: 12px;
  color: #065f46;
}

.import-actions {
  display: flex;
  gap: 6px;
  margin-left: 12px;
}

.btn-icon {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
  opacity: 0.6;
  transition: opacity 0.2s;
}

.btn-icon:hover {
  opacity: 1;
}

/* ===== CELLULES GRILLE DROPPABLES ===== */
.grid-cell.empty {
  background: #f9fafb;
}

.grid-cell.has-value {
  background: white;
}

.grid-cell.drag-over {
  background: #dbeafe !important;
  border: 2px dashed #3b82f6 !important;
  box-shadow: inset 0 0 8px rgba(59, 130, 246, 0.3);
  transform: scale(1.02);
}

.grid-cell.drag-over .dropzone-hint {
  color: #3b82f6;
  font-weight: 600;
}

.cell-dropzone {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 40px;
  color: #d1d5db;
  font-size: 12px;
  transition: all 0.2s;
}

.grid-cell:hover .cell-dropzone {
  color: #6b7280;
  background: #f3f4f6;
}

.dropzone-hint {
  pointer-events: none;
}

/* Notification toast */
.toast-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 24px;
  background: #48bb78;
  color: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 10000;
  animation: slideInRight 0.3s ease-out;
}

.toast-notification.error {
  background: #f56565;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}

@keyframes slideUp {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(-20px);
  }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .imported-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }

  .imported-actions {
    width: 100%;
    flex-direction: column;
  }

  .imported-item {
    flex-direction: column;
    gap: 12px;
  }

  .import-actions {
    margin-left: 0;
    justify-content: flex-end;
  }
}
/* ===== FIN SECTION DESTINATIONS IMPORTÃ‰ES ===== */

	/* ============================================================
   SPRINT 2.6 V2 : TABLEAU DESTINATIONS IMPORTÃ‰ES
   ============================================================ */

/* Carte tableau importÃ© */
.imported-table-card {
  background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
  border: 3px solid #ffc107;
  margin-bottom: 30px;
  animation: slideDown 0.4s ease-out;
}

.imported-table-info {
  background: rgba(255, 152, 0, 0.15);
  border-left: 4px solid #ff9800;
  padding: 12px 16px;
  margin: 10px 0 16px 0;
  border-radius: 6px;
  font-size: 0.85rem;
  color: #e65100;
  font-weight: 500;
}

/* Tableau importÃ© */
.imported-table {
  background: white;
  border: 2px solid #ffc107;
}

.imported-table thead {
  background: linear-gradient(to bottom, #fff9e6, #ffe8a1);
}

.imported-table thead th {
  border-color: #ffb74d;
  color: #f57c00;
}

.imported-table tbody tr {
  background: white;
  transition: all 0.2s ease;
}

.imported-table tbody tr:hover {
  background: #fffbf0;
  transform: translateX(2px);
  box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
}

/* Drag handle cellule */
.drag-handle-cell {
  cursor: grab;
  user-select: none;
  font-size: 1.2rem;
  color: #ff9800;
  font-weight: bold;
}

.drag-handle-cell:active {
  cursor: grabbing;
}

/* Colonne drag handle */
th.drag-col {
  width: 40px;
  min-width: 40px;
  text-align: center;
  background: linear-gradient(to bottom, #ffe8a1, #ffd54f);
}

/* Ligne en cours de drag */
.imported-row.dragging-row {
  opacity: 0.6 !important;
  transform: rotate(1deg) scale(0.98);
  box-shadow: 0 8px 24px rgba(255, 152, 0, 0.4);
  cursor: grabbing;
}

/* Drop zone active sur tableau */
.table-drop-target {
  outline: 3px dashed #4caf50;
  outline-offset: 4px;
  background: rgba(76, 175, 80, 0.05);
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% {
    outline-color: #4caf50;
  }
  50% {
    outline-color: #81c784;
  }
}

/* Highlight drop zone */
table.table-drop-target tbody {
  background: rgba(76, 175, 80, 0.08);
}

/* Actions bas de tableau */
.imported-table-actions {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 2px dashed rgba(255, 193, 7, 0.3);
  text-align: center;
}

.imported-table-actions .btn {
  background: #ef4444;
  color: white;
  border-color: #dc2626;
  padding: 8px 20px;
  font-weight: 600;
}

.imported-table-actions .btn:hover {
  background: #dc2626;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

/* Bouton supprimer ligne */
.btn-delete {
  background: none;
  border: none;
  font-size: 1.3rem;
  cursor: pointer;
  opacity: 0.5;
  transition: all 0.2s;
  padding: 4px;
}

.btn-delete:hover {
  opacity: 1;
  transform: scale(1.2);
}

/* Animation apparition */
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Toast notifications */
.toast-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 24px;
  background: #48bb78;
  color: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 10000;
  animation: slideInRight 0.3s ease-out;
  font-weight: 500;
}

.toast-notification.error {
  background: #f56565;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}


  /* Survol destinations V11.0.26 */
  td.dest{
    position:relative;
    max-width:500px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    cursor:help;
  }
  td.dest:hover{
    overflow:visible;
    white-space:normal;
    z-index:100;
  }
  td.dest:hover::after{
    content:attr(data-full-text);
    position:absolute;
    left:0;
    top:0;
    background:white;
    border:2px solid var(--accent);
    padding:8px 12px;
    border-radius:6px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    white-space:normal;
    max-width:400px;
    z-index:1000;
    font-weight:bold;
  }

  /* === SURVOL DESTINATIONS V11.0.26 === */
  td.dest{
    position:relative;
    cursor:help;
  }
  td.dest:hover{
    z-index:999;
  }
  td.dest > div{
    max-width:100%;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  td.dest:hover > div{
    position:absolute;
    left:0;
    top:0;
    background:white;
    border:2px solid var(--accent);
    padding:8px 12px;
    border-radius:6px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    white-space:normal;
    max-width:400px;
    z-index:1000;
    font-weight:bold;
  }
/* Responsive */
@media (max-width: 768px) {
  .imported-table-info {
    font-size: 0.75rem;
    padding: 8px 12px;
  }
  
  .imported-table {
    font-size: 0.7rem;
  }
  
  .drag-handle-cell {
    font-size: 1rem;
  }
}

	

/* Tooltip destination au survol */
td.dest input:hover::after {
  content: attr(value);
  position: absolute;
  left: 0;
  top: 100%;
  background: rgba(0,0,0,0.9);
  color: white;
  padding: 8px 12px;
  border-radius: 4px;
  white-space: nowrap;
  z-index: 1000;
  font-size: 0.85rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  pointer-events: none;
}

</style>


</head>
<body>
<!-- Indicateur de statut sauvegarde Supabase -->
<div id="save-status-indicator" style="position:fixed;top:20px;right:20px;z-index:9999;display:flex;align-items:center;gap:8px;padding:10px 16px;background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:13px;font-weight:500;">
  <div id="status-dot" style="width:10px;height:10px;border-radius:50%;background:#94a3b8;"></div>
  <span id="status-text">Chargement...</span>
</div>

<div class="page">
  <header>
    <div class="header-bar-v26">
      <!-- GAUCHE: Titre + Sous-titre -->
      <div class="header-left-v26">
        <div class="title-main-v26">AUTOCARS BALLANFAT</div>
        <div id="titleSub" class="title-sub-v26">Grille tarifaire â€“ CFMM â€“ 2025</div>
      </div>

      <!-- CENTRE: Logo agrandi -->
      <div class="header-center-v26">
        <img src="data:image/png;base64,VBORw0KGgoAAAANSUhEUgAABmgAAAI3CAYAAACf7tTpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAIABJREFUeJzs3Xd8HdWd///3mVvUjU3vJUAogQAGQiCE3lNISGIIpJQSSTIlGYJnkSztaillÃ©s (code + message)
 *    - Continue de fonctionner mÃªme si Supabase Ã©choue
 * 
 * 2. âœ… SÃ©lecteur annÃ©es vide (BUG #2, TEST 1.6)
 *    - getStoredYearsForClient() gÃ¨re mieux erreurs 406
 *    - PrivilÃ©gie localStorage si cloud Ã©choue
 *    - Affiche log dÃ©taillÃ© du nombre d'annÃ©es trouvÃ©es
 * 
 * 3. âœ… Sauvegarde auto aprÃ¨s modif TTC (BUG #3, TEST 2.2)
 *    - updateFromTTC() dÃ©clenche saveGrid()
 *    - updateFromHT() dÃ©clenche saveGrid()
 *    - DonnÃ©es HT/TTC persistantes aprÃ¨s rechargement
 * 
 * 4. âœ… Sauvegarde auto aprÃ¨s Drag & Drop (BUG #4, TEST 2.4)
 *    - dragend sur tbody dÃ©clenche triggerAutoSave()
 *    - Ordre lignes sauvegardÃ© automatiquement
 * 
 * 5. âœ… AnnÃ©e supprimÃ©e rafraÃ®chit sÃ©lecteur (BUG #5, TEST 1.4)
 *    - populateYearSelectForClient() rechargÃ© aprÃ¨s suppression
 *    - SÃ©lecteur reconstruit avec annÃ©es restantes
 *    - Plus d'annÃ©es fantÃ´mes
 * 
 * 6. âœ… Calcul Ã©volutions N vs N-1 (BUG #6)
 *    - loadPreviousYearPayload() maintenant async
 *    - Essaie " alt="ğŸšŒ" style="max-height:140px;width:auto;object-fit:contain;">
    </div>
    
    <!-- DROITE : SÃ©lecteurs + Boutons alignÃ©s Ã  droite -->
    <div class="header-right" style="display:flex;flex-direction:column;gap:10px;align-items:flex-end;">
      <!-- Ligne 1 : SÃ©lecteurs -->
      <div style="display:flex;gap:12px;align-items:center;">
        <label style="font-size:0.85rem;display:flex;align-items:center;gap:6px;">
          Client
          <select id="clientSelect" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:0.85rem;background:white;">
            <option value="CFMM">CFMM</option>
            <option value="OVAL">OVAL</option>
            <option value="Ginkgo">Ginkgo Ã‰vÃ©nement</option>
            <option value="LaRuche">Centre La Ruche</option>
          </select>
        </label>
        <label style="font-size:0.85rem;display:flex;align-items:center;gap:6px;">
          AnnÃ©e
          <select id="yearSelect" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:0.85rem;background:white;">
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="__new_year__">+ Nouvelle annÃ©eâ€¦</option>
          </select>
        </label>
      </div>
      
      <!-- Ligne 2 : Boutons alignÃ©s Ã  droite -->
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button id="btnHistory" type="button" class="btn btn-secondary" style="background:#428bca;color:white;border-color:#428bca;padding:8px 14px;font-size:0.85rem;">
          ğŸ“œ Historique
        </button>
        <button id="btnPrintAdvanced" type="button" class="btn" style="padding:8px 14px;font-size:0.85rem;">
          ğŸ–¨ Imprimer
        </button>
        <button id="btnToggleFactures" type="button" class="btn" style="padding:8px 14px;font-size:0.85rem;">
          ğŸ”¢ NÂ° Factures
        </button>
        <button id="btnParamsToggle" type="button" class="btn btn-ghost" style="padding:8px 14px;font-size:0.85rem;">
          âš™ ParamÃ¨tres
        </button>
        <button id="btnSave" type="button" class="btn btn-primary" style="padding:8px 14px;font-size:0.85rem;">ğŸ’¾ Enregistrer</button>
        <a href="gestion-factures-v2.html" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:#1a3c6e;color:white;border-radius:6px;font-weight:500;font-size:0.85rem;">
          ğŸ“„ Import Factures
        </a>
      </div>
    </div>
  </div>
</header>

  <input type="file" id="importFileInput" accept=".json" style="display:none;">

  <!-- Popup Historique Versions V10.9.0 -->
  <div id="versionsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:8px; max-width:800px; max-height:80vh; overflow:auto; padding:30px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">ğŸ• Historique des versions</h2>
        <button id="btnCloseVersions" type="button" style="border:none; background:#f44336; color:white; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:bold;">âœ• Fermer</button>
      </div>
      <p class="muted">Liste des 50 derniÃ¨res sauvegardes. Cliquez pour restaurer une version.</p>
      <div id="versionsList" style="max-height:500px; overflow-y:auto;">
        <!-- Liste gÃ©nÃ©rÃ©e dynamiquement -->
      </div>
    </div>
  </div>

  <!-- Popup Impression AvancÃ©e V11.0 -->
  <div id="printModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:8px; max-width:900px; max-height:85vh; overflow:auto; padding:30px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">ğŸ–¨ï¸ Options d'impression</h2>
        <button id="btnClosePrint" type="button" style="border:none; background:#f44336; color:white; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:bold;">âœ• Fermer</button>
      </div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
        <!-- Colonne gauche : Options -->
        <div>
          <h3 style="margin-top:0; color:#428bca;">ğŸ“‹ Contenu Ã  imprimer</h3>
          
          <div style="margin-bottom:20px;">
            <strong>En-tÃªte</strong>
            <div style="margin-left:20px;">
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printLogo" checked> Logo entreprise
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printTitle" checked> Titre grille
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printClientYear" checked> Client / AnnÃ©e
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printDate" checked> Date impression
              </label>
            </div>
          </div>
          
          <div style="margin-bottom:20px;">
            <strong>Colonnes donnÃ©es</strong>
            <div style="margin-left:20px;">
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printDestination" checked> Destination
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printTrajet" checked> Trajet
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printFacture"> NÂ° Facture
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printNotes"> Notes
              </label>
            </div>
          </div>
          
          <div style="margin-bottom:20px;">
            <strong>CatÃ©gories vÃ©hicules</strong>
            <div style="margin-left:20px;" id="printCategoriesCheckboxes">
              <!-- GÃ©nÃ©rÃ© dynamiquement -->
            </div>
          </div>
          
          <div style="margin-bottom:20px;">
            <strong>Tableaux</strong>
            <div style="margin-left:20px;" id="printTablesCheckboxes">
              <!-- GÃ©nÃ©rÃ© dynamiquement -->
            </div>
          </div>
          
          <div>
            <strong>Autres</strong>
            <div style="margin-left:20px;">
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printMajorations" checked> Majorations
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printEvolutions"> Ã‰volutions prix
              </label>
            </div>
          </div>
        </div>
        
        <!-- Colonne droite : Mise en page -->
        <div>
          <h3 style="margin-top:0; color:#428bca;">ğŸ“„ Mise en page</h3>
          
          <div style="margin-bottom:15px;">
            <label>
              <strong>Format :</strong><br>
              <select id="printFormat" style="width:100%; padding:8px; margin-top:5px;">
                <option value="a4-portrait">A4 Portrait</option>
                <option value="a4-landscape" selected>A4 Paysage</option>
                <option value="a3-landscape">A3 Paysage</option>
              </select>
            </label>
          </div>
          
          <div style="margin-bottom:15px;">
            <label>
              <strong>Taille police :</strong><br>
              <select id="printFontSize" style="width:100%; padding:8px; margin-top:5px;">
                <option value="8">TrÃ¨s petite (8pt)</option>
                <option value="10" selected>Petite (10pt)</option>
                <option value="12">Moyenne (12pt)</option>
                <option value="14">Grande (14pt)</option>
              </select>
            </label>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block; margin:5px 0; cursor:pointer;">
              <input type="checkbox" id="printCompact" checked> Mode compact
            </label>
            <small class="muted">RÃ©duit les marges pour plus de contenu</small>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block; margin:5px 0; cursor:pointer;">
              <input type="checkbox" id="printColors" checked> Couleurs
            </label>
            <small class="muted">DÃ©cocher pour impression noir & blanc</small>
          </div>
          
          <div style="margin-top:30px; padding:20px; background:#f0f8ff; border-radius:6px; border:2px solid #428bca;">
            <div style="text-align:center; margin-bottom:10px;">
              <strong style="color:#428bca;">ğŸ“± AperÃ§u adaptatif</strong>
            </div>
            <p class="muted" style="margin:5px 0; font-size:0.85rem;">
              La mise en page s'adaptera automatiquement au contenu sÃ©lectionnÃ© pour une lisibilitÃ© optimale.
            </p>
          </div>
        </div>
      </div>
      
      <div style="margin-top:30px; padding-top:20px; border-top:2px solid #ddd; text-align:center;">
        <button id="btnGeneratePrint" type="button" class="btn btn-primary" style="font-size:1.1rem; padding:12px 30px;">
          ğŸ–¨ï¸ GÃ©nÃ©rer l'aperÃ§u et imprimer
        </button>
      </div>
    </div>
  </div>

  <div class="card" id="paramsCard">
    <div class="params-toggle" id="paramsToggleArea">
      <span class="btn-icon">âš™</span>
      <span>ParamÃ¨tres avancÃ©s</span>
    </div>
    <div class="params-panel" id="paramsPanel">
      
      <!-- Section 1 : Configuration gÃ©nÃ©rale -->
      <div class="params-section">
        <h3 class="params-section-title">âš™ï¸ Configuration gÃ©nÃ©rale</h3>
        <div class="params-row">
          <label>TVA (%) :
            <input type="number" id="tvaInput" value="10" step="0.1" min="0" max="100">
          </label>
        </div>
        <div class="params-row">
          <label>Tri des destinations :
            <select id="sortDestinations">
              <option value="freqDesc">FrÃ©quence (plus frÃ©quent en haut)</option>
              <option value="alphaAsc">Nom A â†’ Z</option>
              <option value="alphaDesc">Nom Z â†’ A</option>
              <option value="original">Ordre d'origine</option>
            </select>
          </label>
        </div>
      </div>
      
      <!-- Section 2 : Sauvegarde & Export -->
      <div class="params-section">
        <h3 class="params-section-title">ğŸ’¾ Sauvegarde & Export</h3>
        <div class="params-row">
          <button id="btnGoogleDrive" type="button" class="btn btn-primary">
            <span class="btn-icon">â˜ï¸</span><span>Connecter Google Drive</span>
          </button>
          <span class="muted">Sauvegarde automatique sur votre Drive</span>
        </div>
        <div class="params-row">
          <button id="btnVersions" type="button" class="btn">
            <span class="btn-icon">ğŸ•</span><span>Historique des versions</span>
          </button>
          <span class="muted">50 derniÃ¨res sauvegardes</span>
        </div>
        <div class="params-row">
          <button id="btnExportJSON" type="button" class="btn">
            <span class="btn-icon">ğŸ“¥</span><span>Exporter JSON</span>
          </button>
          <button id="btnSaveAsJSON" type="button" class="btn">
            <span class="btn-icon">ğŸ’¾</span><span>Enregistrer sous...</span>
          </button>
          <button id="btnImportJSON" type="button" class="btn">
            <span class="btn-icon">ğŸ“¤</span><span>Importer JSON</span>
          </button>
        </div>
        <div class="params-row">
          <button id="btnExportCSV" type="button" class="btn">
            <span class="btn-icon">ğŸ“Š</span><span>Exporter CSV</span>
          </button>
          <button id="btnExportAll" type="button" class="btn">
            <span class="btn-icon">ğŸ“¦</span><span>Exporter TOUT</span>
          </button>
          <span class="muted">Tous clients/annÃ©es</span>
        </div>
      </div>
      
      
      <!-- Section 3 : CatÃ©gories de vÃ©hicules -->
      <div class="params-section">
        <h3 class="params-section-title">ğŸš— CatÃ©gories de vÃ©hicules</h3>
        <p class="muted" style="margin-bottom:10px;">Personnaliser les noms et capacitÃ©s par client/annÃ©e.</p>
        
        <div style="display:grid; grid-template-columns: auto 1fr 1fr; gap:8px; align-items:center;">
          <strong>Visible</strong>
          <strong>Nom</strong>
          <strong>CapacitÃ©</strong>
        </div>
        
        <div class="params-row" style="margin-top:10px;">
          <button id="btnEditCategories" type="button" class="btn">
            <span class="btn-icon">âœï¸</span><span>Ã‰diter les catÃ©gories</span>
          </button>
        </div>
        
        <div class="params-row" style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
          <label style="cursor: pointer;">
            <input type="checkbox" id="toggleFactureColumns" checked>
            <strong>Afficher colonnes "NÂ° Facture"</strong>
          </label>
        </div>
      </div>
      
      <!-- Section 5 : Gestion clients/annÃ©es -->
      <div class="params-section">
        <h3 class="params-section-title">ğŸ‘¥ Clients & AnnÃ©es</h3>
        <div class="params-row">
          <strong>Clients :</strong>
          <button id="btnRenameClient" type="button" class="btn">
            <span class="btn-icon">âœï¸</span><span>Renommer</span>
          </button>
          <button id="btnDeleteClient" type="button" class="btn btn-ghost">Supprimer</button>
        </div>
        <div class="params-row">
          <strong>AnnÃ©es :</strong>
          <button id="btnDuplicateYear" type="button" class="btn">
            <span class="btn-icon">ğŸ“‹</span><span>Dupliquer</span>
          </button>
          <button id="btnDeleteYear" type="button" class="btn btn-ghost">Supprimer</button>
        </div>
      </div>
      
      <!-- Section 6 : Gestion tableaux -->
      <div class="params-section">
        <h3 class="params-section-title">ğŸ“Š Tableaux personnalisÃ©s</h3>
        <div id="tablesManager" class="tables-manager"></div>
        <div class="params-row">
          <button id="btnCreateTable" type="button" class="btn" onclick="createTable()">
            <span class="btn-icon">â•</span><span>CrÃ©er tableau</span>
          </button>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Modal Ã‰dition CatÃ©gories v11.0.6 -->
<div id="categoriesModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:10001; background:rgba(0,0,0,0.5);">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.3); max-width:700px; width:90%; max-height:80vh; overflow:auto;">
    <div style="padding:25px;">
      <h2 style="margin:0 0 20px 0; color:#1e3a8a; display:flex; align-items:center; gap:10px;">
        <span>âœï¸</span>
        <span id="categoriesModalTitle">Ã‰diter les catÃ©gories</span>
      </h2>
      
      <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
        <thead>
          <tr style="background:#f8fafc; border-bottom:2px solid #e2e8f0;">
            <th style="padding:12px 8px; text-align:center; width:80px;">Visible</th>
            <th style="padding:12px 8px; text-align:left;">Nom catÃ©gorie</th>
            <th style="padding:12px 8px; text-align:left; width:150px;">CapacitÃ©</th>
          </tr>
        </thead>
        <tbody id="categoriesEditTable">
          <!-- GÃ©nÃ©rÃ© dynamiquement -->
        </tbody>
      </table>
      
      <div style="display:flex; gap:10px; justify-content:flex-end; padding-top:15px; border-top:1px solid #ddd;">
        <button type="button" class="btn btn-ghost" onclick="closeCategoriesModal()">Annuler</button>
        <button type="button" class="btn" onclick="saveCategoriesEdits()">
          <span class="btn-icon">ğŸ’¾</span><span>Sauvegarder</span>
        </button>
      </div>
    </div>
  </div>
</div>

  <!-- BUGFIX V11.0.16: Barre de recherche globale (tous tableaux) -->
  <div class="card card-recherche card-fixed" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-left: 4px solid #1976d2;">
    <h3 style="margin-top: 0; color: #1976d2;">ğŸ” Recherche globale</h3>
    <div class="sort-controls">
      <label style="flex: 1;">
        <input type="text" id="searchInput" class="note-input search-input" 
               placeholder="Rechercher dans tous les tableaux (destination, trajet, note...)..."
               style="width: 100%; font-size: 1rem; padding: 12px;">
      </label>
    </div>
    <p class="muted" style="margin: 8px 0 0 0; font-size: 0.85rem;">
      La recherche filtre toutes les lignes de tous les tableaux (Destinations, Transferts et tableaux personnalisÃ©s).
    </p>
  </div>
	
  <!-- Zone majorations V10.8 -->
  <div class="card card-majorations card-fixed" style="background: #fffef0; border-left: 4px solid #ffc107;">
    <h3 style="margin-top: 0; color: #f57c00;">ğŸ“ Majorations et conditions spÃ©cifiques</h3>
    <p class="muted" style="margin-bottom: 10px;">
      Texte libre pour facturation (nuit, jours fÃ©riÃ©s, conditions particuliÃ¨res...). SauvegardÃ© par client/annÃ©e.
    </p>
    <textarea id="conditionsText" 
              style="width: 100%; min-height: 100px; max-height: 400px; padding: 12px; border: 2px solid #ffc107; border-radius: 6px; font-family: inherit; font-size: 0.95rem; resize: vertical; background: white;"
              placeholder="Exemples :
â€¢ Majoration nuit (20h-8h) : +30%
â€¢ Jours fÃ©riÃ©s : +50%
â€¢ Dimanche : +40%
â€¢ PÃ©riodes scolaires : tarif spÃ©cial"></textarea>
  </div>
  
<!-- SPRINT 2.6: Container pour section destinations importÃ©es -->
<div id="importedSectionContainer"></div>

<div class="card card-draggable" data-table-id="destinations">
    <div class="card-drag-handle" draggable="true">â‹®â‹®</div>
    <h2 id="destinationsTitle">ğŸ“ Destinations</h2>
    <p>Destinations personnalisables. Tri par frÃ©quence, alphabet ou ordre initial.</p>
    <div class="sort-controls">
      <label>Tri :
        <select id="sortDestinationsTop">
          <option value="freqDesc">FrÃ©quence (plus frÃ©quent en haut)</option>
          <option value="alphaAsc">Nom A â†’ Z</option>
          <option value="alphaDesc">Nom Z â†’ A</option>
          <option value="original">Par dÃ©faut</option>
        </select>
      </label>
    </div>
    <div class="table-wrapper">
      <table id="destinationsTable" class="pricing-table">
        <thead>
          <tr>
            <th class="highlight-col">âš‘</th>
            <th class="dest">Destination</th>
            <th class="trajet">Trajet</th>

            <th class="group-VL col-no">NÂ° Fact. VL</th>
            <th class="group-VL col-ht">VL HT</th>
            <th class="group-VL col-ttc">VL TTC</th>
            <th class="group-VL col-evol">Ã‰vol. VL (%)</th>

            <th class="group-MC22 col-no">NÂ° Fact. Minicar 22</th>
            <th class="group-MC22 col-ht">Minicar 22 HT</th>
            <th class="group-MC22 col-ttc">Minicar 22 TTC</th>
            <th class="group-MC22 col-evol">Ã‰vol. Min. 22 (%)</th>

            <th class="group-MC33 col-no">NÂ° Fact. Minicar 33</th>
            <th class="group-MC33 col-ht">Minicar 33 HT</th>
            <th class="group-MC33 col-ttc">Minicar 33 TTC</th>
            <th class="group-MC33 col-evol">Ã‰vol. Min. 33 (%)</th>

            <th class="group-AC55 col-no">NÂ° Fact. Autocar 55</th>
            <th class="group-AC55 col-ht">Autocar 55 HT</th>
            <th class="group-AC55 col-ttc">Autocar 55 TTC</th>
            <th class="group-AC55 col-evol">Ã‰vol. A55 (%)</th>

            <th class="group-AC64 col-no">NÂ° Fact. Autocar 64</th>
            <th class="group-AC64 col-ht">Autocar 64 HT</th>
            <th class="group-AC64 col-ttc">Autocar 64 TTC</th>
            <th class="group-AC64 col-evol">Ã‰vol. A64 (%)</th>

            <th class="col-note">Note</th>
            <th>Suppr.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="toolbar">
      <button id="btnAddDestinationTop" type="button" class="btn">+ Ajouter une destination</button>
    </div>

    <p class="print-note">
      Les prix TTC sont calculÃ©s Ã  partir des valeurs HT et de la TVA paramÃ©trÃ©e.  
      Les pourcentages d'Ã©volution comparent avec l'annÃ©e prÃ©cÃ©dente, pour le mÃªme client, en recherchant la mÃªme destination et le mÃªme type de trajet.
    </p>
  </div>

<div class="card card-draggable" data-table-id="transferts">
    <div class="card-drag-handle" draggable="true">â‹®â‹®</div>
    <h2 id="transfertsTitle">ğŸš‰ Transferts (gares / aÃ©roports)</h2>
    <p>Lignes dÃ©diÃ©es aux transferts. Les rÃ¨gles sont identiques aux destinations (HT/TTC, Ã©volution, majoration, notes).</p>
    <div class="table-wrapper">
      <table id="transfertsTable" class="pricing-table">
        <thead>
          <tr>
            <th class="highlight-col">âš‘</th>
            <th class="dest">Transfert</th>
            <th class="trajet">Trajet</th>

            <th class="group-VL col-no">NÂ° Fact. VL</th>
            <th class="group-VL col-ht">VL HT</th>
            <th class="group-VL col-ttc">VL TTC</th>
            <th class="group-VL col-evol">Ã‰vol. VL (%)</th>

            <th class="group-MC22 col-no">NÂ° Fact. Minicar 22</th>
            <th class="group-MC22 col-ht">Minicar 22 HT</th>
            <th class="group-MC22 col-ttc">Minicar 22 TTC</th>
            <th class="group-MC22 col-evol">Ã‰vol. Min. 22 (%)</th>

            <th class="group-MC33 col-no">NÂ° Fact. Minicar 33</th>
            <th class="group-MC33 col-ht">Minicar 33 HT</th>
            <th class="group-MC33 col-ttc">Minicar 33 TTC</th>
            <th class="group-MC33 col-evol">Ã‰vol. Min. 33 (%)</th>

            <th class="group-AC55 col-no">NÂ° Fact. Autocar 55</th>
            <th class="group-AC55 col-ht">Autocar 55 HT</th>
            <th class="group-AC55 col-ttc">Autocar 55 TTC</th>
            <th class="group-AC55 col-evol">Ã‰vol. A55 (%)</th>

            <th class="group-AC64 col-no">NÂ° Fact. Autocar 64</th>
            <th class="group-AC64 col-ht">Autocar 64 HT</th>
            <th class="group-AC64 col-ttc">Autocar 64 TTC</th>
            <th class="group-AC64 col-evol">Ã‰vol. A64 (%)</th>

            <th class="col-note">Note</th>
            <th>Suppr.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="toolbar">
      <button id="btnAddTransfertTop" type="button" class="btn">+ Ajouter un transfert</button>
    </div>

  </div>
</div>

<datalist id="destinationsList"></datalist>

<script>
/*
 * ===============================================================
 * GRILLE TARIFAIRE AUTOCARS BALLANFAT - V11.0.22 FIX
 * ===============================================================
 * Date : 5 Janvier 2026
 * 
 * CORRECTIFS V11.0.22 (6 bugs critiques + TEST 1.1) :
 * 
 * 1. âœ… Erreurs HTTP 406 Supabase (BUG #1)
 *    - Meilleur fallback localStorage si cloud inaccessible
 *    - Logs d'erreur plus dÃ©taillÃ©s (code + message)
 *    - Continue de fonctionner mÃªme si Supabase Ã©choue
 * 
 * 2. âœ… SÃ©lecteur annÃ©es vide (BUG #2, TEST 1.6)
 *    - getStoredYearsForClient() gÃ¨re mieux erreurs 406
 *    - PrivilÃ©gie localStorage si cloud Ã©choue
 *    - Affiche log dÃ©taillÃ© du nombre d'annÃ©es trouvÃ©es
 * 
 * 3. âœ… Sauvegarde auto aprÃ¨s modif TTC (BUG #3, TEST 2.2)
 *    - updateFromTTC() dÃ©clenche saveGrid()
 *    - updateFromHT() dÃ©clenche saveGrid()
 *    - DonnÃ©es HT/TTC persistantes aprÃ¨s rechargement
 * 
 * 4. âœ… Sauvegarde auto aprÃ¨s Drag & Drop (BUG #4, TEST 2.4)
 *    - dragend sur tbody dÃ©clenche triggerAutoSave()
 *    - Ordre lignes sauvegardÃ© automatiquement
 * 
 * 5. âœ… AnnÃ©e supprimÃ©e rafraÃ®chit sÃ©lecteur (BUG #5, TEST 1.4)
 *    - populateYearSelectForClient() rechargÃ© aprÃ¨s suppression
 *    - SÃ©lecteur reconstruit avec annÃ©es restantes
 *    - Plus d'annÃ©es fantÃ´mes
 * 
 * 6. âœ… Calcul Ã©volutions N vs N-1 (BUG #6)
 *    - loadPreviousYearPayload() maintenant async
 *    - Essaie cloud SI localStorage vide
 *    - computeEvolutions() dÃ©clenche correctement
 *    - Wrapper triggerComputeEvolutions() pour event listeners
 * 
 * 7. âœ… Import JSON annÃ©es persistantes (TEST 1.1)
 *    - reader.onload maintenant async
 *    - await deserializeGrid() et populateYearSelectForClient()
 *    - AnnÃ©e importÃ©e apparaÃ®t immÃ©diatement dans sÃ©lecteur
 * 
 * HISTORIQUE:
 * V11.0.21 STABLE - 30 DÃ©c 2025 - Corrections P0/P1/P2
 * V11.0.20 STABLE - 28 DÃ©c 2025 - Corrections critiques
 * V11.0.19 COMPLETE - 24 DÃ©c 2025 - Version rÃ©fÃ©rence
 * ===============================================================
 */

// ================== SUPABASE CONFIGURATION V2 (21 Jan 2026) ==================
// Projet : twyacfsojmsmjabogort
const SUPABASE_URL = 'https://twyacfsojmsmjabogort.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3eWFjZnNvam1zbWphYm9nb3J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyODQ2ODksImV4cCI6MjA4Mzg2MDY4OX0.9e3YBdkPnE7uaNJYf9R-3d3bZICRJMxJHUtGQsV5CO8'; 

let supabaseClient = null;
let isSupabaseAvailable = false;

// Initialiser Supabase
async function initSupabase() {
  try {
    console.log('ğŸ”Œ Initialisation Supabase...');
    
    if (typeof supabase === 'undefined') {
      throw new Error('Supabase SDK non chargÃ©');
    }

    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Test connexion
    const { data, error } = await supabaseClient
      .from('clients')
      .select('count');
    
    if (error) throw error;
    
    isSupabaseAvailable = true;
    updateStatusIndicator('cloud', 'â˜ï¸ Cloud OK');
    console.log('âœ… Supabase initialisÃ©');
    
    // Charger les clients depuis le cloud
    await loadClientsFromCloud();
    
    return true;
  } catch (error) {
    console.error('âŒ Erreur Supabase:', error);
    isSupabaseAvailable = false;
    updateStatusIndicator('local', 'ğŸ“ Mode local');
    
    // Fallback clients par dÃ©faut
    loadDefaultClients();
    
    return false;
  }
}

function updateStatusIndicator(status, text) {
  const dot = document.getElementById('status-dot');
  const textEl = document.getElementById('status-text');
  
  if (dot) {
    const colors = {
      'cloud': '#10b981',
      'local': '#f59e0b',
      'saving': '#f59e0b',
      'error': '#ef4444'
    };
    dot.style.background = colors[status] || '#94a3b8';
  }
  
  if (textEl) {
    textEl.textContent = text;
  }
}

// ============================================================================
// BUGFIX V11.0.20 - Fonction globale normalisation texte (P0 Bug #2)
// ============================================================================
function normalizeText(text) {
  if (!text) return '';
  return text.trim()
    .toLowerCase()
    .replace(/\s+/g, ' ') // Normaliser espaces multiples
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, ''); // Supprimer accents
}

// Charger clients depuis Supabase
async function loadClientsFromCloud() {
  if (!isSupabaseAvailable) {
    console.warn('âš ï¸ Supabase indisponible');
    loadDefaultClients();
    return;
  }
  
  try {
    const { data: clients, error } = await supabaseClient
      .from('clients')
      .select('*')
      .order('name', { ascending: true });
    
    if (error) throw error;
    
   const clientSelect = document.getElementById('clientSelect');
    if (!clientSelect) return;
    
    // BUGFIX V11.0.28: Sauvegarder sÃ©lection actuelle
    const savedClient = clientSelect.value || localStorage.getItem('lastClient') || currentContext.client || "CFMM";
    
    // Vider sÃ©lecteur
    clientSelect.innerHTML = '';
    
    // Ajouter clients
    clients.forEach(client => {
      const option = document.createElement('option');
      option.value = client.name;
      option.textContent = client.name;
      clientSelect.appendChild(option);
    });
    
    // Ajouter "Nouveau client"
    const optNew = document.createElement('option');
    optNew.value = '__new_client__';
    optNew.textContent = '+ Nouveau client...';
    clientSelect.appendChild(optNew);
    
    // BUGFIX V11.0.28: Restaurer sÃ©lection
    if (savedClient && Array.from(clientSelect.options).some(o => o.value === savedClient)) {
      clientSelect.value = savedClient;
      console.log(`âœ… ${clients.length} clients chargÃ©s depuis cloud, "${savedClient}" sÃ©lectionnÃ©`);
    } else {
      // Si client sauvegardÃ© inexistant, sÃ©lectionner le premier
      clientSelect.value = clients[0]?.name || '';
      console.log(`âœ… ${clients.length} clients chargÃ©s depuis cloud, "${clientSelect.value}" sÃ©lectionnÃ© par dÃ©faut`);
    }
    
  } catch (error) {
    console.error('âŒ Erreur chargement clients:', error);
    loadDefaultClients();
  }
}
// ============================================================================
// BUGFIX V11.0.28: Fonction utilitaire conversion nom client â†’ UUID
// ============================================================================
/**
 * Convertit un nom de client en UUID Supabase
 * @param {string} clientName - Nom du client ou UUID dÃ©jÃ 
 * @returns {Promise<string|null>} UUID du client ou null si non trouvÃ©
 */
async function getClientUuid(clientName) {
  if (!clientName) return null;
  
  // Si dÃ©jÃ  un UUID (contient des tirets), retourner tel quel
  if (clientName.includes('-')) {
    return clientName;
  }
  
  // Sinon, chercher dans Supabase
  if (!isSupabaseAvailable) {
    console.warn('âš ï¸ Supabase non disponible pour conversion UUID');
    return null;
  }
  
  try {
    const { data: clientData, error } = await supabaseClient
      .from('clients')
      .select('id')
      .eq('name', clientName)
      .single();
    
    if (error || !clientData) {
      console.warn(`âš ï¸ Client "${clientName}" non trouvÃ© dans cloud`);
      return null;
    }
    
    console.log(`âœ… UUID client "${clientName}": ${clientData.id}`);
    return clientData.id;
  } catch (e) {
    console.error('âŒ Erreur conversion UUID:', e);
    return null;
  }
}
function loadDefaultClients() {
  const defaultClients = ['CFMM', 'OVAL', 'Ginkgo Ã‰vÃ©nement', 'Centre La Ruche'];
  const clientSelect = document.getElementById('clientSelect');
  if (!clientSelect) return;
  
  clientSelect.innerHTML = '';
  
  defaultClients.forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    clientSelect.appendChild(option);
  });
  
  const optNew = document.createElement('option');
  optNew.value = '__new_client__';
  optNew.textContent = '+ Nouveau client...';
  clientSelect.appendChild(optNew);
  
  console.log('âœ… Clients par dÃ©faut chargÃ©s');
}

// Charger grille depuis cloud
async function loadGridFromCloud(clientId, year) {
  try {
    // âœ… NOUVEAU : Convertir nom en UUID si nÃ©cessaire
    let actualClientId = clientId;
    
    // Si clientId n'est pas un UUID (pas de tirets), c'est un nom â†’ convertir
    if (clientId && !clientId.includes('-')) {
      console.log(`ğŸ”„ Conversion nom "${clientId}" â†’ UUID...`);
      const { data: clientData, error: clientError } = await supabaseClient
        .from('clients')
        .select('id')
        .eq('name', clientId)
        .single();
      
      if (clientError || !clientData) {
        console.warn(`âš ï¸ Client "${clientId}" non trouvÃ© dans cloud`);
        return null;
      }
      
      actualClientId = clientData.id;
      console.log(`âœ… UUID trouvÃ©: ${actualClientId}`);
    }
    
    console.log(`â˜ï¸ Chargement grille cloud: ${actualClientId} / ${year}`);
    
    const { data, error } = await supabaseClient
      .from('grilles')
      .select('*')
      .eq('client_id', actualClientId)
      .eq('year', year);
    
    // âœ… CORRECTION : Ignorer erreur 406 (Not Acceptable)
    if (error) {
      // Si erreur 406 â†’ Traiter comme "pas de donnÃ©es"
      if (error.message && (error.message.includes('406') || error.code === '406')) {
        console.log(`âš ï¸ HTTP 406 ignorÃ© pour annÃ©e ${year} (traitÃ© comme vide)`);
        return null;
      }
      // Autres erreurs â†’ lever exception
      throw error;
    }
    
    if (!data || data.length === 0) {
      console.log(`â„¹ï¸ Aucune grille cloud pour ${year}`);
      return null;
    }
    
    console.log('â˜ï¸ Grille chargÃ©e depuis cloud');
	return data[0].data;  // â† Retourner le champ 'data' uniquement
    
  } catch (error) {
    console.error('âŒ Erreur chargement cloud:', error);
    // âœ… Ne pas bloquer l'application sur erreur
    return null;
  }
}
	
// Sauvegarder grille vers cloud avec versioning
// Garantir que le client existe dans Supabase (crÃ©er si nÃ©cessaire)
async function ensureClientExists(clientName) {
  if (!isSupabaseAvailable) {
    console.warn('âš ï¸ Supabase indisponible');
    return null;
  }
  
  try {
    // VÃ©rifier si le client existe dÃ©jÃ 
    const { data: existingClient } = await supabaseClient
      .from('clients')
      .select('id')
      .eq('name', clientName)
      .single();
    
    if (existingClient) {
      console.log('âœ… Client trouvÃ© dans cloud:', clientName);
      return existingClient.id;
    }
    
    // Client n'existe pas, le crÃ©er
    console.log('ğŸ“ CrÃ©ation du client dans cloud:', clientName);
    const { data: newClient, error } = await supabaseClient
      .from('clients')
      .insert({ name: clientName })
      .select('id')
      .single();
    
    if (error) {
      console.error('âŒ Erreur crÃ©ation client:', error);
      return null;
    }
    
    console.log('âœ… Client crÃ©Ã© dans cloud:', clientName, '| ID:', newClient.id);
    return newClient.id;
    
  } catch (error) {
    console.error('âŒ Erreur ensureClientExists:', error);
    return null;
  }
}

async function saveGridToCloud(client, year, data) {
  if (!isSupabaseAvailable) {
    console.warn('âš ï¸ Supabase indisponible, sauvegarde locale uniquement');
    return false;
  }
  
  try {
    // BUGFIX V11.0.17: Garantir que le client existe (crÃ©er si nÃ©cessaire)
    const clientId = await ensureClientExists(client);
    
    if (!clientId) {
      console.error('âŒ Impossible de crÃ©er/trouver le client dans cloud');
      return false;
    }
    
    // VÃ©rifier si grille existe
    const { data: existingGrille } = await supabaseClient
      .from('grilles')
      .select('id')
      .eq('client_id', clientId)
      .eq('year', year)
      .single();
    
    let grilleId;
    
    if (!existingGrille) {
// CrÃ©er nouvelle grille
const { data: newGrille, error: insertError } = await supabaseClient
  .from('grilles')
  .insert({
    client_id: clientId,
    year: year,
    data: data,
    tva: data.tva || 10
  })
  .select('id')
  .single();

if (insertError) {
  // Si HTTP 409 (conflit/doublon), charger la grille existante
  if (insertError.code === '23505' || insertError.message?.includes('duplicate')) {
    console.log('âš ï¸ Grille existe dÃ©jÃ  (conflit ignorÃ©), chargement...');
    const { data: existingData } = await supabaseClient
      .from('grilles')
      .select('id')
      .eq('client_id', clientId)
      .eq('year', year)
      .single();
    
    if (existingData) {
      grilleId = existingData.id;
    } else {
      throw new Error('Impossible de crÃ©er ou charger la grille');
    }
  } else {
    throw insertError;
  }
} else {
  grilleId = newGrille.id;
  console.log('âœ… Nouvelle grille crÃ©Ã©e dans cloud');
}

    } else {
      // Mettre Ã  jour grille existante
      grilleId = existingGrille.id;
      
      await supabaseClient
        .from('grilles')
        .update({
          data: data,
          updated_at: new Date()
        })
        .eq('id', grilleId);
      
      console.log('âœ… Grille mise Ã  jour dans cloud');
    }
    
    // CrÃ©er version dans historique
    await createVersion(grilleId, clientId, year, data);
    
    return true;
    
  } catch (error) {
    console.error('âŒ Erreur sauvegarde cloud:', error);
    return false;
  }
}

// CrÃ©er une version dans l'historique
async function createVersion(grilleId, clientId, year, data) {
  try {
    // Compter versions existantes
    const { count } = await supabaseClient
      .from('grilles_versions')
      .select('*', { count: 'exact', head: true })
      .eq('grille_id', grilleId);
    
    const nextVersion = (count || 0) + 1;
    
  // InsÃ©rer nouvelle version
const { data: insertedVersion, error: insertError } = await supabaseClient
  .from('grilles_versions')
 .insert({
  grille_id: grilleId,
  version_number: nextVersion,
  data: data
})

  .select();

if (insertError) {
  console.error('âŒ Erreur INSERT version:', insertError);
  console.error('   Code:', insertError.code);
  console.error('   Message:', insertError.message);
  console.error('   Details:', insertError.details);
  console.error('   Hint:', insertError.hint);
  throw insertError;
}

console.log(`âœ… Version ${nextVersion} crÃ©Ã©e`, insertedVersion);

    
    // Nettoyer anciennes versions (garder 50 max)
    await cleanOldVersions(grilleId, 50);
    
    // Mettre Ã  jour compteur
    updateVersionCount(count + 1);
    
  } catch (error) {
    console.error('âŒ Erreur crÃ©ation version:', error);
  }
}

// Nettoyer anciennes versions
async function cleanOldVersions(grilleId, keepCount = 50) {
  try {
    const { data: versions } = await supabaseClient
      .from('grilles_versions')
      .select('id, version_number')
      .eq('grille_id', grilleId)
      .order('version_number', { ascending: false });
    
    if (versions && versions.length > keepCount) {
      const toDelete = versions.slice(keepCount);
      const idsToDelete = toDelete.map(v => v.id);
      
      await supabaseClient
        .from('grilles_versions')
        .delete()
        .in('id', idsToDelete);
      
      console.log(`ğŸ—‘ï¸ ${toDelete.length} anciennes versions supprimÃ©es`);
    }
  } catch (error) {
    console.error('âŒ Erreur nettoyage versions:', error);
  }
}

function updateVersionCount(count) {
  const badge = document.getElementById('versionCount');
  if (badge) {
    badge.textContent = Math.min(count, 50);
  }
}

// Charger compteur versions pour grille actuelle
async function updateVersionCountForCurrentGrid() {
  const badge = document.getElementById('versionCount');
  if (!badge) return;
  
  if (!isSupabaseAvailable) {
    badge.textContent = '0';
    return;
  }
  
  const client = getCurrentClient();
  const year = getCurrentYear();
  
  if (!client || !year || year === '__new_year__') {
    badge.textContent = '0';
    return;
  }
  
  try {
    // Trouver client_id
    const { data: clientData } = await supabaseClient
      .from('clients')
      .select('id')
      .eq('name', client)
      .single();
    
    if (!clientData) {
      badge.textContent = '0';
      return;
    }
    
    // Trouver grille_id
    const { data: grilleData } = await supabaseClient
      .from('grilles')
      .select('id')
      .eq('client_id', clientData.id)
      .eq('year', parseInt(year))
      .single();
    
    if (!grilleData) {
      badge.textContent = '0';
      return;
    }
    
    // Compter versions
    const { count } = await supabaseClient
      .from('grilles_versions')
      .select('*', { count: 'exact', head: true })
      .eq('grille_id', grilleData.id);
    
    badge.textContent = count || '0';
    
  } catch (error) {
    console.error('Erreur comptage versions:', error);
    badge.textContent = '0';
  }
}

// Initialiser au chargement
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSupabase);
} else {
  initSupabase();
}

// ================== FIN SUPABASE CONFIGURATION ==================


const NB_DEST_INIT = 1;
const NB_TRANS_INIT = 1;
const VEHICULES = ["VL","MC22","MC33","AC55","AC64"];

// CatÃ©gories par dÃ©faut V10.10.0
const DEFAULT_CATEGORIES = {
  VL: { name: "VÃ©hicule lÃ©ger", capacity: "â‰¤ 9 places", visible: true },
  MC22: { name: "Minicar 22 pax", capacity: "22 places", visible: true },
  MC33: { name: "Minicar 33 pax", capacity: "23 Ã  33 places", visible: true },
  AC55: { name: "Autocar 55 pax", capacity: "33 Ã  55 places", visible: true },
  AC64: { name: "Autocar 64 pax", capacity: "55 Ã  64 places", visible: true }
};

// CatÃ©gories courantes (peut Ãªtre personnalisÃ©es par client/annÃ©e)
let currentCategories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));

// === TABLEAUX DYNAMIQUES V10.4.0 ===
let tables = [
  { id: "destinations", name: "Destinations", icon: "ğŸ“", order: 0 },
  { id: "transferts", name: "Transferts (gares/aÃ©roports)", icon: "ğŸš‰", order: 1 }
];
let tableCounters = { destinations: 0, transferts: 0 };
// === FIN TABLEAUX DYNAMIQUES ===

// lecture seule possible via ?mode=readonly dans l'URL
const urlParams = new URLSearchParams(window.location.search);
const READ_ONLY = (urlParams.get("mode") === "readonly");

let destCounter = 0;
let transCounter = 0;
let destOriginalOrder = [];
let lastSaved = null;
let currentContext = { client: null, year: null };
let currentGridData = null; // SPRINT 2.6: Stocker grille actuelle en mÃ©moire

// Variables auto-save (BUGFIX v11.0.23)
let autoSaveTimeout = null;
const AUTO_SAVE_DELAY = 3000; // 3 secondes
const MAX_VERSIONS = 50; // Historique max

const STORAGE_PREFIX = "ballanfat_grille_v10_2_2::";

function setStatus(msg, isError){
  const el = document.getElementById("status");
  el.textContent = msg || "";
  el.classList.toggle("error", !!isError);
}
function updateLastSavedLabel(){
  const el = document.getElementById("lastSaved");
  if(!lastSaved){
    el.textContent = "";
    return;
  }
  const d = lastSaved;
  const pad = n => n.toString().padStart(2,"0");
  el.textContent = "Dernier enregistrement : " +
    pad(d.getDate()) + "/" + pad(d.getMonth()+1) + "/" + d.getFullYear() +
    " Ã  " + pad(d.getHours()) + "h" + pad(d.getMinutes()) + "min";
}

function parseNumberFR(val){
  if(val == null) return NaN;
  const s = String(val).trim().replace(/\s+/g,"").replace(",", ".");
  if(s === "") return NaN;
  const n = Number(s);
  return isNaN(n) ? NaN : n;
}
function formatNumberFR(val, decimals){
  if(!isFinite(val)) return "";
  const d = (typeof decimals === "number") ? decimals : 2;
  const fixed = Number(val).toFixed(d);
  const parts = fixed.split(".");
  let intPart = parts[0];
  const decPart = parts[1] || "00";
  intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  return intPart + "," + decPart;
}
function getTVA(){
  const input = document.getElementById("tvaInput");
  const n = parseNumberFR(input.value);
  if(isNaN(n) || n < 0) return 0;
  return n / 100;
}

function applyReadOnlyMode(){
  if(!READ_ONLY) return;
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if(el.id === "yearSelect" || el.id === "clientSelect") return;
    el.disabled = true;
  });
  const toDisable = [
    "#btnAddDestinationTop","#btnAddTransfertTop",
    "#btnSave","#btnDeleteClient"
  ];
  toDisable.forEach(sel => {
    const b = document.querySelector(sel);
    if(b){ b.disabled = true; }
  });
  document.querySelectorAll(".btn-delete").forEach(b => { b.style.display = "none"; });
  setStatus("Mode lecture seule â€“ aucune modification possible sur ce fichier.", false);
}

function createDeleteCell(){
  const td = document.createElement("td");
  td.className = "delete-cell";
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "btn-delete";
  btn.title = "Supprimer cette ligne";
  btn.textContent = "Ã—";
  td.appendChild(btn);
  return td;
}

function applyTooltip(el){
  if(!el) return;
  el.title = el.value || "";
}

function createRow(type){
  const isDest = type === "dest";
  const tableId = isDest ? "destinationsTable" : "transfertsTable";
  const tbody = document.querySelector("#" + tableId + " tbody");
  const index = (isDest ? ++destCounter : ++transCounter);
  
  // CORRECTION BUG DRAG & DROP : Utiliser timestamp unique au lieu d'index
  const uniqueId = Date.now() + "_" + Math.random().toString(36).substr(2, 9);
  const trajId = type + "_" + uniqueId;
  
  const tr = document.createElement("tr");
  tr.dataset.trajet = trajId;
  tr.dataset.index = String(index);
  tr.dataset.freq = "0";

  const tdMark = document.createElement("td");
  tdMark.className = "highlight-col";
  
  // Ajouter le handle de drag (â‹®â‹®) pour TOUS les tableaux
  const handle = document.createElement("span");
  handle.className = "drag-handle";
  handle.innerHTML = "â‹®â‹®";
  handle.title = "Glisser pour rÃ©organiser";
  handle.setAttribute("draggable", "true");
  tdMark.appendChild(handle);
  
  // Ajouter la checkbox de surlignage
  const mark = document.createElement("input");
  mark.type = "checkbox";
  mark.className = "highlight-toggle";
  mark.addEventListener("change", function(){
    tr.classList.toggle("row-highlight", mark.checked);
  });
  tdMark.appendChild(mark);
  tr.appendChild(tdMark);

  const tdDest = document.createElement("td");
  tdDest.className = "dest";
  const inputName = document.createElement("input");
  inputName.type = "text";
  inputName.className = "dest-name";
  inputName.value = (isDest ? "Destination " : "Transfert ") + index;
  inputName.setAttribute("list","destinationsList");
  applyTooltip(inputName);
  tdDest.appendChild(inputName);
  tr.appendChild(tdDest);

  const tdTrajet = document.createElement("td");
  tdTrajet.className = "trajet";
  const sel = document.createElement("select");
  sel.className = "trajet-select";
  [["aller_retour","Aller et retour"],["aller","Aller"],["retour","Retour"]].forEach(([val,lab])=>{
    const opt=document.createElement("option");
    opt.value=val;
    opt.textContent=lab;
    sel.appendChild(opt);
  });
  tdTrajet.appendChild(sel);
  tr.appendChild(tdTrajet);

  VEHICULES.forEach(cat => {
    const groupClass = "group-" + cat;

    let tdF = document.createElement("td");
    tdF.className = groupClass + " col-no";
    const inF = document.createElement("input");
    inF.type = "text";
    inF.className = "facture-input";
    applyTooltip(inF);
    tdF.appendChild(inF);
    tr.appendChild(tdF);

    tdF = document.createElement("td");
    tdF.className = groupClass + " col-ht";
    const inHT = document.createElement("input");
    inHT.type = "text";
    inHT.className = "price-input";
    inHT.dataset.key = trajId + "|" + cat + "|HT";
    applyTooltip(inHT);
    tdF.appendChild(inHT);
    tr.appendChild(tdF);

    tdF = document.createElement("td");
    tdF.className = groupClass + " col-ttc";
    const inTTC = document.createElement("input");
    inTTC.type = "text";
    inTTC.className = "ttc-input";
    inTTC.dataset.key = trajId + "|" + cat + "|TTC";
    applyTooltip(inTTC);
    tdF.appendChild(inTTC);
    tr.appendChild(tdF);

    const tdE = document.createElement("td");
    tdE.className = groupClass + " col-evol evol-cell right";
    tdE.dataset.evolCat = cat;
    tr.appendChild(tdE);
  });

  const tdNote = document.createElement("td");
  tdNote.className = "col-note";
  const inNote = document.createElement("input");
  inNote.type = "text";
  inNote.className = "note-input";
  inNote.maxLength = 200;
  applyTooltip(inNote);
  tdNote.appendChild(inNote);
  tr.appendChild(tdNote);

  tr.appendChild(createDeleteCell());

  tbody.appendChild(tr);
  return tr;
}

function renumberRows(){
  const destRows = document.querySelectorAll("#destinationsTable tbody tr");
  destCounter = destRows.length;
  destRows.forEach((tr, idx) => tr.dataset.index = String(idx+1));
  destOriginalOrder = Array.from(destRows);

  const transRows = document.querySelectorAll("#transfertsTable tbody tr");
  transCounter = transRows.length;
  transRows.forEach((tr, idx) => tr.dataset.index = String(idx+1));
}

function generateInitialRows(){
  const destTbody = document.querySelector("#destinationsTable tbody");
  const transTbody = document.querySelector("#transfertsTable tbody");
  destTbody.innerHTML = "";
  transTbody.innerHTML = "";
  destCounter = 0;
  transCounter = 0;
  for(let i=0;i<NB_DEST_INIT;i++) createRow("dest");
  for(let i=0;i<NB_TRANS_INIT;i++) createRow("transfert");
  renumberRows();
}

function applyRowVisibility(){
  document.querySelectorAll("#destinationsTable tbody tr, #transfertsTable tbody tr").forEach(tr => {
    tr.style.display = "";
  });
}

function applyColumnVisibility(){
  document.querySelectorAll(".toggle-cat").forEach(cb => {
    const cat = cb.dataset.cat;
    if(!cat) return;
    const visible = cb.checked;
    document.querySelectorAll(".group-" + cat).forEach(cell => {
      cell.style.display = visible ? "" : "none";
    });
  });
}

function toggleCategoriesPanel(){
  const content = document.getElementById("categoriesContent");
  const btn = document.getElementById("btnToggleCategories");
  if(!content || !btn) return;
  const collapsed = content.classList.toggle("collapsed");
  btn.textContent = collapsed ? "Afficher les catÃ©gories" : "RÃ©duire les catÃ©gories";
  btn.setAttribute("aria-expanded", collapsed ? "false" : "true");
}

function applyDestinationSort(mode){
  const tbody = document.querySelector("#destinationsTable tbody");
  let rows = Array.from(tbody.querySelectorAll("tr"));
  if(mode === "original"){
    rows = Array.from(destOriginalOrder);
  }else if(mode === "alphaAsc" || mode === "alphaDesc"){
    rows.sort((a,b) => {
      const sa = (a.querySelector(".dest-name")?.value || "").trim().toLowerCase();
      const sb = (b.querySelector(".dest-name")?.value || "").trim().toLowerCase();
      if(sa < sb) return mode === "alphaAsc" ? -1 : 1;
      if(sa > sb) return mode === "alphaAsc" ? 1 : -1;
      return 0;
    });
  }else if(mode === "freqDesc"){
    rows.sort((a,b) => {
      const fa = parseNumberFR(a.dataset.freq || "0") || 0;
      const fb = parseNumberFR(b.dataset.freq || "0") || 0;
      return fb - fa;
    });
  }
  rows.forEach(r => tbody.appendChild(r));
}

function updateFromHT(inputHT){
  const tva = getTVA();
  const ht = parseNumberFR(inputHT.value);
  const key = inputHT.dataset.key;
  if(!key) return;
  const ttcInput = document.querySelector('.ttc-input[data-key="' + key.replace("|HT","|TTC") + '"]');
  if(isNaN(ht)){
    if(ttcInput) ttcInput.value = "";
    return;
  }
  const ttc = ht * (1 + tva);
  if(ttcInput) ttcInput.value = formatNumberFR(ttc,2);
}

function updateFromTTC(inputTTC){
  const tva = getTVA();
  const ttc = parseNumberFR(inputTTC.value);
  const key = inputTTC.dataset.key;
  if(!key) return;
  const htInput = document.querySelector('.price-input[data-key="' + key.replace("|TTC","|HT") + '"]');
  if(isNaN(ttc)){
    if(htInput) htInput.value = "";
    return;
  }
  const denom = (1 + tva) || 1;
  const ht = ttc / denom;
  if(htInput) htInput.value = formatNumberFR(ht,2);
  
  // BUGFIX v11.0.22: DÃ©clencher sauvegarde auto aprÃ¨s modification TTC
  triggerAutoSave();
}

function syncAllTTCFromHT(){
  document.querySelectorAll(".price-input").forEach(inp => updateFromHT(inp));
}

// ========== AUTO-SAVE FUNCTIONS (BUGFIX v11.0.23: Moved to global scope) ==========
function showSaveIndicator(text, isError = false){
  const indicator = document.getElementById('saveIndicator');
  if(!indicator) return;
  
  indicator.style.display = 'block';
  indicator.style.background = isError ? '#d9534f' : '#5cb85c';
  indicator.textContent = text;
  
  setTimeout(() => {
    indicator.style.display = 'none';
  }, 2000);
}

function updateLastSavedIndicator(text){
  const elem = document.getElementById('lastSaved');
  if(!elem) return;
  elem.textContent = text;
  elem.style.color = '#999';
  elem.style.fontSize = '0.85rem';
}

function triggerAutoSave(){
  if(autoSaveTimeout) clearTimeout(autoSaveTimeout);
  
  autoSaveTimeout = setTimeout(() => {
    autoSaveGrid();
  }, AUTO_SAVE_DELAY);
}

function autoSaveGrid(){
  try {
    const client = getCurrentClient();
    const year = getCurrentYear();
    
    if(!client || !year || year === "__new_year__") return;
    
    // Sauvegarder version actuelle
    saveGrid();
    
    // Ajouter Ã  l'historique AUTO (sÃ©parÃ©)
    const historyKey = `history_auto_${client}_${year}`;
    let history = [];
    
    try {
      const raw = localStorage.getItem(historyKey);
      if(raw) history = JSON.parse(raw);
    } catch(e){}
    
    const data = serializeGrid();
    const now = new Date();
    const version = {
      timestamp: now.toISOString(),
      type: 'auto',
      data: data
    };
    
    history.unshift(version); // Ajouter au dÃ©but
    
    // Limiter Ã  MAX_VERSIONS
    if(history.length > MAX_VERSIONS){
      history = history.slice(0, MAX_VERSIONS);
    }
    
    localStorage.setItem(historyKey, JSON.stringify(history));
    
    // Afficher timestamp
    const timeStr = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    showSaveIndicator('âœ… SauvegardÃ©');
    updateLastSavedIndicator(`Dernier enregistrement : ${timeStr}`);
    
  } catch(e){
    console.error('Erreur auto-save:', e);
    showSaveIndicator('âŒ Erreur sauvegarde', true);
  }
}
// ========== FIN AUTO-SAVE FUNCTIONS ==========

function applySearchFilter(){
  const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();
  const matchRow = (tr) => {
    if(!q) return true;
    const name = (tr.querySelector(".dest-name")?.value || "").toLowerCase();
    const note = (tr.querySelector(".note-input")?.value || "").toLowerCase();
    const trajetSel = tr.querySelector(".trajet-select");
    const trajetText = trajetSel ? trajetSel.options[trajetSel.selectedIndex].text.toLowerCase() : "";
    return name.includes(q) || note.includes(q) || trajetText.includes(q);
  };
  
  // BUGFIX V11.0.16: Recherche dans TOUS les tableaux (destinations, transferts, personnalisÃ©s)
  tables.forEach(table => {
    const tableId = "#" + table.id + "Table";
    document.querySelectorAll(tableId + " tbody tr").forEach(tr => {
      tr.style.display = matchRow(tr) ? "" : "none";
    });
  });
}

// ============================================================================
// BUGFIX V11.0.20 P0 #1: Charger annÃ©es depuis cloud ET localStorage
// ============================================================================
async function getStoredYearsForClient(client){
  const years = new Set();
  const nowYear = new Date().getFullYear();
  
  // BUGFIX v11.0.23: Prioriser cloud sur localStorage
  let cloudSuccess = false;
  
  // 1. PRIORITÃ‰ : Supabase Cloud
  if (isSupabaseAvailable) {
    try {
      const { data: clientData, error: clientError } = await supabaseClient
        .from('clients')
        .select('id')
        .eq('name', client)
        .single();
      
      if (clientError) {
        console.warn(`âš ï¸ Client cloud inaccessible (${clientError.code || clientError.message})`);
      } else if (clientData) {
        const { data: grilles, error: grillesError } = await supabaseClient
          .from('grilles')
          .select('year')
          .eq('client_id', clientData.id);
        
       if (grillesError) {
  // Ignorer HTTP 406 silencieusement
  if (grillesError.message && (grillesError.message.includes('406') || grillesError.code === '406')) {
    console.log('âš ï¸ HTTP 406 ignorÃ© (aucune annÃ©e cloud)');
  } else {
    console.warn(`âš ï¸ AnnÃ©es cloud inaccessibles (${grillesError.code || grillesError.message})`);
  }
        } else if (grilles && grilles.length > 0) {
          grilles.forEach(g => {
            if (g.year && g.year > 1900 && g.year < 3001) {
              years.add(g.year);
            }
          });
          cloudSuccess = true;
          console.log(`âœ… ${years.size} annÃ©e(s) cloud pour ${client}:`, Array.from(years).sort((a,b)=>a-b));
        }
      }
    } catch (err) {
      console.warn('âš ï¸ Erreur chargement annÃ©es cloud:', err.message);
    }
  }
  
  // 2. FALLBACK : localStorage (UNIQUEMENT si cloud a Ã©chouÃ©)
if (!cloudSuccess) {
  console.log(`â„¹ï¸ Chargement annÃ©es depuis localStorage pour ${client}...`);
  const prefix = STORAGE_PREFIX + client + "::";
  for(let i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    if(!key || !key.startsWith(prefix)) continue;
    const yStr = key.substring(prefix.length);
    const yNum = parseInt(yStr,10);
    if(yNum && yNum>1900 && yNum<3001) years.add(yNum);
  }
  
  // Si toujours rien aprÃ¨s localStorage, ajouter annÃ©e courante
  if (years.size === 0) {
    console.log(`â„¹ï¸ Aucune annÃ©e trouvÃ©e pour ${client}, ajout annÃ©e courante ${nowYear}`);
    years.add(nowYear);
 	 }
  }
  console.log(`âœ… Total ${years.size} annÃ©e(s) pour ${client}:`, Array.from(years).sort((a,b)=>a-b));
return Array.from(years).sort((a,b)=>a-b);
}

// BUGFIX V11.0.20: async car getStoredYearsForClient est async
async function populateYearSelectForClient(client, preferYear){
  const sel = document.getElementById("yearSelect");
  if(!sel) return;
  const currentYear = new Date().getFullYear();
  const years = await getStoredYearsForClient(client || "CFMM"); // await ajoutÃ©
  sel.innerHTML = "";
  years.forEach(y => {
    const opt = document.createElement("option");
    opt.value = String(y);
    opt.textContent = String(y);
    sel.appendChild(opt);
  });
  const optNew = document.createElement("option");
  optNew.value = "__new_year__";
  optNew.textContent = "+ Nouvelle annÃ©eâ€¦";
  sel.appendChild(optNew);
  let target = preferYear || currentYear;
  if(!years.includes(target)) target = years[years.length-1];
  sel.value = String(target);
}

function getCurrentYear(){
  const sel = document.getElementById("yearSelect");
  return sel ? sel.value : "";
}
function getCurrentClient(){
  const sel = document.getElementById("clientSelect");
  if(!sel) return "";
  const val = sel.value;
  if(val === "__new_client__") return "";
  return val;
}
function getCurrentClientLabel(){
  const sel = document.getElementById("clientSelect");
  if(!sel) return "";
  const opt = sel.options[sel.selectedIndex];
  if(!opt) return "";
  if(opt.value === "__new_client__") return "";
  return opt.text;
}
function updateTitleSubtitle(){
  const sub = document.getElementById("titleSub");
  const clientLabel = getCurrentClientLabel() || "Client";
  const year = getCurrentYear() || "----";
  sub.textContent = "Grille tarifaire â€“ " + clientLabel + " â€“ " + year;
}

function getContextKey(client, year){
  return STORAGE_PREFIX + client + "::" + year;
}

function resetGridToInitial(){
  // RÃ©initialiser les tableaux dynamiques
  tables = [
    { id: "destinations", name: "Destinations", icon: "ğŸ“", order: 0 },
    { id: "transferts", name: "Transferts (gares/aÃ©roports)", icon: "ğŸš‰", order: 1 }
  ];
  tableCounters = { destinations: 0, transferts: 0 };
  
  // Supprimer les tableaux personnalisÃ©s du DOM
  document.querySelectorAll('.card').forEach(card => {
    const tableElem = card.querySelector('table.pricing-table');
    if(tableElem){
      const tableId = tableElem.id.replace('Table', '');
      if(tableId !== 'destinations' && tableId !== 'transferts'){
        card.remove();
      }
    }
  });
  
  // RÃ©afficher destinations/transferts si masquÃ©s
  ['destinations', 'transferts'].forEach(id => {
    const tableEl = document.getElementById(id + 'Table');
    if(tableEl){
      const card = tableEl.closest('.card');
      if(card) card.style.display = '';
    }
  });
  
  generateInitialRows();
  applyRowVisibility();
  applyColumnVisibility();
  destOriginalOrder = Array.from(document.querySelectorAll("#destinationsTable tbody tr"));
  syncAllTTCFromHT();
  refreshDestinationSuggestions();
  
  // BUGFIX v11.0.24: Retirer await (fonction non-async)
  computeEvolutions(); // ExÃ©cution asynchrone en parallÃ¨le
  markUnchangedPrices();
  
  renderTablesManager();
  
  // Vider majorations V10.8
  const conditionsTextarea = document.getElementById("conditionsText");
  if(conditionsTextarea){
    conditionsTextarea.value = "";
  }
}

function loadGridForCurrentContext(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  if(!client || !year || year === "__new_year__"){
    resetGridToInitial();
    return;
  }
  const key = getContextKey(client, year);
  const raw = localStorage.getItem(key);
  if(!raw){
    resetGridToInitial();
    setStatus("Nouvelle grille pour " + client + " â€“ " + year + " (aucune sauvegarde trouvÃ©e).", false);
    return;
  }
  try{
    const data = JSON.parse(raw);
    deserializeGrid(data);
    setStatus("Grille chargÃ©e pour " + client + " â€“ " + year + ".", false);
  }catch(e){
    console.error(e);
    resetGridToInitial();
    setStatus("Erreur lors du chargement, grille rÃ©initialisÃ©e pour " + client + " â€“ " + year + ".", true);
  }
}

function serializeGrid(){
  // Format v10.4.3 avec tableaux dynamiques
  const tablesData = {};
  
  tables.forEach(table => {
    const tbody = document.querySelector(`#${table.id}Table tbody`);
    if(!tbody) return;
    
    const rows = [];
    tbody.querySelectorAll("tr").forEach(tr => {
      const dest = tr.querySelector(".dest-name")?.value || "";
      const trajet = tr.querySelector(".trajet-select")?.value || "";
      const note = tr.querySelector(".note-input")?.value || "";
      const factures = {};
      const tarifs = {};
      VEHICULES.forEach(cat => {
        const f = tr.querySelector(".group-" + cat + " .facture-input");
        const h = tr.querySelector(".group-" + cat + " .price-input");
        factures[cat] = f ? f.value : "";
        const v = h ? parseNumberFR(h.value) : NaN;
        tarifs[cat] = isNaN(v) ? null : v;
      });
      rows.push({ dest, trajet, note, factures, tarifs });
    });
    
    tablesData[table.id] = {
      name: table.name,
      icon: table.icon,
      order: table.order,
      rows: rows
    };
  });

  return {
    version: "10.10.0",
    tva: parseNumberFR(document.getElementById("tvaInput")?.value || "10") || 10,
    savedAt: new Date().toISOString(),
    tables: tablesData,
    tablesOrder: tables.map(t => t.id),
    conditionsText: document.getElementById("conditionsText")?.value || "",
    categories: currentCategories // V10.10.0
  };
}

async function deserializeGrid(payload){
  if(!payload) return;
  
  // ========== COMPATIBILITÃ‰ ASCENDANTE v10.3.x â†’ v10.4.3 ==========
  if(Array.isArray(payload.rows) && !payload.tables){
    // Ancien format dÃ©tectÃ©, convertir en nouveau format
    console.log("Migration format v10.3.x â†’ v10.4.3");
    const destRows = payload.rows.filter(r => r.type === "destination");
    const transRows = payload.rows.filter(r => r.type === "transfert" || r.type === "transfer");
    
    payload.tables = {
      destinations: {
        name: "Destinations",
        icon: "ğŸ“",
        order: 0,
        rows: destRows.map(r => ({dest: r.dest, trajet: r.trajet, note: r.note, factures: r.factures, tarifs: r.tarifs}))
      },
      transferts: {
        name: "Transferts (gares/aÃ©roports)",
        icon: "ğŸš‰",
        order: 1,
        rows: transRows.map(r => ({dest: r.dest, trajet: r.trajet, note: r.note, factures: r.factures, tarifs: r.tarifs}))
      }
    };
    payload.tablesOrder = ["destinations", "transferts"];
  }
  
  // ========== CHARGEMENT FORMAT v10.4.3 ==========
  if(payload.tables){
    // RÃ©initialiser les tableaux
    tables = [];
    tableCounters = {};
    
    // Reconstruire la liste des tableaux
    const order = payload.tablesOrder || Object.keys(payload.tables);
    order.forEach((tableId, index) => {
      const tableData = payload.tables[tableId];
      if(tableData){
        tables.push({
          id: tableId,
          name: tableData.name || tableId,
          icon: tableData.icon || "ğŸ“‹",
          order: tableData.order != null ? tableData.order : index
        });
        tableCounters[tableId] = 0;
      }
    });
    
    // Supprimer les tableaux personnalisÃ©s existants (pas destinations/transferts)
    document.querySelectorAll('.card').forEach(card => {
      const tableElem = card.querySelector('table.pricing-table');
      if(tableElem){
        const tableId = tableElem.id.replace('Table', '');
        if(tableId !== 'destinations' && tableId !== 'transferts'){
          card.remove();
        }
      }
    });
    
 // CrÃ©er les tableaux personnalisÃ©s
const customTables = tables.filter(t => t.id !== 'destinations' && t.id !== 'transferts');
customTables.forEach(table => {
  const card = createTableHTML(table);
  if(card){
    // BUGFIX V11.0.25 P0-2: InsÃ©rer AVANT la section majorations
    const majorationsCard = document.querySelector('.card-majorations');
    if(majorationsCard){
      majorationsCard.parentNode.insertBefore(card, majorationsCard);
    } else {
      // Fallback: insÃ©rer Ã  la fin si section majorations introuvable
      const lastCard = document.querySelector('.card:last-of-type');
      if(lastCard){
        lastCard.parentNode.insertBefore(card, lastCard.nextSibling);
      } else {
        document.querySelector('.page').appendChild(card);
      }
    }
  }
});

    
   // Charger les donnÃ©es dans chaque tableau
tables.forEach(table => {
  const tableData = payload.tables[table.id];
  
  if(tableData && Array.isArray(tableData.rows)){
    const tbody = document.querySelector(`#${table.id}Table tbody`);
    if(tbody){
      
      tbody.innerHTML = "";
      tableCounters[table.id] = 0;
      
      tableData.rows.forEach((r, rowIndex) => {
        
        // Pour destinations et transferts, utiliser createRow
        if(table.id === 'destinations' || table.id === 'transferts'){
          const tr = createRow(table.id === 'transferts' ? 'transfert' : 'dest');
          
          const inputName = tr.querySelector(".dest-name");
          const trajetSel = tr.querySelector(".trajet-select");
          const noteEl = tr.querySelector(".note-input");
          if(inputName) { inputName.value = r.dest || ""; applyTooltip(inputName); }
          if(trajetSel && r.trajet) trajetSel.value = r.trajet;
          if(noteEl) { noteEl.value = r.note || ""; applyTooltip(noteEl); }
          
          VEHICULES.forEach(cat => {
            const factVal = r.factures && r.factures[cat] != null ? r.factures[cat] : "";
            const tarifVal = r.tarifs && typeof r.tarifs[cat] === "number" ? r.tarifs[cat] : null;
            const f = tr.querySelector(".group-" + cat + " .facture-input");
            const h = tr.querySelector(".group-" + cat + " .price-input");
            if(f) { f.value = factVal; applyTooltip(f); }
            if(h) { h.value = tarifVal != null ? formatNumberFR(tarifVal,2) : ""; applyTooltip(h); }
          });
          
        } else {
          // Pour les tableaux personnalisÃ©s, utiliser addRowToCustomTable
          addRowToCustomTable(table.id);
          const rows = tbody.querySelectorAll('tr');
          const tr = rows[rows.length - 1];
          
          const inputName = tr.querySelector(".dest-name");
          const trajetSel = tr.querySelector(".trajet-select");
          const noteEl = tr.querySelector(".note-input");
          if(inputName) { inputName.value = r.dest || ""; applyTooltip(inputName); }
          if(trajetSel && r.trajet) trajetSel.value = r.trajet;
          if(noteEl) { noteEl.value = r.note || ""; applyTooltip(noteEl); }
          
          VEHICULES.forEach(cat => {
            const factVal = r.factures && r.factures[cat] != null ? r.factures[cat] : "";
            const tarifVal = r.tarifs && typeof r.tarifs[cat] === "number" ? r.tarifs[cat] : null;
            const f = tr.querySelector(".group-" + cat + " .facture-input");
            const h = tr.querySelector(".group-" + cat + " .price-input");
            if(f) { f.value = factVal; applyTooltip(f); }
            if(h) { h.value = tarifVal != null ? formatNumberFR(tarifVal,2) : ""; applyTooltip(h); }
          });
        }
      });
      
    } else {
    }
  }
});

  // Restaurer TVA
  if(payload.tva != null){
    const tvaInput = document.getElementById("tvaInput");
    if(tvaInput) tvaInput.value = String(payload.tva).replace(".",",");
  }
  
  // Restaurer timestamp
  if(payload.savedAt){
    lastSaved = new Date(payload.savedAt);
    updateLastSavedLabel();
  }
  
  // Charger majorations V10.8
  const conditionsTextarea = document.getElementById("conditionsText");
  if(conditionsTextarea){
    conditionsTextarea.value = payload.conditionsText || "";
  }
  
  // Charger catÃ©gories V10.10.0
  if(payload.categories){
    currentCategories = payload.categories;
  } else {
    currentCategories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
  }
  renderVehicleCategoriesEditor();
  updateTableHeaders();
  
  // Mettre Ã  jour l'interface
  renderTablesManager();
  applyColumnVisibility();
  syncAllTTCFromHT();
  refreshDestinationSuggestions();
  checkDuplicateDestinations(); // BUGFIX V11.0.21 P0 #3

	  syncAllTTCFromHT();
  refreshDestinationSuggestions();
  checkDuplicateDestinations(); // BUGFIX V11.0.21 P0 #3
  
  // BUGFIX V11.0.28: Restaurer les noms personnalisÃ©s des tableaux
  tables.forEach(table => {
    const titleEl = document.getElementById(table.id + 'Title');
    if(titleEl){
      titleEl.textContent = `${table.icon} ${table.name}`;
    }
  });
	  
 await computeEvolutions(); markUnchangedPrices();

  // BUGFIX V11.0.27: RÃ©organiser les cards selon tablesOrder sauvegardÃ©
  if (payload.tablesOrder && payload.tablesOrder.length > 0) {
    const majorationsCard = document.querySelector('.card-majorations');
    if (majorationsCard) {
      // RÃ©organiser dans l'ordre inverse pour que le premier soit juste aprÃ¨s majorations
      const order = [...payload.tablesOrder].reverse();
      order.forEach(tableId => {
        const card = document.querySelector(`.card[data-table-id="${tableId}"]`);
        if (card) {
          // InsÃ©rer juste aprÃ¨s majorations
          majorationsCard.parentNode.insertBefore(card, majorationsCard.nextSibling);
        }
      });
      console.log('âœ… Ordre tableaux restaurÃ©:', payload.tablesOrder);
    }
  }

enableDragAndDrop();

  }  // â† Ferme le if(payload.tables)
}    // â† Ferme la fonction deserializeGrid

async function saveGrid(){
  if(READ_ONLY){
    setStatus("Mode lecture seule : enregistrement dÃ©sactivÃ©.", true);
    return;
  }
  const client = getCurrentClient();
  const year = getCurrentYear();
  if(!client || !year || year === "__new_year__"){
    setStatus("SÃ©lectionner d'abord un client et une annÃ©e valide.", true);
    return;
  }
  const data = serializeGrid();
  const key = getContextKey(client, year);
  
  // 1. TOUJOURS localStorage (backup)
  try{
    localStorage.setItem(key, JSON.stringify(data));
    lastSaved = new Date(data.savedAt);
    updateLastSavedLabel();
    console.log('ğŸ’¾ Sauvegarde locale OK');
  }catch(e){
    console.error('âŒ Erreur locale:', e);
    setStatus("Erreur lors de l'enregistrement local.", true);
    updateStatusIndicator('error', 'Erreur locale');
    return;
  }
  
  // 2. TENTER Supabase cloud avec versioning
  if (isSupabaseAvailable) {
    try {
      updateStatusIndicator('saving', 'ğŸ’¾ Sauvegarde cloud...');
      await saveGridToCloud(client, parseInt(year), data);
      setStatus("âœ… SauvegardÃ© (local + cloud) " + client + " â€“ " + year, false);
      updateStatusIndicator('cloud', 'â˜ï¸ Cloud OK');
    } catch(e) {
      console.warn('âš ï¸ Cloud Ã©chouÃ©, local OK:', e);
      setStatus("âš ï¸ SauvegardÃ© localement " + client + " â€“ " + year, false);
      updateStatusIndicator('local', 'ğŸ“ Local uniquement');
    }
  } else {
    setStatus("ğŸ’¾ SauvegardÃ© localement " + client + " â€“ " + year, false);
    updateStatusIndicator('local', 'ğŸ“ Local uniquement');
  }
}
	
/**
 * ============================================================
 * SPRINT 2.6 V2 FINAL : TABLEAU DESTINATIONS IMPORTÃ‰ES
 * - Parser intelligent (dÃ©tection destination + vÃ©hicules)
 * - Tableau identique architecture existante
 * - Drag & drop lignes vers tableaux principaux
 * ============================================================
 */

// ========================================
// PARSER INTELLIGENT
// ========================================

/**
 * Parser principal - Analyse un service complet
 */
function parseService(service, factureNum) {
  const desc = service.desc || service.description || '';
  const prixHT = parsePrice(service.pu || service.prix_ht);
  const qty = parseInt(service.qty || service.quantite || 1);
  const tva = parseTVA(service.tva);
  
  return {
    destination: extractDestination(desc),
    trajet: extractTrajet(desc),
    vehicules: detectVehicules(desc, prixHT),
    prix_ht: prixHT,
    prix_unitaire: qty > 1 ? prixHT / qty : prixHT,
    quantite: qty,
    tva: tva,
    facture: factureNum,
    description_complete: desc,
    date_service: extractDate(desc)
  };
}

/**
 * Extraire destination depuis description
 */
function extractDestination(desc) {
  const patterns = [
    /(?:AR|A\/R|aller\s+retour|Aller\s+retour)\s+(?:Ã |au|aux)?\s*([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹]+(?:\s+[A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹]+)*)/i,
    /(?:vers|pour|direction|destination)\s+([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹\s\-]+)/i,
    /Gare\s+(?:d'|de\s+)?([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹\s]+)/i,
    /AÃ©roport\s+(?:d'|de\s+)?([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹\s]+)/i,
    />\s*([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹\s\-]+?)(?:\s+\d+\s*pl|\s*$)/i,
    /:\s+(?:Ã |au)\s+([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹\s\-]+)/i
  ];
  
  for (const pattern of patterns) {
    const match = desc.match(pattern);
    if (match && match[1]) {
      let dest = match[1].trim();
      dest = dest.replace(/\s+journÃ©e.*$/i, '');
      dest = dest.replace(/\s+\d+\s*pl\.?.*$/i, '');
      return normalizeDestination(dest);
    }
  }
  
  // Fallback : mots capitalisÃ©s
  const words = desc.split(/\s+/);
  const caps = [];
  for (const word of words) {
    if (/^[A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹]+$/.test(word) && 
        word.length > 2 && 
        !['AR', 'Service', 'Aller'].includes(word)) {
      caps.push(word);
      if (caps.length >= 2) break;
    }
  }
  
  return caps.length > 0 ? caps.join(' ') : 'Destination non identifiÃ©e';
}

/**
 * Normaliser nom de destination
 */
function normalizeDestination(dest) {
  const mapping = {
    'Annecy Albigny': 'Annecy Albigny',
    'Albigny': 'Annecy Albigny',
    'Gd Bornand': 'Le Grand Bornand',
    'Grand Bornand': 'Le Grand Bornand',
    'St Jean de Sixt': 'Saint Jean de Sixt',
    'St Jean': 'Saint Jean de Sixt',
    'Gare Annecy': 'Gare d\'Annecy',
    'Thones': 'ThÃ´nes',
    'Aravis': 'Col des Aravis',
    'Merdassier': 'Merdassier',
    'Prises': 'Les Prises'
  };
  
  return mapping[dest] || dest;
}

/**
 * Extraire type de trajet
 */
function extractTrajet(desc) {
  if (/\bAR\b|A\/R|aller\s+retour|aller\s+et\s+retour/i.test(desc)) {
    return 'Aller et retour';
  }
  if (/\baller\b|\bdÃ©part\b/i.test(desc)) {
    return 'Aller';
  }
  if (/\bretour\b/i.test(desc)) {
    return 'Retour';
  }
  return 'Aller et retour';
}

/**
 * DÃ©tecter vÃ©hicules - RÃˆGLES EXACTES
 * "car" â†’ Autocar 55
 * "car 60", "60 pl" â†’ Autocar 64
 * "minicar" â†’ Minicar 22
 * "minicar 33" â†’ Minicar 33
 */
function detectVehicules(desc, prixHT) {
  const vehicules = [];
  const descLower = desc.toLowerCase();
  
  // DÃ©tection places
  const placesMatch = desc.match(/(\d+)\s*pl(?:\.|aces)?/i);
  const nbPlaces = placesMatch ? parseInt(placesMatch[1]) : null;
  
  // Mots-clÃ©s
  const hasAutocar = /\bcar\b|\bautocar\b/i.test(desc);
  const hasMinicar = /minicar|minibus/i.test(desc);
  const hasVL = /\bVL\b|vÃ©hicule\s+lÃ©ger/i.test(desc);
  
  // QuantitÃ©s ("1 car + 1 minicar")
  const carMatch = desc.match(/(\d+)\s+(?:auto)?car(?!\s*minicar)/i);
  const minicarMatch = desc.match(/(\d+)\s+minicar/i);
  const vlMatch = desc.match(/(\d+)\s+VL/i);
  
  // AUTOCAR
  if (hasAutocar || (nbPlaces && nbPlaces >= 45)) {
    if (nbPlaces && nbPlaces >= 60) {
      vehicules.push({ type: 'Autocar 64', count: carMatch ? parseInt(carMatch[1]) : 1 });
    } else if (nbPlaces && nbPlaces >= 55) {
      vehicules.push({ type: 'Autocar 55', count: carMatch ? parseInt(carMatch[1]) : 1 });
    } else {
      vehicules.push({ type: 'Autocar 55', count: carMatch ? parseInt(carMatch[1]) : 1 });
    }
  }
  
  // MINICAR
  if (hasMinicar || (nbPlaces && nbPlaces >= 22 && nbPlaces < 45)) {
    if (nbPlaces && nbPlaces >= 30) {
      vehicules.push({ type: 'Minicar 33', count: minicarMatch ? parseInt(minicarMatch[1]) : 1 });
    } else {
      vehicules.push({ type: 'Minicar 22', count: minicarMatch ? parseInt(minicarMatch[1]) : 1 });
    }
  }
  
  // VL
  if (hasVL || (nbPlaces && nbPlaces < 9)) {
    vehicules.push({ type: 'VL', count: vlMatch ? parseInt(vlMatch[1]) : 1 });
  }
  
  // FALLBACK PAR PRIX
  if (vehicules.length === 0) {
    if (prixHT > 600) vehicules.push({ type: 'Autocar 64', count: 1 });
    else if (prixHT > 350) vehicules.push({ type: 'Autocar 55', count: 1 });
    else if (prixHT > 200) vehicules.push({ type: 'Minicar 33', count: 1 });
    else if (prixHT > 100) vehicules.push({ type: 'Minicar 22', count: 1 });
    else vehicules.push({ type: 'VL', count: 1 });
  }
  
  return vehicules;
}

/**
 * Extraire date du service
 */
function extractDate(desc) {
  const match = desc.match(/(\d{2})\/(\d{2})\/(\d{4})/);
  return match ? `${match[3]}-${match[2]}-${match[1]}` : null;
}

/**
 * Parser prix (format "880,00 â‚¬" â†’ 880.00)
 */
function parsePrice(prix) {
  if (typeof prix === 'number') return prix;
  if (!prix) return 0;
  
  const cleaned = String(prix)
    .replace(/\s/g, '')
    .replace('â‚¬', '')
    .replace(',', '.');
  
  return parseFloat(cleaned) || 0;
}

/**
 * Parser TVA (format "10%" â†’ 10)
 */
function parseTVA(tva) {
  if (typeof tva === 'number') return tva;
  if (!tva) return 10;
  
  const match = String(tva).match(/(\d+)/);
  return match ? parseInt(match[1]) : 10;
}

// ========================================
// GÃ‰NÃ‰RATION TABLEAU
// ========================================

/**
 * GÃ©nÃ©rer HTML du tableau Destinations ImportÃ©es
 */
function renderImportedTable(gridData) {
  if (!gridData.destinations_importees || gridData.destinations_importees.length === 0) {
    return '';
  }
  
  const imported = gridData.destinations_importees;
  
  // Parser chaque item
  const rows = [];
  
  imported.forEach((item, index) => {
    const factureNum = item.facture || item.facture_num || 'FACT-XXXX';
    
    // Parser le service
    const parsed = parseService({
      desc: item.description || item.desc,
      pu: item.prix_ht,
      qty: item.quantite || 1,
      tva: item.tva || 10
    }, factureNum);
    
    // CrÃ©er row
    const totalVehicules = parsed.vehicules.reduce((sum, v) => sum + v.count, 0);
    const prixParVehicule = totalVehicules > 0 ? parsed.prix_ht / totalVehicules : parsed.prix_ht;
    
    const row = {
      id: item.id || `import-${Date.now()}-${index}`,
      destination: parsed.destination,
      trajet: parsed.trajet,
      date_service: parsed.date_service,
      description: parsed.description_complete,
      facture: factureNum,
      tva: parsed.tva,
      vehicules: {}
    };
    
    // Remplir prix par vÃ©hicule
    parsed.vehicules.forEach(veh => {
      const prix = veh.count > 1 ? prixParVehicule * veh.count : prixParVehicule;
      row.vehicules[veh.type] = {
        prix_ht: prix,
        facture: factureNum,
        count: veh.count
      };
    });
    
    rows.push(row);
  });
  
  // GÃ©nÃ©rer HTML
  let html = `
<div class="card card-draggable imported-table-card" data-table-id="imported">
  <div class="card-drag-handle" draggable="true">â‹®â‹®</div>
  <h2>ğŸ“¥ Destinations ImportÃ©es (${rows.length})</h2>
  <p class="imported-table-info">
    âš ï¸ Glissez-dÃ©posez les lignes ci-dessous vers les tableaux "Destinations" ou "Transferts" pour les intÃ©grer.
  </p>
  
  <div class="table-wrapper">
    <table class="pricing-table imported-table">
      <thead>
        <tr>
          <th class="drag-col">â‹®â‹®</th>
          <th class="dest">Destination</th>
          <th class="trajet">Trajet</th>
          
          <th class="col-no">NÂ° Fact. VL</th>
          <th class="col-ht">VL HT</th>
          <th class="col-ttc">VL TTC</th>
          
          <th class="col-no">NÂ° Fact. M22</th>
          <th class="col-ht">Minicar 22 HT</th>
          <th class="col-ttc">M22 TTC</th>
          
          <th class="col-no">NÂ° Fact. M33</th>
          <th class="col-ht">Minicar 33 HT</th>
          <th class="col-ttc">M33 TTC</th>
          
          <th class="col-no">NÂ° Fact. A55</th>
          <th class="col-ht">Autocar 55 HT</th>
          <th class="col-ttc">A55 TTC</th>
          
          <th class="col-no">NÂ° Fact. A64</th>
          <th class="col-ht">Autocar 64 HT</th>
          <th class="col-ttc">A64 TTC</th>
          
          <th class="col-note">Description</th>
          <th>Suppr.</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  rows.forEach(row => {
    html += renderImportedRow(row);
  });
  
  html += `
      </tbody>
    </table>
  </div>
  
  <div class="imported-table-actions">
    <button class="btn" onclick="clearAllImportedRows()">
      ğŸ—‘ï¸ Supprimer toutes les lignes importÃ©es
    </button>
  </div>
</div>
  `;
  
  return html;
}

/**
 * GÃ©nÃ©rer HTML d'une ligne importÃ©e
 */
function renderImportedRow(row) {
  const vehiculeCategories = ['VL', 'Minicar 22', 'Minicar 33', 'Autocar 55', 'Autocar 64'];
  const ttcMultiplier = 1 + (row.tva / 100);
  
  let html = `
<tr class="imported-row" 
    draggable="true" 
    data-import-id="${row.id}"
    data-destination="${escapeHtml(row.destination)}"
    data-trajet="${escapeHtml(row.trajet)}"
    ondragstart="handleRowDragStart(event)"
    ondragend="handleRowDragEnd(event)">
  
  <td class="drag-handle-cell">â‹®â‹®</td>
  <td class="dest">${escapeHtml(row.destination)}</td>
  <td class="trajet">${escapeHtml(row.trajet)}</td>
  `;
  
  vehiculeCategories.forEach(veh => {
    const vehData = row.vehicules[veh];
    
    if (vehData && vehData.prix_ht) {
      const ttc = vehData.prix_ht * ttcMultiplier;
      html += `
      <td class="col-no" data-vehicule="${veh}">${escapeHtml(vehData.facture)}</td>
      <td class="col-ht" data-vehicule="${veh}" data-prix-ht="${vehData.prix_ht}">${vehData.prix_ht.toFixed(2)} â‚¬</td>
      <td class="col-ttc" data-vehicule="${veh}">${ttc.toFixed(2)} â‚¬</td>
      `;
    } else {
      html += `
      <td class="col-no"></td>
      <td class="col-ht"></td>
      <td class="col-ttc"></td>
      `;
    }
  });
  
  html += `
  <td class="col-note" style="font-size: 0.75rem; color: #666;">${escapeHtml(row.description.substring(0, 50))}...</td>
  <td style="text-align: center;">
    <button class="btn-delete" onclick="deleteImportedRow('${row.id}')" title="Supprimer">ğŸ—‘ï¸</button>
  </td>
</tr>
  `;
  
  return html;
}

/**
 * Escape HTML
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// ========================================
// DRAG & DROP LIGNES
// ========================================

let currentDraggedRow = null;
let currentRowData = null;

/**
 * DÃ©but drag ligne
 */
function handleRowDragStart(event) {
  const row = event.currentTarget;
  currentDraggedRow = row;
  
  currentRowData = {
    id: row.dataset.importId,
    destination: row.dataset.destination,
    trajet: row.dataset.trajet,
    vehicules: []
  };
  
  // Extraire prix par vÃ©hicule
  const prixCells = row.querySelectorAll('[data-prix-ht]');
  prixCells.forEach(cell => {
    const veh = cell.dataset.vehicule;
    const prix = parseFloat(cell.dataset.prixHt);
    const factureCell = cell.previousElementSibling;
    const facture = factureCell ? factureCell.textContent.trim() : '';
    
    if (veh && !isNaN(prix)) {
      currentRowData.vehicules.push({
        type: veh,
        prix_ht: prix,
        facture: facture
      });
    }
  });
  
  console.log('ğŸ¯ Drag ligne:', currentRowData);
  
  row.classList.add('dragging-row');
  row.style.opacity = '0.5';
  
  event.dataTransfer.effectAllowed = 'move';
  event.dataTransfer.setData('text/plain', currentRowData.id);
}

/**
 * Fin drag
 */
function handleRowDragEnd(event) {
  event.currentTarget.classList.remove('dragging-row');
  event.currentTarget.style.opacity = '1';
  
  document.querySelectorAll('.table-drop-target').forEach(t => {
    t.classList.remove('table-drop-target');
  });
}

/**
 * Initialiser drop zones sur tableaux existants
 */
function initializeTableDropZones() {
  const tables = document.querySelectorAll('#destinationsTable, #transfertsTable');
  
  tables.forEach(table => {
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    
    tbody.addEventListener('dragover', handleTableDragOver);
    tbody.addEventListener('dragleave', handleTableDragLeave);
    tbody.addEventListener('drop', handleTableDrop);
  });
  
  console.log('âœ… Drop zones initialisÃ©es');
}

/**
 * Drag over tableau
 */
function handleTableDragOver(event) {
  if (!currentRowData) return;
  
  event.preventDefault();
  event.stopPropagation();
  event.dataTransfer.dropEffect = 'move';
  
  const tbody = event.currentTarget;
  const table = tbody.closest('table');
  table.classList.add('table-drop-target');
}

/**
 * Drag leave tableau
 */
function handleTableDragLeave(event) {
  const tbody = event.currentTarget;
  const table = tbody.closest('table');
  
  if (!event.currentTarget.contains(event.relatedTarget)) {
    table.classList.remove('table-drop-target');
  }
}

/**
 * Drop ligne dans tableau
 */
async function handleTableDrop(event) {
  event.preventDefault();
  event.stopPropagation();
  
  const tbody = event.currentTarget;
  const table = tbody.closest('table');
  table.classList.remove('table-drop-target');
  
  if (!currentRowData) {
    console.error('âŒ Pas de donnÃ©es');
    showToast('error', 'Erreur : Pas de donnÃ©es Ã  placer');
    return;
  }
  
  const tableId = table.id;
  const tableType = tableId === 'destinationsTable' ? 'destinations' : 'transferts';
  
  console.log(`ğŸ“ Drop dans: ${tableType}`);
  
  const confirmMsg = `IntÃ©grer cette ligne dans "${tableType}" ?\n\n` +
    `Destination: ${currentRowData.destination}\n` +
    `Trajet: ${currentRowData.trajet}\n` +
    `VÃ©hicules: ${currentRowData.vehicules.map(v => v.type).join(', ')}\n\n` +
    `Confirmer ?`;
  
  if (!confirm(confirmMsg)) {
    currentDraggedRow = null;
    currentRowData = null;
    return;
  }
  
  try {
    // Supprimer ligne du tableau importÃ©
    if (currentDraggedRow) {
      currentDraggedRow.remove();
    }
    
    // VÃ©rifier si tableau importÃ© vide
    const importedTable = document.querySelector('.imported-table tbody');
    if (importedTable && importedTable.children.length === 0) {
      document.querySelector('.imported-table-card').remove();
      showToast('success', 'âœ… Toutes les destinations importÃ©es ont Ã©tÃ© intÃ©grÃ©es !');
    } else {
      showToast('success', `âœ… Ligne intÃ©grÃ©e dans ${tableType}`);
    }
    
    // Note: L'intÃ©gration rÃ©elle dans la grille sera faite manuellement
    // Ce code place juste visuellement - vous ajusterez les cellules vous-mÃªme
    
  } catch (err) {
    console.error('âŒ Erreur:', err);
    showToast('error', 'Erreur : ' + err.message);
  }
  
  currentDraggedRow = null;
  currentRowData = null;
}

/**
 * Supprimer une ligne importÃ©e
 */
function deleteImportedRow(rowId) {
  if (!confirm('Supprimer cette ligne importÃ©e ?')) {
    return;
  }
  
  const row = document.querySelector(`[data-import-id="${rowId}"]`);
  if (row) {
    row.remove();
    
    const tbody = document.querySelector('.imported-table tbody');
    if (tbody && tbody.children.length === 0) {
      document.querySelector('.imported-table-card').remove();
      showToast('success', 'âœ… Toutes les lignes supprimÃ©es');
    } else {
      showToast('success', 'âœ… Ligne supprimÃ©e');
    }
  }
}

/**
 * Supprimer toutes les lignes importÃ©es
 */
function clearAllImportedRows() {
  if (!confirm('Supprimer TOUTES les lignes importÃ©es ?')) {
    return;
  }
  
  document.querySelector('.imported-table-card').remove();
  showToast('success', 'âœ… Toutes les lignes supprimÃ©es');
}

/**
 * Toast notification
 */
function showToast(type, message, duration = 3000) {
  document.querySelectorAll('.toast-notification').forEach(t => t.remove());

  const toast = document.createElement('div');
  toast.className = `toast-notification ${type}`;
  toast.textContent = message;

  document.body.appendChild(toast);

  if (duration > 0) {
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }
}

console.log('âœ… Sprint 2.6 V2 : Tableau importÃ© avec parser intelligent chargÃ©');


async function loadGrid(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  if(!client || !year || year === "__new_year__"){
    setStatus("SÃ©lectionner d'abord un client et une annÃ©e valide.", true);
    return;
  }
  
  updateStatusIndicator('saving', 'â³ Chargement...');
  
  // 1. Essayer cloud d'abord
  if (isSupabaseAvailable) {
    try {
      const cloudData = await loadGridFromCloud(client, parseInt(year));
 if (cloudData) {
        deserializeGrid(cloudData);
        
        // SPRINT 2.6: Stocker en mÃ©moire
        currentGridData = cloudData;
        
        // SPRINT 2.6: Render section importÃ©es
        const container = document.getElementById('importedSectionContainer');
        if (container) {
     container.innerHTML = renderImportedTable(cloudData);

		// Initialiser drop zones APRÃˆS render
		setTimeout(() => {
  			initializeTableDropZones();
			}, 100);
        }
        
        setStatus("â˜ï¸ ChargÃ© depuis cloud " + client + " â€“ " + year, false);
        updateStatusIndicator('cloud', 'â˜ï¸ Cloud OK');
        return;
      }
    } catch(e) {
      console.warn('âš ï¸ Cloud Ã©chouÃ©, essai local:', e);
    }
  }
  
  // 2. Fallback localStorage
  const key = getContextKey(client, year);
  const raw = localStorage.getItem(key);
  if(!raw){
    // BUGFIX V11.0.20 P0 #5: Vider interface pour nouveau client
    resetGridToInitial();
    setStatus("Aucune sauvegarde pour " + client + " â€“ " + year + " (nouvelle grille crÃ©Ã©e)", false);
    updateStatusIndicator('local', 'ğŸ“ Nouvelle grille');
    return;
  }
  try{
    const data = JSON.parse(raw);
  deserializeGrid(data);
    
    // SPRINT 2.6: Stocker en mÃ©moire
    currentGridData = data;
    
    // SPRINT 2.6: Render section importÃ©es
    const container = document.getElementById('importedSectionContainer');
    if (container) {
      container.innerHTML = renderImportedTable(data);

	// Initialiser drop zones APRÃˆS render
		setTimeout(() => {
 		 initializeTableDropZones();
		}, 100);
    }
    
    setStatus("ğŸ’¾ ChargÃ© depuis local " + client + " â€“ " + year, false);
    updateStatusIndicator('local', 'ğŸ“ Local');
  }catch(e){
    console.error(e);
    setStatus("Erreur lors du chargement local.", true);
    updateStatusIndicator('error', 'âŒ Erreur');
  }
}

// ========================================
// NOUVELLES FONCTIONNALITÃ‰S V10.3.0
// ========================================

// Export JSON
function exportGridJSON(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  if(!client || !year || year === "__new_year__"){
    setStatus("SÃ©lectionner d'abord un client et une annÃ©e valide.", true);
    return;
  }
  
  const data = serializeGrid();
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `grille_tarifaire_${client}_${year}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  setStatus(`Grille exportÃ©e : grille_tarifaire_${client}_${year}.json`, false);
}

// Import JSON
function importGridJSON(){
  const fileInput = document.getElementById('importFileInput');
  fileInput.click();
}

function handleImportFile(event){
  const file = event.target.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = async function(e){ // BUGFIX V11.0.17: async
    try{
      const data = JSON.parse(e.target.result);
      
      // VÃ©rifier que c'est bien une grille valide
      if(!data.client || !data.year || !Array.isArray(data.rows)){
        setStatus("Fichier JSON invalide : format de grille non reconnu.", true);
        return;
      }
      
      // Demander confirmation
      const msg = `Importer la grille de ${data.client} â€“ ${data.year} ?\n` +
                  `Cela va :\n` +
                  `1. Changer le client vers "${data.client}"\n` +
                  `2. Changer l'annÃ©e vers "${data.year}"\n` +
                  `3. Remplacer toutes les donnÃ©es actuelles\n` +
                  `4. CrÃ©er le client dans le cloud si nÃ©cessaire\n\n` +
                  `Les donnÃ©es actuelles seront Ã©crasÃ©es. Continuer ?`;
      
      if(!confirm(msg)) return;
      
      // Charger la grille importÃ©e
      deserializeGrid(data);
      
      // Mettre Ã  jour les sÃ©lecteurs
      const clientSel = document.getElementById('clientSelect');
      
      // BUGFIX V11.0.16: VÃ©rifier doublons avec normalisation complÃ¨te (casse, espaces, accents)
      function normalizeClientName(name) {
        return name.trim()
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, ''); // Supprimer les accents
      }
      
      const clientNameNormalized = normalizeClientName(data.client);
      let clientOpt = null;
      
      for(const opt of clientSel.options){
        if(opt.value === "__new_client__") continue;
        const optTextNormalized = normalizeClientName(opt.textContent);
        const optValueNormalized = normalizeClientName(opt.value);
        
        if(optTextNormalized === clientNameNormalized || optValueNormalized === clientNameNormalized){
          clientOpt = opt;
          break;
        }
      }
      
      if(!clientOpt){
        clientOpt = document.createElement('option');
        clientOpt.value = data.client.trim();
        clientOpt.textContent = data.client.trim();
        clientSel.insertBefore(clientOpt, clientSel.querySelector('option[value="__new_client__"]'));
        console.log('âœ… Nouveau client ajoutÃ© au select:', data.client);
      } else {
        console.log('âœ… Client existant trouvÃ©:', clientOpt.textContent);
      }
      
      clientSel.value = clientOpt.value;
      
      await populateYearSelectForClient(data.client, data.year); // BUGFIX V11.0.20: await
      
      // BUGFIX V11.0.18: Forcer l'ajout de l'annÃ©e importÃ©e si elle n'existe pas dans le select
      const yearSelect = document.getElementById("yearSelect");
      if(yearSelect && !Array.from(yearSelect.options).some(o => o.value === String(data.year))){
        const optYear = document.createElement("option");
        optYear.value = String(data.year);
        optYear.textContent = String(data.year);
        
        // Trouver la position correcte pour insertion (ordre chronologique)
        const yearNum = parseInt(data.year);
        let insertBefore = null;
        
        for(let opt of yearSelect.options){
          if(opt.value === "__new_year__"){
            insertBefore = opt;
            break;
          }
          const optYear = parseInt(opt.value);
          if(!isNaN(optYear) && optYear > yearNum){
            insertBefore = opt;
            break;
          }
        }
        
        if(insertBefore){
          yearSelect.insertBefore(optYear, insertBefore);
        } else {
          yearSelect.appendChild(optYear);
        }
        
        console.log('âœ… AnnÃ©e importÃ©e ajoutÃ©e au select:', data.year);
      }
      
      yearSelect.value = String(data.year);
      currentContext.client = data.client;
      currentContext.year = String(data.year);
      updateTitleSubtitle();
      
      setStatus(`âœ“ Grille importÃ©e : ${data.client} â€“ ${data.year} | Sauvegarde en cours...`, false);
      
      // BUGFIX V11.0.17: Sauvegarder avec crÃ©ation auto du client dans cloud
      await saveGrid();
      
      // BUGFIX v11.0.23: Recharger annÃ©es depuis cloud aprÃ¨s sauvegarde
      console.log('ğŸ”„ Rechargement annÃ©es depuis cloud aprÃ¨s import...');
      await populateYearSelectForClient(data.client, data.year);
      yearSelect.value = String(data.year); // Re-sÃ©lectionner l'annÃ©e importÃ©e
      
      setStatus(`âœ… Grille importÃ©e et sauvegardÃ©e : ${data.client} â€“ ${data.year}`, false);
      
    }catch(err){
      console.error(err);
      setStatus("Erreur lors de l'import : fichier JSON corrompu.", true);
    }
  };
  
  reader.readAsText(file);
  event.target.value = ''; // Reset input
}

// Export CSV
function exportGridCSV(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  if(!client || !year || year === "__new_year__"){
    setStatus("SÃ©lectionner d'abord un client et une annÃ©e valide.", true);
    return;
  }
  
  const data = serializeGrid();
  
  // En-tÃªtes CSV
  let csv = 'Destination;Trajet;VL HT;VL TTC;VL NÂ° Fact;MC22 HT;MC22 TTC;MC22 NÂ° Fact;MC33 HT;MC33 TTC;MC33 NÂ° Fact;AC55 HT;AC55 TTC;AC55 NÂ° Fact;AC64 HT;AC64 TTC;AC64 NÂ° Fact;Note\n';
  
  // Lignes de donnÃ©es
  data.rows.forEach(row => {
    const dest = (row.dest || '').replace(/;/g, ','); // Ã‰chapper points-virgules
    const trajet = (row.trajet || '').replace(/_/g, ' ');
    const note = (row.note || '').replace(/;/g, ',');
    
    const tva = getTVA();
    const formatPrice = (ht) => {
      if(!ht) return '';
      const ttc = ht * (1 + tva);
      return `${ht.toFixed(2)};${ttc.toFixed(2)}`;
    };
    
    csv += `${dest};${trajet};`;
    
    VEHICULES.forEach(cat => {
      const ht = row.tarifs && row.tarifs[cat] ? row.tarifs[cat] : null;
      const facture = row.factures && row.factures[cat] ? row.factures[cat] : '';
      
      if(ht){
        const ttc = ht * (1 + tva);
        csv += `${ht.toFixed(2)};${ttc.toFixed(2)};${facture};`;
      } else {
        csv += `;;${facture};`;
      }
    });
    
    csv += `${note}\n`;
  });
  
  // TÃ©lÃ©charger
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `grille_tarifaire_${client}_${year}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  setStatus(`Grille exportÃ©e en CSV : grille_tarifaire_${client}_${year}.csv`, false);
}

// Dupliquer annÃ©e
function duplicateYear(){
  const client = getCurrentClient();
  const currentYear = getCurrentYear();
  
  if(!client || !currentYear || currentYear === "__new_year__"){
    setStatus("SÃ©lectionner d'abord un client et une annÃ©e source valide.", true);
    return;
  }
  
  const newYearStr = prompt(`Dupliquer l'annÃ©e ${currentYear} vers quelle nouvelle annÃ©e ?\n(Format : AAAA, exemple : ${parseInt(currentYear,10) + 1})`);
  
  if(!newYearStr) return; // AnnulÃ©
  
  const newYear = parseInt(newYearStr, 10);
  
  // Validation
  if(isNaN(newYear) || newYear < 2000 || newYear > 2099){
    setStatus("AnnÃ©e invalide. Utilisez un format AAAA entre 2000 et 2099.", true);
    return;
  }
  
  // VÃ©rifier si l'annÃ©e existe dÃ©jÃ 
  const existingYears = getStoredYearsForClient(client);
  if(existingYears.includes(newYear)){
    if(!confirm(`L'annÃ©e ${newYear} existe dÃ©jÃ  pour ${client}. Ã‰craser les donnÃ©es ?`)){
      return;
    }
  }
  
  // Dupliquer les donnÃ©es
  const currentData = serializeGrid();
  const newData = {
    version: currentData.version || "10.4.3",
    tva: currentData.tva,
    savedAt: new Date().toISOString(),
    tables: JSON.parse(JSON.stringify(currentData.tables || {})), // Deep copy
    tablesOrder: currentData.tablesOrder ? [...currentData.tablesOrder] : []
  };
  
  // Sauvegarder la nouvelle annÃ©e
  const newKey = getContextKey(client, newYear);
  try{
    localStorage.setItem(newKey, JSON.stringify(newData));
    
    // Passer Ã  la nouvelle annÃ©e
    populateYearSelectForClient(client, newYear);
    currentContext.year = newYear;
    updateTitleSubtitle();
    loadGridForCurrentContext();
    
    const totalRows = Object.values(newData.tables).reduce((sum, t) => sum + (t.rows?.length || 0), 0);
    setStatus(`AnnÃ©e ${currentYear} dupliquÃ©e vers ${newYear} avec succÃ¨s ! ${totalRows} lignes copiÃ©es dans ${Object.keys(newData.tables).length} tableau(x).`, false);
  }catch(e){
    console.error(e);
    setStatus("Erreur lors de la duplication de l'annÃ©e.", true);
  }
}

// Renommer un client
function renameClient(){
  const currentClient = getCurrentClient();
  
  if(!currentClient || currentClient === "__new_client__"){
    setStatus("SÃ©lectionner d'abord un client valide Ã  renommer.", true);
    return;
  }
  
  const newName = prompt(`Renommer le client "${currentClient}" vers quel nouveau nom ?`, currentClient);
  
  if(!newName) return; // AnnulÃ©
  if(newName === currentClient){
    setStatus("Le nouveau nom est identique Ã  l'ancien.", false);
    return;
  }
  
  // Normaliser (trim seulement) v11.0.6
  const newClientName = newName.trim();
  
  if(!newClientName){
    setStatus("Le nom du client ne peut pas Ãªtre vide.", true);
    return;
  }
  
  // VÃ©rifier si le nouveau nom existe dÃ©jÃ 
  const clientsList = JSON.parse(localStorage.getItem(STORAGE_PREFIX + "CLIENTS_LIST") || "[]");
  if(clientsList.includes(newClientName)){
    setStatus(`Le client "${newClientName}" existe dÃ©jÃ . Choisissez un autre nom.`, true);
    return;
  }
  
  // Confirmation
  const yearsCount = getStoredYearsForClient(currentClient).length;
  const msg = `Renommer "${currentClient}" en "${newClientName}" ?\n\n` +
              `Cela va renommer le client pour ${yearsCount} annÃ©e(s) sauvegardÃ©e(s).\n\n` +
              `Cette opÃ©ration est irrÃ©versible. Continuer ?`;
  
  if(!confirm(msg)) return;
  
  try {
    // 1. RÃ©cupÃ©rer toutes les clÃ©s localStorage du client actuel
    const keysToRename = [];
    for(let i = 0; i < localStorage.length; i++){
      const key = localStorage.key(i);
      if(key && key.startsWith(STORAGE_PREFIX + currentClient + "::")){
        keysToRename.push(key);
      }
    }
    
    // 2. Copier les donnÃ©es avec le nouveau nom
    keysToRename.forEach(oldKey => {
      const data = localStorage.getItem(oldKey);
      if(data){
        try {
          const parsed = JSON.parse(data);
          parsed.client = newClientName; // Mettre Ã  jour le nom dans les donnÃ©es
          
          const newKey = oldKey.replace(STORAGE_PREFIX + currentClient + "::", STORAGE_PREFIX + newClientName + "::");
          localStorage.setItem(newKey, JSON.stringify(parsed));
        } catch(e){
          console.error("Erreur parsing:", oldKey, e);
        }
      }
    });
    
    // 3. Supprimer les anciennes clÃ©s
    keysToRename.forEach(oldKey => {
      localStorage.removeItem(oldKey);
    });
    
    // 4. Mettre Ã  jour la liste des clients
    const index = clientsList.indexOf(currentClient);
    if(index > -1){
      clientsList[index] = newClientName;
      localStorage.setItem(STORAGE_PREFIX + "CLIENTS_LIST", JSON.stringify(clientsList));
    }
    
    // 5. Mettre Ã  jour le sÃ©lecteur et recharger
    const clientSel = document.getElementById("clientSelect");
    const option = Array.from(clientSel.options).find(o => o.value === currentClient);
    if(option){
      option.value = newClientName;
      option.textContent = newClientName;
    }
    
    clientSel.value = newClientName;
    currentContext.client = newClientName;
    updateTitleSubtitle();
    
    setStatus(`Client renommÃ© avec succÃ¨s : "${currentClient}" â†’ "${newClientName}" (${yearsCount} annÃ©e(s) mises Ã  jour)`, false);
    
    // Recharger la grille actuelle
    loadGridForCurrentContext();
    
  } catch(e){
    console.error(e);
    setStatus("Erreur lors du renommage du client.", true);
  }
}

// ========================================
// TABLEAUX DYNAMIQUES V10.4.0 - VERSION SIMPLE
// ========================================

function renderTablesManager(){
  try {
    const container = document.getElementById("tablesManager");
    if(!container) return;
    
    container.innerHTML = "";
    
    // S'assurer que les tableaux HTML correspondants sont visibles
    tables.forEach(table => {
      const tableElement = document.getElementById(table.id + 'Table');
      if(tableElement){
        const card = tableElement.closest('.card');
        if(card){
          card.style.display = '';
          delete card.dataset.deleted;
        }
      }
    });
    
    // Masquer les tableaux qui ne sont plus dans la liste
    document.querySelectorAll('[id$="Table"]').forEach(tableElement => {
      const tableId = tableElement.id.replace('Table', '');
      if(tableId === 'destinations' || tableId === 'transferts'){
        const exists = tables.some(t => t.id === tableId);
        if(!exists){
          const card = tableElement.closest('.card');
          if(card){
            card.style.display = 'none';
            card.dataset.deleted = 'true';
          }
        }
      }
    });
    
    tables.forEach((table, index) => {
      const div = document.createElement("div");
      div.className = "table-item";
      div.draggable = true;
      div.dataset.tableId = table.id;
      div.style.cursor = 'move';
      
      div.innerHTML = `
        <span style="font-size:1.5rem; cursor:move;">â˜° ${table.icon}</span>
        <div class="table-info">
          <div class="table-name">${table.name}</div>
          <div class="table-meta">ID: ${table.id}</div>
        </div>
        <div class="table-actions">
          <button type="button" class="btn" onclick="changeTableIcon('${table.id}')" title="Changer l'icÃ´ne">ğŸ¨</button>
          <button type="button" class="btn" onclick="renameTable('${table.id}')" title="Renommer">âœï¸</button>
          ${tables.length > 1 ? `<button type="button" class="btn btn-ghost" onclick="deleteTable('${table.id}')" title="Supprimer">ğŸ—‘ï¸</button>` : ''}
        </div>
      `;
      
      // Drag & Drop events
      div.addEventListener('dragstart', function(e){
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', table.id);
        this.style.opacity = '0.5';
      });
      
      div.addEventListener('dragend', function(){
        this.style.opacity = '1';
      });
      
      div.addEventListener('dragover', function(e){
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.style.borderTop = '3px solid #428bca';
      });
      
      div.addEventListener('dragleave', function(){
        this.style.borderTop = '';
      });
      
      div.addEventListener('drop', function(e){
        e.preventDefault();
        this.style.borderTop = '';
        
        const draggedId = e.dataTransfer.getData('text/plain');
        const targetId = this.dataset.tableId;
        
        if(draggedId === targetId) return;
        
        // RÃ©organiser
        const draggedIndex = tables.findIndex(t => t.id === draggedId);
        const targetIndex = tables.findIndex(t => t.id === targetId);
        
        const [draggedTable] = tables.splice(draggedIndex, 1);
        tables.splice(targetIndex, 0, draggedTable);
        
        // RÃ©organiser les cards HTML
        reorderTableCards();
        
        renderTablesManager();
        console.log('âœ… Tableaux rÃ©organisÃ©s:', tables.map(t => t.name));
      });
      
      container.appendChild(div);
    });
  } catch(e){
    console.error("Erreur renderTablesManager:", e);
  }
}

// RÃ©organiser les cards HTML selon l'ordre des tableaux
function reorderTableCards(){
  const majorationsCard = document.querySelector('.card-majorations');
  
  if(!majorationsCard) {
    console.warn('Card majorations non trouvÃ©e');
    return;
  }
  
  // Placer chaque tableau APRÃˆS la card majorations, dans l'ordre
  tables.forEach((table, index) => {
    const tableElement = document.getElementById(table.id + 'Table');
    if(tableElement){
      const card = tableElement.closest('.card');
      if(card && card !== majorationsCard){
        // InsÃ©rer aprÃ¨s majorations (ou aprÃ¨s le tableau prÃ©cÃ©dent)
        if(index === 0){
          // Premier tableau : aprÃ¨s majorations
          majorationsCard.parentNode.insertBefore(card, majorationsCard.nextSibling);
        } else {
          // Tableaux suivants : aprÃ¨s le prÃ©cÃ©dent
          const prevTableId = tables[index - 1].id;
          const prevTableElement = document.getElementById(prevTableId + 'Table');
          if(prevTableElement){
            const prevCard = prevTableElement.closest('.card');
            if(prevCard){
              prevCard.parentNode.insertBefore(card, prevCard.nextSibling);
            }
          }
        }
      }
    }
  });
}

function createTable(){
  try {
    const name = prompt("Nom du nouveau tableau :", "Nouveau tableau");
    if(!name) return;
    
    const nameTrimmed = name.trim();
    if(!nameTrimmed){
      alert("Le nom du tableau ne peut pas Ãªtre vide.");
      return;
    }
    
    const id = nameTrimmed.toLowerCase().replace(/[^a-z0-9]+/g, '_') + '_' + Date.now();
    const icons = ['ğŸ“‹', 'ğŸ¯', 'ğŸš€', 'â­', 'ğŸ¨', 'ğŸ”§', 'ğŸ“¦', 'ğŸª', 'ğŸŒŸ', 'ğŸ’¼'];
    const icon = icons[Math.floor(Math.random() * icons.length)];
    
    const newTable = {
      id: id,
      name: nameTrimmed,
      icon: icon,
      order: tables.length
    };
    
    tables.push(newTable);
    tableCounters[id] = 0;
    
    // CrÃ©er le HTML du tableau
    const card = createTableHTML(newTable);
    if(card){
      // InsÃ©rer APRÃˆS la card majorations
      const majorationsCard = document.querySelector('.card-majorations');
      if(majorationsCard){
        majorationsCard.parentNode.insertBefore(card, majorationsCard.nextSibling);
      } else {
        // Fallback : Ã  la fin
        document.querySelector('.page').appendChild(card);
      }
      
      // Ajouter une ligne par dÃ©faut
      addRowToCustomTable(id);
      
      // Appliquer la visibilitÃ© des colonnes
      applyColumnVisibility();
      
      // RÃ©activer le drag & drop pour le nouveau tableau
      enableDragAndDrop();
    }
    
    setStatus(`Tableau "${nameTrimmed}" crÃ©Ã© avec succÃ¨s !`, false);
    renderTablesManager();
    
    // Sauvegarder automatiquement
    saveGrid();
    
  } catch(e){
    console.error("Erreur createTable:", e);
    alert("Erreur lors de la crÃ©ation du tableau : " + e.message);
  }
}

function renameTable(tableId){
  try {
    const table = tables.find(t => t.id === tableId);
    if(!table) return;
    
    const newName = prompt(`Renommer le tableau "${table.name}" :`, table.name);
    if(!newName) return;
    
    const nameTrimmed = newName.trim();
    if(!nameTrimmed){
      alert("Le nom du tableau ne peut pas Ãªtre vide.");
      return;
    }
    
    table.name = nameTrimmed;
    setStatus(`Tableau renommÃ© : "${nameTrimmed}"`, false);
    
    // Mettre Ã  jour le titre HTML (pour tous les tableaux)
    const titleEl = document.getElementById(tableId + 'Title');
    if(titleEl){
      titleEl.textContent = `${table.icon} ${nameTrimmed}`;
    }
    
    // Mettre Ã  jour le bouton "Ajouter ligne" si c'est un tableau personnalisÃ©
    const card = document.getElementById(tableId + 'Card');
    if(card){
      const btn = card.querySelector('.toolbar button');
      if(btn){
        btn.textContent = `+ Ajouter une ligne Ã  ${nameTrimmed}`;
      }
    }
    
    renderTablesManager();
    
    // Sauvegarder automatiquement
    saveGrid();
  } catch(e){
    console.error("Erreur renameTable:", e);
  }
}

function changeTableIcon(tableId){
  try {
    const table = tables.find(t => t.id === tableId);
    if(!table) return;
    
    const icons = ['ğŸ“', 'ğŸš‰', 'ğŸ“‹', 'ğŸ¯', 'ğŸš€', 'â­', 'ğŸ¨', 'ğŸ”§', 'ğŸ“¦', 'ğŸª', 'ğŸŒŸ', 'ğŸ’¼', 'ğŸ–ï¸', 'ğŸ“', 'ğŸ¢', 'ğŸšŒ', 'âœˆï¸', 'ğŸ­', 'ğŸ¬', 'ğŸ®', 'ğŸ“š', 'ğŸ†', 'ğŸ¸'];
    
    let iconList = "Choisissez une icÃ´ne (entrez le numÃ©ro) :\n\n";
    icons.forEach((ic, idx) => {
      iconList += `${idx + 1}. ${ic}  `;
      if((idx + 1) % 6 === 0) iconList += "\n";
    });
    
    const choice = prompt(iconList + `\n\nActuel : ${table.icon}`, "");
    if(!choice) return;
    
    const index = parseInt(choice, 10) - 1;
    if(isNaN(index) || index < 0 || index >= icons.length){
      alert("NumÃ©ro invalide.");
      return;
    }
    
    table.icon = icons[index];
    
    // Mettre Ã  jour le titre HTML
    const titleEl = document.getElementById(tableId + 'Title');
    if(titleEl){
      titleEl.textContent = `${table.icon} ${table.name}`;
    }
    
    renderTablesManager();
    setStatus(`IcÃ´ne du tableau "${table.name}" changÃ©e en ${table.icon}`, false);
    
    // Sauvegarder automatiquement
    saveGrid();
  } catch(e){
    console.error("Erreur changeTableIcon:", e);
  }
}

function deleteTable(tableId){
  try {
    const table = tables.find(t => t.id === tableId);
    if(!table) return;
    
    if(tables.length <= 1){
      alert("Impossible de supprimer le dernier tableau.");
      return;
    }
    
    if(!confirm(`Supprimer le tableau "${table.name}" ?`)){
      return;
    }
    
    // Supprimer de la liste
    tables = tables.filter(t => t.id !== tableId);
    delete tableCounters[tableId];
    
    // Supprimer le HTML
    const tableElement = document.getElementById(tableId + 'Table');
    if(tableElement){
      const card = tableElement.closest('.card');
      if(card){
        // Pour les tableaux par dÃ©faut (destinations/transferts), juste masquer
        if(tableId === 'destinations' || tableId === 'transferts'){
          card.style.display = 'none';
          card.dataset.deleted = 'true';
        } else {
          // Pour les tableaux personnalisÃ©s, supprimer complÃ¨tement
          card.remove();
        }
      }
    }
    
    setStatus(`Tableau "${table.name}" supprimÃ©.`, false);
    renderTablesManager();
    
    // Sauvegarder automatiquement
    saveGrid();
  } catch(e){
    console.error("Erreur deleteTable:", e);
  }
}

// ========================================
// FIN TABLEAUX DYNAMIQUES V10.4.0
// ========================================

// CrÃ©er dynamiquement le HTML d'un tableau complet
function createTableHTML(table){
  try {
    // CrÃ©er la carte
const card = document.createElement('div');
card.className = 'card card-draggable';
card.id = table.id + 'Card';
card.setAttribute('data-table-id', table.id);

// Ajouter handle de drag
const dragHandle = document.createElement('div');
dragHandle.className = 'card-drag-handle';
dragHandle.setAttribute('draggable', 'true');
dragHandle.textContent = 'â‹®â‹®';
card.appendChild(dragHandle);

// Titre
const h2 = document.createElement('h2');
h2.id = table.id + 'Title';
h2.textContent = `${table.icon} ${table.name}`;
card.appendChild(h2);
    
    // Description
    const p = document.createElement('p');
    p.textContent = `Tableau personnalisÃ© : ${table.name}`;
    card.appendChild(p);
    
    // Wrapper du tableau
    const wrapper = document.createElement('div');
    wrapper.className = 'table-wrapper';
    
    // Tableau
    const tableElem = document.createElement('table');
    tableElem.id = table.id + 'Table';
    tableElem.className = 'pricing-table';
    
    // Header (identique Ã  Destinations)
    tableElem.innerHTML = `
      <thead>
        <tr>
          <th class="highlight-col">âš‘</th>
          <th class="dest">Destination</th>
          <th class="trajet">Trajet</th>
          <th class="group-VL col-no">NÂ° Fact. VL</th>
          <th class="group-VL col-ht">VL HT</th>
          <th class="group-VL col-ttc">VL TTC</th>
          <th class="group-VL col-evol">Ã‰vol. VL (%)</th>
          <th class="group-MC22 col-no">NÂ° Fact. Minicar 22</th>
          <th class="group-MC22 col-ht">Minicar 22 HT</th>
          <th class="group-MC22 col-ttc">Minicar 22 TTC</th>
          <th class="group-MC22 col-evol">Ã‰vol. Min. 22 (%)</th>
          <th class="group-MC33 col-no">NÂ° Fact. Minicar 33</th>
          <th class="group-MC33 col-ht">Minicar 33 HT</th>
          <th class="group-MC33 col-ttc">Minicar 33 TTC</th>
          <th class="group-MC33 col-evol">Ã‰vol. Min. 33 (%)</th>
          <th class="group-AC55 col-no">NÂ° Fact. Autocar 55</th>
          <th class="group-AC55 col-ht">Autocar 55 HT</th>
          <th class="group-AC55 col-ttc">Autocar 55 TTC</th>
          <th class="group-AC55 col-evol">Ã‰vol. A55 (%)</th>
          <th class="group-AC64 col-no">NÂ° Fact. Autocar 64</th>
          <th class="group-AC64 col-ht">Autocar 64 HT</th>
          <th class="group-AC64 col-ttc">Autocar 64 TTC</th>
          <th class="group-AC64 col-evol">Ã‰vol. A64 (%)</th>
          <th class="col-note">Note</th>
          <th>Suppr.</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    
    wrapper.appendChild(tableElem);
    card.appendChild(wrapper);
    
    // Toolbar avec bouton ajouter ligne
    const toolbar = document.createElement('div');
    toolbar.className = 'toolbar';
    
    const btnAdd = document.createElement('button');
    btnAdd.type = 'button';
    btnAdd.className = 'btn';
    btnAdd.textContent = `+ Ajouter une ligne Ã  ${table.name}`;
    btnAdd.onclick = function(){ addRowToCustomTable(table.id); };
    toolbar.appendChild(btnAdd);
    
    card.appendChild(toolbar);
    
    return card;
  } catch(e){
    console.error("Erreur createTableHTML:", e);
    return null;
  }
}

// Ajouter une ligne Ã  un tableau personnalisÃ©
function addRowToCustomTable(tableId){
  try {
    const table = tables.find(t => t.id === tableId);
    if(!table){
      console.error("Tableau introuvable:", tableId);
      return;
    }
    
    // Utiliser createRow avec un type custom
    const tbody = document.querySelector(`#${tableId}Table tbody`);
    if(!tbody){
      console.error("Tbody introuvable pour:", tableId);
      return;
    }
    
    // CrÃ©er une ligne similaire Ã  createRow mais pour tableau custom
    const index = ++tableCounters[tableId];
    const uniqueId = Date.now() + "_" + Math.random().toString(36).substr(2, 9);
    const trajId = tableId + "_" + uniqueId;
    
    const tr = document.createElement("tr");
    tr.dataset.trajet = trajId;
    tr.dataset.index = String(index);
    tr.dataset.freq = "0";
    
    // Colonne highlight
    const tdMark = document.createElement("td");
    tdMark.className = "highlight-col";
    
    // Ajouter le handle de drag (â‹®â‹®)
    const handle = document.createElement("span");
    handle.className = "drag-handle";
    handle.innerHTML = "â‹®â‹®";
    handle.title = "Glisser pour rÃ©organiser";
    handle.setAttribute("draggable", "true");
    tdMark.appendChild(handle);
    
    const mark = document.createElement("input");
    mark.type = "checkbox";
    mark.className = "highlight-toggle";
    mark.addEventListener("change", function(){
      tr.classList.toggle("row-highlight", mark.checked);
    });
    tdMark.appendChild(mark);
    tr.appendChild(tdMark);
    
    // Destination
    const tdDest = document.createElement("td");
    tdDest.className = "dest";
    const inputName = document.createElement("input");
    inputName.type = "text";
    inputName.className = "dest-name";
    inputName.value = `${table.name} ${index}`;
    inputName.setAttribute("list","destinationsList");
    applyTooltip(inputName);
    tdDest.appendChild(inputName);
    tr.appendChild(tdDest);
    
    // Trajet
    const tdTrajet = document.createElement("td");
    tdTrajet.className = "trajet";
    const sel = document.createElement("select");
    sel.className = "trajet-select";
    [["aller_retour","Aller et retour"],["aller","Aller"],["retour","Retour"]].forEach(([val,lab])=>{
      const opt=document.createElement("option");
      opt.value=val;
      opt.textContent=lab;
      sel.appendChild(opt);
    });
    tdTrajet.appendChild(sel);
    tr.appendChild(tdTrajet);
    
    // Colonnes vÃ©hicules
    VEHICULES.forEach(cat => {
      const groupClass = "group-" + cat;
      
      // NÂ° Facture
      let tdF = document.createElement("td");
      tdF.className = groupClass + " col-no";
      const inF = document.createElement("input");
      inF.type = "text";
      inF.className = "facture-input";
      applyTooltip(inF);
      tdF.appendChild(inF);
      tr.appendChild(tdF);
      
      // HT
      tdF = document.createElement("td");
      tdF.className = groupClass + " col-ht";
      const inHT = document.createElement("input");
      inHT.type = "text";
      inHT.className = "price-input";
      inHT.dataset.key = trajId + "|" + cat + "|HT";
      applyTooltip(inHT);
      tdF.appendChild(inHT);
      tr.appendChild(tdF);
      
      // TTC
      tdF = document.createElement("td");
      tdF.className = groupClass + " col-ttc";
      const inTTC = document.createElement("input");
      inTTC.type = "text";
      inTTC.className = "ttc-input";
      inTTC.dataset.key = trajId + "|" + cat + "|TTC";
      applyTooltip(inTTC);
      tdF.appendChild(inTTC);
      tr.appendChild(tdF);
      
      // Ã‰volution
      tdF = document.createElement("td");
      tdF.className = groupClass + " col-evol evol-cell";
      tr.appendChild(tdF);
    });
    
    // Note
    const tdNote = document.createElement("td");
    tdNote.className = "col-note";
    const inputNote = document.createElement("input");
    inputNote.type = "text";
    inputNote.className = "note-input";
    inputNote.maxLength = 200;
    applyTooltip(inputNote);
    tdNote.appendChild(inputNote);
    tr.appendChild(tdNote);
    
    // Delete
    const tdDel = createDeleteCell();
    tdDel.querySelector('.btn-delete').addEventListener('click', function(){
      if(confirm("Supprimer cette ligne ?")){
        tr.remove();
      }
    });
    tr.appendChild(tdDel);
    
    tbody.appendChild(tr);
    
    // RÃ©attacher les event listeners HT/TTC
    attachPriceListeners();
    
  } catch(e){
    console.error("Erreur addRowToCustomTable:", e);
  }
}

// Attacher les event listeners pour HT/TTC (aprÃ¨s crÃ©ation dynamique)
function attachPriceListeners(){
  document.querySelectorAll('.price-input').forEach(input => {
    if(!input.dataset.listenerAttached){
      input.addEventListener('input', function(){ updateFromHT(input); });
      input.addEventListener('blur', function(){
        const v = parseNumberFR(input.value);
        if(!isNaN(v)) input.value = formatNumberFR(v, 2);
      });
      input.dataset.listenerAttached = 'true';
    }
  });
  
  document.querySelectorAll('.ttc-input').forEach(input => {
    if(!input.dataset.listenerAttached){
      input.addEventListener('input', function(){ updateFromTTC(input); });
      input.addEventListener('blur', function(){
        const v = parseNumberFR(input.value);
        if(!isNaN(v)) input.value = formatNumberFR(v, 2);
      });
      input.dataset.listenerAttached = 'true';
    }
  });
}

// Drag & Drop pour tri manuel des destinations
let draggedRow = null;

function enableDragAndDrop(){
  // Activer le drag & drop pour TOUS les tableaux (destinations, transferts, personnalisÃ©s)
  tables.forEach(table => {
    const tbody = document.querySelector(`#${table.id}Table tbody`);
    if(!tbody) return;
    
    // Ã‰viter de rÃ©attacher plusieurs fois
    if(tbody.dataset.dragEnabled) return;
    tbody.dataset.dragEnabled = 'true';
    
    tbody.addEventListener('dragstart', function(e){
      if(e.target.classList.contains('drag-handle')){
        const tr = e.target.closest('tr');
        if(tr){
          draggedRow = tr;
          tr.style.opacity = '0.5';
        }
      } else {
        e.preventDefault();
        return false;
      }
    });
    
    tbody.addEventListener('dragend', function(e){
      if(draggedRow){
        draggedRow.style.opacity = '';
        draggedRow = null;
        
        // BUGFIX v11.0.22: Sauvegarder aprÃ¨s rÃ©organisation des lignes
        triggerAutoSave();
      }
    });
    
    tbody.addEventListener('dragover', function(e){
      e.preventDefault();
      const targetRow = e.target.closest('tr');
      if(targetRow && targetRow !== draggedRow && draggedRow){
        const rect = targetRow.getBoundingClientRect();
        const midpoint = rect.top + rect.height / 2;
        
        if(e.clientY < midpoint){
          tbody.insertBefore(draggedRow, targetRow);
        } else {
          tbody.insertBefore(draggedRow, targetRow.nextSibling);
        }
      }
    });
  });
  
  // Ajouter les handles sur toutes les lignes existantes
  addDragHandlesToRows();
}

// Ajouter un handle de drag (â‹®â‹®) Ã  toutes les lignes de tous les tableaux
function addDragHandlesToRows(){
  tables.forEach(table => {
    document.querySelectorAll(`#${table.id}Table tbody tr`).forEach(tr => {
      // VÃ©rifier si le handle existe dÃ©jÃ 
      if(tr.querySelector('.drag-handle')) return;
      
      // Trouver la premiÃ¨re cellule (celle avec âš‘)
      const firstCell = tr.querySelector('td.highlight-col');
      if(!firstCell) return;
      
      // CrÃ©er le handle de drag
      const handle = document.createElement('span');
      handle.className = 'drag-handle';
      handle.innerHTML = 'â‹®â‹®';
      handle.title = 'Glisser pour rÃ©organiser';
      handle.setAttribute('draggable', 'true');
      
      // InsÃ©rer le handle au dÃ©but de la cellule
      firstCell.insertBefore(handle, firstCell.firstChild);
    });
  });
}

function makeRowsDraggable(){
  // Cette fonction est maintenant gÃ©rÃ©e par addDragHandlesToRows
  addDragHandlesToRows();
}

async function loadPreviousYearPayload(){
  const client = getCurrentClient();
  const year = parseInt(getCurrentYear(),10);
  if(!client || !year || isNaN(year)) return null;
  const prevYear = year - 1;
  
  // 1. Essayer localStorage d'abord (plus rapide)
  const key = getContextKey(client, prevYear);
  const raw = localStorage.getItem(key);
  if(raw) {
    try{
      return JSON.parse(raw);
    }catch{
      // Continue to cloud
    }
  }
  
  // 2. Fallback Supabase cloud (si localStorage vide/erreur)
  if(isSupabaseAvailable){
    try {
      const cloudData = await loadGridFromCloud(client, prevYear);
      if(cloudData) {
        console.log(`âœ… AnnÃ©e N-1 (${prevYear}) chargÃ©e depuis cloud pour Ã©volutions`);
        return cloudData;
      }
    } catch(err) {
      console.warn('âš ï¸ Erreur chargement N-1 cloud:', err);
    }
  }
  
  return null;
}

// ========== DÃ‰TECTION PRIX DUPLIQUÃ‰S V11.0.6 ==========
function markUnchangedPrices(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  
  if(!client || !year) return;
  
  const prevYear = (parseInt(year, 10) - 1).toString();
  const prevKey = 'grille_' + client + '_' + prevYear;
  const prevDataStr = localStorage.getItem(prevKey);
  
  if(!prevDataStr) {
    // Supprimer toutes les classes unchanged
    document.querySelectorAll('.price-unchanged').forEach(el => {
      el.classList.remove('price-unchanged');
    });
    return;
  }
  
  try {
    const prevData = JSON.parse(prevDataStr);
    
    // Pour chaque tableau
    tables.forEach(table => {
      const prevTable = prevData.tables ? prevData.tables[table.id] : null;
      if(!prevTable) return;
      
      const tableElement = document.getElementById(table.id + 'Table');
      if(!tableElement) return;
      
      const rows = tableElement.querySelectorAll('tbody tr');
      
      rows.forEach(tr => {
        const destName = (tr.querySelector('.dest-name')?.value || "").trim();
        const trajetSel = tr.querySelector('.trajet-select');
        const trajetVal = trajetSel?.value || "";
        
        // Trouver ligne prÃ©cÃ©dente (mÃªme dest + trajet)
        const prevRow = (prevTable.rows || []).find(r => 
          r.dest === destName && r.trajet === trajetVal
        );
        
        if(!prevRow) return;
        
        // Comparer prix HT
        VEHICULES.forEach(catKey => {
          const htInput = tr.querySelector('.group-' + catKey + '.col-ht .price-input');
          const ttcInput = tr.querySelector('.group-' + catKey + '.col-ttc .ttc-input');
          
          if(!htInput) return;
          
          const currentPrice = parseFloat(htInput.value) || 0;
          const prevPrice = (prevRow.tarifs && prevRow.tarifs[catKey]) || 0;
          
          if(currentPrice > 0 && currentPrice === prevPrice){
            htInput.classList.add('price-unchanged');
            if(ttcInput) ttcInput.classList.add('price-unchanged');
          } else {
            htInput.classList.remove('price-unchanged');
            if(ttcInput) ttcInput.classList.remove('price-unchanged');
          }
        });
      });
    });
  } catch(e){
    console.error('Erreur markUnchangedPrices:', e);
  }
}

// ========== Ã‰VOLUTIONS ==========
async function computeEvolutions(){
  const prev = await loadPreviousYearPayload();
  document.querySelectorAll(".evol-cell").forEach(td => {
    td.textContent = "";
    td.classList.remove("evol-pos","evol-neg");
  });
  
  // VÃ©rifier format (ancien ou nouveau)
  const hasOldFormat = prev && Array.isArray(prev.rows);
  const hasNewFormat = prev && prev.tables && typeof prev.tables === 'object';
  
  if(!hasOldFormat && !hasNewFormat){
    const y = getCurrentYear();
    const c = getCurrentClient() || "CFMM";
    if(y){
      setStatus("Aucune Ã©volution calculÃ©e : aucune sauvegarde trouvÃ©e pour le client Â« " + c + " Â» en " + (parseInt(y,10)-1) + ".", false);
    }
    return;
  }

  // Construire la map des prix de l'annÃ©e prÃ©cÃ©dente
  const prevMap = {};
  
  if(hasOldFormat){
    // Ancien format
    prev.rows.forEach(r => {
      const dest = (r.dest || "").trim().toLowerCase().replace(/\s+/g, " ");
      const trajet = (r.trajet || "").trim().toLowerCase();
      VEHICULES.forEach(cat => {
        const val = r.tarifs && typeof r.tarifs[cat] === "number" ? r.tarifs[cat] : null;
        if(val != null){
          const key = dest + "|" + trajet + "|" + cat;
          prevMap[key] = val;
        }
      });
    });
  } else {
    // Nouveau format v11.0.6 - INCLURE tableId dans la clÃ©
    Object.entries(prev.tables).forEach(([tableId, tableData]) => {
      if(Array.isArray(tableData.rows)){
        tableData.rows.forEach(r => {
          const dest = (r.dest || "").trim().toLowerCase().replace(/\s+/g, " ");
          const trajet = (r.trajet || "").trim().toLowerCase();
          VEHICULES.forEach(cat => {
            const val = r.tarifs && typeof r.tarifs[cat] === "number" ? r.tarifs[cat] : null;
            if(val != null){
              const key = tableId + "|" + dest + "|" + trajet + "|" + cat; // V11.0.6 - Ajout tableId
              prevMap[key] = val;
            }
          });
        });
      }
    });
  }

  // Calculer les Ã©volutions pour TOUS les tableaux V11.0.6
  tables.forEach(table => {
    const allRows = document.querySelectorAll(`#${table.id}Table tbody tr`);
    allRows.forEach(tr => {
      const destName = (tr.querySelector(".dest-name")?.value || "").trim().toLowerCase().replace(/\s+/g, " ");
      const trajetSel = tr.querySelector(".trajet-select");
      const trajetVal = (trajetSel?.value || "").trim().toLowerCase();
      VEHICULES.forEach(cat => {
        const htInput = tr.querySelector(".group-" + cat + ".col-ht .price-input");
        const evolCell = tr.querySelector(".group-" + cat + ".col-evol");
        if(!htInput || !evolCell) return;
        const ht = parseNumberFR(htInput.value);
        const key = table.id + "|" + destName + "|" + trajetVal + "|" + cat; // V11.0.6 - Inclure table.id
        const prevVal = prevMap[key];
        if(!isFinite(ht) || prevVal == null || !isFinite(prevVal) || prevVal === 0){
          evolCell.textContent = "";
          return;
        }
        const evol = (ht - prevVal) / prevVal * 100;
        const arrow = evol >= 0 ? "â–²" : "â–¼";
        const value = Math.abs(evol);
        const txt = arrow + " " + formatNumberFR(value,1) + " %";
        evolCell.classList.remove("evol-pos","evol-neg");
        evolCell.classList.add(evol >= 0 ? "evol-pos" : "evol-neg");
        evolCell.textContent = txt;
      });
    });
  });
}

// BUGFIX V11.0.22: Wrapper pour appels async de computeEvolutions
function triggerComputeEvolutions(){
  computeEvolutions().then(() => markUnchangedPrices()).catch(err => {
    console.error('âŒ Erreur calcul Ã©volutions:', err);
  });
}

function refreshDestinationSuggestions(){
  const datalist = document.getElementById("destinationsList");
  if(!datalist) return;
  const namesSet = new Set();
  document.querySelectorAll(".dest-name").forEach(inp => {
    const v = (inp.value || "").trim();
    if(v.length >= 2) namesSet.add(v);
  });
  datalist.innerHTML = "";
  Array.from(namesSet).sort((a,b)=>a.localeCompare(b,"fr")).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    datalist.appendChild(opt);
  });
}

// ============================================================================
// BUGFIX V11.0.21 P0 #3: DÃ©tection doublons destinations (ignorer accents)
// ============================================================================
function checkDuplicateDestinations(){
  // Parcourir TOUS les tableaux
  const allDestInputs = document.querySelectorAll('.dest-name');
  const destMap = new Map(); // key = destination normalisÃ©e, value = array de rows
  
  // 1. Construire la map des destinations
  allDestInputs.forEach(input => {
    const destRaw = (input.value || '').trim();
    if(!destRaw) return; // Ignorer vides
    
    const destNormalized = normalizeText(destRaw);
    if(!destMap.has(destNormalized)){
      destMap.set(destNormalized, []);
    }
    destMap.get(destNormalized).push(input.closest('tr'));
  });
  
  // 2. Retirer tous les fonds jaunes
  allDestInputs.forEach(input => {
    input.style.background = '';
  });
  
  // 3. Appliquer fond jaune aux doublons
  destMap.forEach((rows, destNormalized) => {
    if(rows.length > 1){
      // C'est un doublon !
      rows.forEach(tr => {
        const input = tr.querySelector('.dest-name');
        if(input){
          input.style.background = '#fff9c4'; // Jaune clair
          input.title = `âš ï¸ Destination en double : ${rows.length} fois`;
        }
      });
    }
  });
}

// ========== Ã‰DITEUR CATÃ‰GORIES V10.10.0 ==========
function renderVehicleCategoriesEditor(){
  // v11.0.6 - DÃ©sactivÃ© : utiliser popup modale
  // Container supprimÃ©, bouton "Ã‰diter" utilisÃ© Ã  la place
}

function updateTableHeaders(){
  // Mettre Ã  jour les headers avec les nouveaux noms
  document.querySelectorAll('th.group-VL:not(.col-no):not(.col-evol)').forEach(th => {
    if(th.classList.contains('col-ht')){
      th.textContent = currentCategories.VL.name + ' HT';
    } else if(th.classList.contains('col-ttc')){
      th.textContent = currentCategories.VL.name + ' TTC';
    }
  });
  
  document.querySelectorAll('th.group-MC22:not(.col-no):not(.col-evol)').forEach(th => {
    if(th.classList.contains('col-ht')){
      th.textContent = currentCategories.MC22.name + ' HT';
    } else if(th.classList.contains('col-ttc')){
      th.textContent = currentCategories.MC22.name + ' TTC';
    }
  });
  
  document.querySelectorAll('th.group-MC33:not(.col-no):not(.col-evol)').forEach(th => {
    if(th.classList.contains('col-ht')){
      th.textContent = currentCategories.MC33.name + ' HT';
    } else if(th.classList.contains('col-ttc')){
      th.textContent = currentCategories.MC33.name + ' TTC';
    }
  });
  
  document.querySelectorAll('th.group-AC55:not(.col-no):not(.col-evol)').forEach(th => {
    if(th.classList.contains('col-ht')){
      th.textContent = currentCategories.AC55.name + ' HT';
    } else if(th.classList.contains('col-ttc')){
      th.textContent = currentCategories.AC55.name + ' TTC';
    }
  });
  
  document.querySelectorAll('th.group-AC64:not(.col-no):not(.col-evol)').forEach(th => {
    if(th.classList.contains('col-ht')){
      th.textContent = currentCategories.AC64.name + ' HT';
    } else if(th.classList.contains('col-ttc')){
      th.textContent = currentCategories.AC64.name + ' TTC';
    }
  });
}

// ========== POPUP Ã‰DITION CATÃ‰GORIES V11.0.6 ==========
let categoriesBackup = null;

function openCategoriesModal(){
  const modal = document.getElementById('categoriesModal');
  const tbody = document.getElementById('categoriesEditTable');
  const title = document.getElementById('categoriesModalTitle');
  
  // Sauvegarder Ã©tat actuel
  categoriesBackup = JSON.parse(JSON.stringify(currentCategories));
  
  // Titre avec client/annÃ©e
  const client = getCurrentClient();
  const year = getCurrentYear();
  title.textContent = `Ã‰diter les catÃ©gories - ${client} ${year}`;
  
  // GÃ©nÃ©rer lignes
  tbody.innerHTML = '';
  VEHICULES.forEach(catKey => {
    const cat = currentCategories[catKey];
    
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #e2e8f0';
    
    tr.innerHTML = `
      <td style="padding:12px 8px; text-align:center;">
        <input type="checkbox" class="cat-visible-check" data-cat="${catKey}" ${cat.visible ? 'checked' : ''} 
               style="width:18px; height:18px; cursor:pointer;">
      </td>
      <td style="padding:12px 8px;">
        <input type="text" class="cat-name-edit" data-cat="${catKey}" value="${cat.name}"
               style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:0.95rem;">
      </td>
      <td style="padding:12px 8px;">
        <input type="text" class="cat-capacity-edit" data-cat="${catKey}" value="${cat.capacity}"
               style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:0.95rem;">
      </td>
    `;
    
    tbody.appendChild(tr);
  });
  
  modal.style.display = 'block';
}

function closeCategoriesModal(){
  const modal = document.getElementById('categoriesModal');
  
  // Demander confirmation si changements
  const hasChanges = JSON.stringify(currentCategories) !== JSON.stringify(categoriesBackup);
  if(hasChanges){
    if(!confirm('Fermer sans sauvegarder ? Les modifications seront perdues.')){
      return;
    }
    // Restaurer backup
    currentCategories = categoriesBackup;
  }
  
  modal.style.display = 'none';
  categoriesBackup = null;
}

function saveCategoriesEdits(){
  const modal = document.getElementById('categoriesModal');
  
  // Lire valeurs
  document.querySelectorAll('.cat-visible-check').forEach(cb => {
    currentCategories[cb.dataset.cat].visible = cb.checked;
  });
  
  document.querySelectorAll('.cat-name-edit').forEach(input => {
    const val = input.value.trim();
    if(val){
      currentCategories[input.dataset.cat].name = val;
    }
  });
  
  document.querySelectorAll('.cat-capacity-edit').forEach(input => {
    const val = input.value.trim();
    if(val){
      currentCategories[input.dataset.cat].capacity = val;
    }
  });
  
  // Appliquer changements
  applyColumnVisibility();
  updateTableHeaders();
  
  // Sauvegarder
  saveGrid();
  
  setStatus('CatÃ©gories mises Ã  jour', false);
  
  modal.style.display = 'none';
  categoriesBackup = null;
}

// ========== FIN Ã‰DITEUR CATÃ‰GORIES ==========

// ========== IMPRESSION AVANCÃ‰E V11.0 ==========
function showPrintModal(){
  const modal = document.getElementById('printModal');
  
  // GÃ©nÃ©rer checkboxes catÃ©gories
  const catContainer = document.getElementById('printCategoriesCheckboxes');
  catContainer.innerHTML = '';
  VEHICULES.forEach(catKey => {
    const cat = currentCategories[catKey];
    const label = document.createElement('label');
    label.style.cssText = 'display:block; margin:5px 0; cursor:pointer;';
    label.innerHTML = `<input type="checkbox" class="print-cat" data-cat="${catKey}" checked> ${cat.name}`;
    catContainer.appendChild(label);
  });
  
  // GÃ©nÃ©rer checkboxes tableaux
  const tablesContainer = document.getElementById('printTablesCheckboxes');
  tablesContainer.innerHTML = '';
  tables.forEach(table => {
    const label = document.createElement('label');
    label.style.cssText = 'display:block; margin:5px 0; cursor:pointer;';
    label.innerHTML = `<input type="checkbox" class="print-table" data-table="${table.id}" checked> ${table.icon} ${table.name}`;
    tablesContainer.appendChild(label);
  });
  
  modal.style.display = 'flex';
}

function generatePrintView(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  
  // RÃ©cupÃ©rer options
  const opts = {
    logo: document.getElementById('printLogo').checked,
    title: document.getElementById('printTitle').checked,
    clientYear: document.getElementById('printClientYear').checked,
    date: document.getElementById('printDate').checked,
    destination: document.getElementById('printDestination').checked,
    trajet: document.getElementById('printTrajet').checked,
    facture: document.getElementById('printFacture').checked,
    notes: document.getElementById('printNotes').checked,
    majorations: document.getElementById('printMajorations').checked,
    evolutions: document.getElementById('printEvolutions').checked,
    format: document.getElementById('printFormat').value,
    fontSize: document.getElementById('printFontSize').value + 'pt',
    compact: document.getElementById('printCompact').checked,
    colors: document.getElementById('printColors').checked,
    categories: [],
    tables: []
  };
  
  // CatÃ©gories sÃ©lectionnÃ©es
  document.querySelectorAll('.print-cat:checked').forEach(cb => {
    opts.categories.push(cb.dataset.cat);
  });
  
  // Tableaux sÃ©lectionnÃ©s
  document.querySelectorAll('.print-table:checked').forEach(cb => {
    opts.tables.push(cb.dataset.table);
  });
  
  // GÃ©nÃ©rer HTML impression
  let html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Grille ${client} ${year}</title>
  <style>
    /* Reset et base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    @page { 
      size: ${opts.format === 'a3-landscape' ? 'A3 landscape' : opts.format === 'a4-landscape' ? 'A4 landscape' : 'A4 portrait'}; 
      margin: ${opts.compact ? '8mm' : '12mm'}; 
    }
    
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      font-size: ${opts.fontSize};
      color: #000;
      line-height: 1.4;
      background: white;
    }
    
    
/* Header restructurÃ© V11.0.26 */
header {
  background: white;
  border-bottom: 2px solid var(--border);
  padding: 16px 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.header-bar {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 24px;
  max-width: 1800px;
  margin: 0 auto;
}

.header-left {
  display: flex;
  flex-direction: column;
  gap: 4px;
  justify-self: start;
}

.header-center {
  display: flex;
  justify-content: center;
}

.header-right {
  display: flex;
  flex-direction: column;
  gap: 12px;
  justify-self: end;
  align-items: flex-end;
}

.title-main {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  letter-spacing: -0.02em;
}

.title-sub {
  font-size: 1rem;
  color: var(--muted);
  font-weight: 500;
}

.header-logo img {
  max-width: 280px;
  max-height: 120px;
  object-fit: contain;
}

.selectors {
  display: flex;
  gap: 8px;
  align-items: center;
}

.button-row {
  display: flex;
  gap: 6px;
  align-items: center;
  justify-content: flex-end;
}

    .header { 
      text-align: center; 
      margin-bottom: 25px; 
      border-bottom: 4px solid ${opts.colors ? '#428bca' : '#333'};
      padding-bottom: 20px;
      page-break-after: avoid;
    }
    .header .logo {
      font-size: 2.5em; 
      margin-bottom: 15px;
      letter-spacing: 2px;
      font-weight: bold;
    }
    .header h1 { 
      margin: 15px 0; 
      color: ${opts.colors ? '#428bca' : '#333'}; 
      font-size: ${parseInt(opts.fontSize) * 2.2}px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .header .client-info {
      font-size: ${parseInt(opts.fontSize) * 1.3}px;
      margin: 12px 0;
      font-weight: 600;
      color: #333;
    }
    .header .print-date {
      color: #666;
      font-size: ${parseInt(opts.fontSize) * 0.95}px;
      margin-top: 10px;
    }
    
    /* Tableaux */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 25px;
      font-size: ${opts.fontSize};
      page-break-inside: avoid;
    }
    
    thead {
      display: table-header-group;
    }
    
    tbody {
      display: table-row-group;
    }
    
    th { 
      background: ${opts.colors ? 'linear-gradient(180deg, #5a9fd4 0%, #428bca 100%)' : '#e0e0e0'}; 
      color: ${opts.colors ? 'white' : '#000'}; 
      padding: ${opts.compact ? '8px 6px' : '12px 10px'}; 
      border: 1px solid ${opts.colors ? '#3a7cb8' : '#999'};
      font-weight: 700;
      text-align: center;
      font-size: ${parseInt(opts.fontSize) * 0.95}px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    td { 
      padding: ${opts.compact ? '6px 5px' : '10px 8px'}; 
      border: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
    }
    
    tr:nth-child(even) {
      background: ${opts.colors ? '#f8f9fa' : '#fafafa'};
    }
    
    tr:hover {
      background: ${opts.colors ? '#e9f5ff' : '#f0f0f0'};
    }
    
    /* Titre tableau */
    .table-title {
      font-size: ${parseInt(opts.fontSize) * 1.6}px;
      font-weight: 700;
      margin: 30px 0 15px 0;
      color: ${opts.colors ? '#428bca' : '#333'};
      border-bottom: 3px solid ${opts.colors ? '#428bca' : '#333'};
      padding-bottom: 8px;
      page-break-after: avoid;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    /* Majorations */
    .majorations {
      background: ${opts.colors ? 'linear-gradient(135deg, #fffef0 0%, #fff9e6 100%)' : '#f5f5f5'};
      padding: 20px;
      border-left: 5px solid ${opts.colors ? '#ffc107' : '#999'};
      border-radius: 4px;
      margin: 25px 0;
      white-space: pre-wrap;
      font-size: ${parseInt(opts.fontSize) * 0.95}px;
      line-height: 1.6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .majorations strong {
      display: block;
      margin-bottom: 10px;
      font-size: ${parseInt(opts.fontSize) * 1.1}px;
      color: ${opts.colors ? '#d19000' : '#333'};
    }
    
    /* Colonne destination */
    .destination-col { 
      font-weight: 700;
      text-align: left;
      padding-left: 10px;
      color: #000;
    }
    
    /* Impression */
    @media print {
      body { 
        print-color-adjust: exact; 
        -webkit-print-color-adjust: exact;
      }
      
      /* Masquer headers/footers navigateur */
      @page {
        margin-top: 8mm;
        margin-bottom: 8mm;
      }
      
      /* Ã‰viter coupures */
      .header, .table-title, .majorations {
        page-break-inside: avoid;
        page-break-after: avoid;
      }
      
      table {
        page-break-inside: auto;
      }
      
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      thead {
        display: table-header-group;
      }
      
      /* Masquer URL et autres infos navigateur */
      a[href]:after {
        content: none !important;
      }
    }
    
    /* Optimisations visuelles V11.0.2 */
    .price-ht {
      background: ${opts.colors ? 'linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%)' : '#f5f5f5'} !important;
      color: ${opts.colors ? '#1b5e20' : '#000'};
      font-weight: 700;
      text-align: center;
      padding: 10px 8px !important;
    }
    
    .price-ttc {
      background: ${opts.colors ? 'linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%)' : '#f5f5f5'} !important;
      color: ${opts.colors ? '#0d47a1' : '#000'};
      font-weight: 700;
      text-align: center;
      padding: 10px 8px !important;
    }
    
    /* Footer professionnel (optionnel) */
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      text-align: center;
      font-size: ${parseInt(opts.fontSize) * 0.8}px;
      color: #666;
      padding: 10px;
      border-top: 1px solid #ddd;
      background: white;
    }
  
/* Tooltip destination au survol */
td.dest input:hover::after {
  content: attr(value);
  position: absolute;
  left: 0;
  top: 100%;
  background: rgba(0,0,0,0.9);
  color: white;
  padding: 8px 12px;
  border-radius: 4px;
  white-space: nowrap;
  z-index: 1000;
  font-size: 0.85rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  pointer-events: none;
}

</style>
</head>
<body>
`;
  
  // En-tÃªte
  if(opts.logo || opts.title || opts.clientYear || opts.date){
    html += '<div class="header">';
    if(opts.logo) html += '<div class="logo">ğŸš AUTOCARS BALLANFAT</div>';
    if(opts.title) html += '<h1>Grille Tarifaire</h1>';
    if(opts.clientYear) html += `<div class="client-info">${client} â€¢ ${year}</div>`;
    if(opts.date) html += `<div class="print-date">ImprimÃ© le ${new Date().toLocaleDateString('fr-FR', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div>`;
    html += '</div>';
  }
  
  // Majorations
  if(opts.majorations){
    const majorationsText = document.getElementById('conditionsText')?.value || '';
    if(majorationsText){
      html += `<div class="majorations"><strong>ğŸ“‹ Conditions et Majorations</strong>${majorationsText}</div>`;
    }
  }
  
  // Tableaux
  opts.tables.forEach(tableId => {
    const table = tables.find(t => t.id === tableId);
    if(!table) return;
    
    const tableElem = document.querySelector(`#${tableId}Table`);
    if(!tableElem) return;
    
    html += `<div class="table-title">${table.icon} ${table.name}</div>`;
    html += '<table>';
    
    // Headers
    html += '<thead><tr>';
    if(opts.destination) html += '<th>Destination</th>';
    if(opts.trajet) html += '<th>Trajet</th>';
    
    opts.categories.forEach(catKey => {
      const cat = currentCategories[catKey];
      if(opts.facture) html += `<th>NÂ° ${cat.name}</th>`;
      html += `<th>${cat.name} HT</th>`;
      html += `<th>${cat.name} TTC</th>`;
      if(opts.evolutions) html += `<th>Ã‰vol. %</th>`;
    });
    
    if(opts.notes) html += '<th>Note</th>';
    html += '</tr></thead><tbody>';
    
    // DonnÃ©es
    const rows = tableElem.querySelectorAll('tbody tr');
    rows.forEach(tr => {
      if(tr.style.display === 'none') return;
      
      html += '<tr>';
      
      if(opts.destination){
        const dest = tr.querySelector('.dest-name')?.value || '';
        html += `<td class="destination-col">${dest}</td>`;
      }
      
      if(opts.trajet){
        const trajetSel = tr.querySelector('.trajet-select');
        const trajetText = trajetSel ? trajetSel.options[trajetSel.selectedIndex].text : '';
        html += `<td>${trajetText}</td>`;
      }
      
      opts.categories.forEach(catKey => {
        if(opts.facture){
          const factureInputs = tr.querySelectorAll('.facture-input');
          let factureVal = '';
          factureInputs.forEach(inp => {
            if(inp.closest('td').classList.contains('group-' + catKey)){
              factureVal = inp.value || '';
            }
          });
          html += `<td>${factureVal}</td>`;
        }
        
        // HT
        const htInputs = tr.querySelectorAll('.price-input');
        let htVal = '';
        htInputs.forEach(inp => {
          if(inp.dataset.key && inp.dataset.key.includes(catKey + '|HT')){
            htVal = inp.value || '';
          }
        });
        html += `<td class="price-ht">${htVal ? htVal + ' â‚¬' : ''}</td>`;
        
        // TTC
        const ttcInputs = tr.querySelectorAll('.ttc-input');
        let ttcVal = '';
        ttcInputs.forEach(inp => {
          if(inp.dataset.key && inp.dataset.key.includes(catKey + '|TTC')){
            ttcVal = inp.value || '';
          }
        });
        html += `<td class="price-ttc">${ttcVal ? ttcVal + ' â‚¬' : ''}</td>`;
        
        // Ã‰vol
        if(opts.evolutions){
          const evolCells = tr.querySelectorAll('.evol-cell');
          let evolVal = '';
          evolCells.forEach(cell => {
            if(cell.classList.contains('group-' + catKey)){
              evolVal = cell.textContent.trim();
            }
          });
          html += `<td>${evolVal}</td>`;
        }
      });
      
      if(opts.notes){
        const note = tr.querySelector('.note-input')?.value || '';
        html += `<td>${note}</td>`;
      }
      
      html += '</tr>';
    });
    
    html += '</tbody></table>';
  });
  
  html += '</body></html" alt="Logo Ballanfat" class="logo-center-v26">
      </div>

      <!-- DROITE: ContrÃ´les -->
      <div class="header-right-v26">
        <label class="control-label-v26">
          Client :
          <select id="selectClient" class="control-select-v26">
            <option value="CFMM">CFMM</option>
            <option value="Association_OVAL">Association OVAL</option>
            <option value="Ginkgo_Evenement">Ginkgo Ã‰vÃ©nement</option>
            <option value="Centre_La_Ruche">Centre La Ruche</option>
          </select>
        </label>
        
        <label class="control-label-v26">
          AnnÃ©e :
          <select id="selectYear" class="control-select-v26">
            <option value="2025">2025</option>
            <option value="2024">2024</option>
          </select>
        </label>

        <button id="btnReorderClients" type="button" class="btn-v26" title="RÃ©organiser l'ordre des clients">
          â†•ï¸ RÃ©organiser
        </button>

        <button id="btnHistory" type="button" class="btn-v26">
          ğŸ“œ Historique (<span id="versionCount">0</span>)
        </button>

        <button id="btnPrintAdvanced" type="button" class="btn-v26">
          ğŸ–¨ Imprimer
        </button>

        <button id="btnToggleFactures" type="button" class="btn-v26" title="Afficher/masquer NÂ° Facture">
          ğŸ”¢ NÂ° Factures
        </button>

        <button id="btnParamsToggle" type="button" class="btn-v26">
          âš™ ParamÃ¨tres
        </button>

        <button id="btnSave" type="button" class="btn-v26 btn-primary-v26">
          ğŸ’¾ Enregistrer
        </button>

        <a href="import-factures-v2.html" class="btn-v26" style="text-decoration:none;">
          ğŸ“„ Import Factures
        </a>
      </div>
    </div>
  </header>

  <input type="file" id="importFileInput" accept=".json" style="display:none;">

  <!-- Popup Historique Versions V10.9.0 -->
  <div id="versionsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:8px; max-width:800px; max-height:80vh; overflow:auto; padding:30px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">ğŸ• Historique des versions</h2>
        <button id="btnCloseVersions" type="button" style="border:none; background:#f44336; color:white; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:bold;">âœ• Fermer</button>
      </div>
      <p class="muted">Liste des 50 derniÃ¨res sauvegardes. Cliquez pour restaurer une version.</p>
      <div id="versionsList" style="max-height:500px; overflow-y:auto;">
        <!-- Liste gÃ©nÃ©rÃ©e dynamiquement -->
      </div>
    </div>
  </div>

  <!-- Popup Impression AvancÃ©e V11.0 -->
  <div id="printModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:8px; max-width:900px; max-height:85vh; overflow:auto; padding:30px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">ğŸ–¨ï¸ Options d'impression</h2>
        <button id="btnClosePrint" type="button" style="border:none; background:#f44336; color:white; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:bold;">âœ• Fermer</button>
      </div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
        <!-- Colonne gauche : Options -->
        <div>
          <h3 style="margin-top:0; color:#428bca;">ğŸ“‹ Contenu Ã  imprimer</h3>
          
          <div style="margin-bottom:20px;">
            <strong>En-tÃªte</strong>
            <div style="margin-left:20px;">
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printLogo" checked> Logo entreprise
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printTitle" checked> Titre grille
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printClientYear" checked> Client / AnnÃ©e
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printDate" checked> Date impression
              </label>
            </div>
          </div>
          
          <div style="margin-bottom:20px;">
            <strong>Colonnes donnÃ©es</strong>
            <div style="margin-left:20px;">
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printDestination" checked> Destination
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printTrajet" checked> Trajet
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printFacture"> NÂ° Facture
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printNotes"> Notes
              </label>
            </div>
          </div>
          
          <div style="margin-bottom:20px;">
            <strong>CatÃ©gories vÃ©hicules</strong>
            <div style="margin-left:20px;" id="printCategoriesCheckboxes">
              <!-- GÃ©nÃ©rÃ© dynamiquement -->
            </div>
          </div>
          
          <div style="margin-bottom:20px;">
            <strong>Tableaux</strong>
            <div style="margin-left:20px;" id="printTablesCheckboxes">
              <!-- GÃ©nÃ©rÃ© dynamiquement -->
            </div>
          </div>
          
          <div>
            <strong>Autres</strong>
            <div style="margin-left:20px;">
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printMajorations" checked> Majorations
              </label>
              <label style="display:block; margin:5px 0; cursor:pointer;">
                <input type="checkbox" id="printEvolutions"> Ã‰volutions prix
              </label>
            </div>
          </div>
        </div>
        
        <!-- Colonne droite : Mise en page -->
        <div>
          <h3 style="margin-top:0; color:#428bca;">ğŸ“„ Mise en page</h3>
          
          <div style="margin-bottom:15px;">
            <label>
              <strong>Format :</strong><br>
              <select id="printFormat" style="width:100%; padding:8px; margin-top:5px;">
                <option value="a4-portrait">A4 Portrait</option>
                <option value="a4-landscape" selected>A4 Paysage</option>
                <option value="a3-landscape">A3 Paysage</option>
              </select>
            </label>
          </div>
          
          <div style="margin-bottom:15px;">
            <label>
              <strong>Taille police :</strong><br>
              <select id="printFontSize" style="width:100%; padding:8px; margin-top:5px;">
                <option value="8">TrÃ¨s petite (8pt)</option>
                <option value="10" selected>Petite (10pt)</option>
                <option value="12">Moyenne (12pt)</option>
                <option value="14">Grande (14pt)</option>
              </select>
            </label>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block; margin:5px 0; cursor:pointer;">
              <input type="checkbox" id="printCompact" checked> Mode compact
            </label>
            <small class="muted">RÃ©duit les marges pour plus de contenu</small>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block; margin:5px 0; cursor:pointer;">
              <input type="checkbox" id="printColors" checked> Couleurs
            </label>
            <small class="muted">DÃ©cocher pour impression noir & blanc</small>
          </div>
          
          <div style="margin-top:30px; padding:20px; background:#f0f8ff; border-radius:6px; border:2px solid #428bca;">
            <div style="text-align:center; margin-bottom:10px;">
              <strong style="color:#428bca;">ğŸ“± AperÃ§u adaptatif</strong>
            </div>
            <p class="muted" style="margin:5px 0; font-size:0.85rem;">
              La mise en page s'adaptera automatiquement au contenu sÃ©lectionnÃ© pour une lisibilitÃ© optimale.
            </p>
          </div>
        </div>
      </div>
      
      <div style="margin-top:30px; padding-top:20px; border-top:2px solid #ddd; text-align:center;">
        <button id="btnGeneratePrint" type="button" class="btn btn-primary" style="font-size:1.1rem; padding:12px 30px;">
          ğŸ–¨ï¸ GÃ©nÃ©rer l'aperÃ§u et imprimer
        </button>
      </div>
    </div>
  </div>

  <div class="card" id="paramsCard">
    <div class="params-toggle" id="paramsToggleArea">
      <span class="btn-icon">âš™</span>
      <span>ParamÃ¨tres avancÃ©s</span>
    </div>
    <div class="params-panel" id="paramsPanel">
      
      <!-- Section 1 : Configuration gÃ©nÃ©rale -->
      <div class="params-section">
        <h3 class="params-section-title">âš™ï¸ Configuration gÃ©nÃ©rale</h3>
        <div class="params-row">
          <label>TVA (%) :
            <input type="number" id="tvaInput" value="10" step="0.1" min="0" max="100">
          </label>
        </div>
        <div class="params-row">
          <label>Tri des destinations :
            <select id="sortDestinations">
              <option value="freqDesc">FrÃ©quence (plus frÃ©quent en haut)</option>
              <option value="alphaAsc">Nom A â†’ Z</option>
              <option value="alphaDesc">Nom Z â†’ A</option>
              <option value="original">Ordre d'origine</option>
            </select>
          </label>
        </div>
      </div>
      
      <!-- Section 2 : Sauvegarde & Export -->
      <div class="params-section">
        <h3 class="params-section-title">ğŸ’¾ Sauvegarde & Export</h3>
        <div class="params-row">
          <button id="btnGoogleDrive" type="button" class="btn btn-primary">
            <span class="btn-icon">â˜ï¸</span><span>Connecter Google Drive</span>
          </button>
          <span class="muted">Sauvegarde automatique sur votre Drive</span>
        </div>
        <div class="params-row">
          <button id="btnVersions" type="button" class="btn">
            <span class="btn-icon">ğŸ•</span><span>Historique des versions</span>
          </button>
          <span class="muted">50 derniÃ¨res sauvegardes</span>
        </div>
        <div class="params-row">
          <button id="btnExportJSON" type="button" class="btn">
            <span class="btn-icon">ğŸ“¥</span><span>Exporter JSON</span>
          </button>
          <button id="btnSaveAsJSON" type="button" class="btn">
            <span class="btn-icon">ğŸ’¾</span><span>Enregistrer sous...</span>
          </button>
          <button id="btnImportJSON" type="button" class="btn">
            <span class="btn-icon">ğŸ“¤</span><span>Importer JSON</span>
          </button>
        </div>
        <div class="params-row">
          <button id="btnExportCSV" type="button" class="btn">
            <span class="btn-icon">ğŸ“Š</span><span>Exporter CSV</span>
          </button>
          <button id="btnExportAll" type="button" class="btn">
            <span class="btn-icon">ğŸ“¦</span><span>Exporter TOUT</span>
          </button>
          <span class="muted">Tous clients/annÃ©es</span>
        </div>
      </div>
      
      
      <!-- Section 3 : CatÃ©gories de vÃ©hicules -->
      <div class="params-section">
        <h3 class="params-section-title">ğŸš— CatÃ©gories de vÃ©hicules</h3>
        <p class="muted" style="margin-bottom:10px;">Personnaliser les noms et capacitÃ©s par client/annÃ©e.</p>
        
        <div style="display:grid; grid-template-columns: auto 1fr 1fr; gap:8px; align-items:center;">
          <strong>Visible</strong>
          <strong>Nom</strong>
          <strong>CapacitÃ©</strong>
        </div>
        
        <div class="params-row" style="margin-top:10px;">
          <button id="btnEditCategories" type="button" class="btn">
            <span class="btn-icon">âœï¸</span><span>Ã‰diter les catÃ©gories</span>
          </button>
        </div>
        
        <div class="params-row" style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
          <label style="cursor: pointer;">
            <input type="checkbox" id="toggleFactureColumns" checked>
            <strong>Afficher colonnes "NÂ° Facture"</strong>
          </label>
        </div>
      </div>
      
      <!-- Section 5 : Gestion clients/annÃ©es -->
      <div class="params-section">
        <h3 class="params-section-title">ğŸ‘¥ Clients & AnnÃ©es</h3>
        <div class="params-row">
          <strong>Clients :</strong>
          <button id="btnRenameClient" type="button" class="btn">
            <span class="btn-icon">âœï¸</span><span>Renommer</span>
          </button>
          <button id="btnDeleteClient" type="button" class="btn btn-ghost">Supprimer</button>
        </div>
        <div class="params-row">
          <strong>AnnÃ©es :</strong>
          <button id="btnDuplicateYear" type="button" class="btn">
            <span class="btn-icon">ğŸ“‹</span><span>Dupliquer</span>
          </button>
          <button id="btnDeleteYear" type="button" class="btn btn-ghost">Supprimer</button>
        </div>
      </div>
      
      <!-- Section 6 : Gestion tableaux -->
      <div class="params-section">
        <h3 class="params-section-title">ğŸ“Š Tableaux personnalisÃ©s</h3>
        <div id="tablesManager" class="tables-manager"></div>
        <div class="params-row">
          <button id="btnCreateTable" type="button" class="btn" onclick="createTable()">
            <span class="btn-icon">â•</span><span>CrÃ©er tableau</span>
          </button>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Modal Ã‰dition CatÃ©gories v11.0.6 -->
<div id="categoriesModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:10001; background:rgba(0,0,0,0.5);">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.3); max-width:700px; width:90%; max-height:80vh; overflow:auto;">
    <div style="padding:25px;">
      <h2 style="margin:0 0 20px 0; color:#1e3a8a; display:flex; align-items:center; gap:10px;">
        <span>âœï¸</span>
        <span id="categoriesModalTitle">Ã‰diter les catÃ©gories</span>
      </h2>
      
      <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
        <thead>
          <tr style="background:#f8fafc; border-bottom:2px solid #e2e8f0;">
            <th style="padding:12px 8px; text-align:center; width:80px;">Visible</th>
            <th style="padding:12px 8px; text-align:left;">Nom catÃ©gorie</th>
            <th style="padding:12px 8px; text-align:left; width:150px;">CapacitÃ©</th>
          </tr>
        </thead>
        <tbody id="categoriesEditTable">
          <!-- GÃ©nÃ©rÃ© dynamiquement -->
        </tbody>
      </table>
      
      <div style="display:flex; gap:10px; justify-content:flex-end; padding-top:15px; border-top:1px solid #ddd;">
        <button type="button" class="btn btn-ghost" onclick="closeCategoriesModal()">Annuler</button>
        <button type="button" class="btn" onclick="saveCategoriesEdits()">
          <span class="btn-icon">ğŸ’¾</span><span>Sauvegarder</span>
        </button>
      </div>
    </div>
  </div>
</div>

  <!-- BUGFIX V11.0.16: Barre de recherche globale (tous tableaux) -->
  <div class="card card-recherche card-fixed" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-left: 4px solid #1976d2;">
    <h3 style="margin-top: 0; color: #1976d2;">ğŸ” Recherche globale</h3>
    <div class="sort-controls">
      <label style="flex: 1;">
        <input type="text" id="searchInput" class="note-input search-input" 
               placeholder="Rechercher dans tous les tableaux (destination, trajet, note...)..."
               style="width: 100%; font-size: 1rem; padding: 12px;">
      </label>
    </div>
    <p class="muted" style="margin: 8px 0 0 0; font-size: 0.85rem;">
      La recherche filtre toutes les lignes de tous les tableaux (Destinations, Transferts et tableaux personnalisÃ©s).
    </p>
  </div>
	
  <!-- Zone majorations V10.8 -->
  <div class="card card-majorations card-fixed" style="background: #fffef0; border-left: 4px solid #ffc107;">
    <h3 style="margin-top: 0; color: #f57c00;">ğŸ“ Majorations et conditions spÃ©cifiques</h3>
    <p class="muted" style="margin-bottom: 10px;">
      Texte libre pour facturation (nuit, jours fÃ©riÃ©s, conditions particuliÃ¨res...). SauvegardÃ© par client/annÃ©e.
    </p>
    <textarea id="conditionsText" 
              style="width: 100%; min-height: 100px; max-height: 400px; padding: 12px; border: 2px solid #ffc107; border-radius: 6px; font-family: inherit; font-size: 0.95rem; resize: vertical; background: white;"
              placeholder="Exemples :
â€¢ Majoration nuit (20h-8h) : +30%
â€¢ Jours fÃ©riÃ©s : +50%
â€¢ Dimanche : +40%
â€¢ PÃ©riodes scolaires : tarif spÃ©cial"></textarea>
  </div>
  
<!-- SPRINT 2.6: Container pour section destinations importÃ©es -->
<div id="importedSectionContainer"></div>

<div class="card card-draggable" data-table-id="destinations">
    <div class="card-drag-handle" draggable="true">â‹®â‹®</div>
    <h2 id="destinationsTitle">ğŸ“ Destinations</h2>
    <p>Destinations personnalisables. Tri par frÃ©quence, alphabet ou ordre initial.</p>
    <div class="sort-controls">
      <label>Tri :
        <select id="sortDestinationsTop">
          <option value="freqDesc">FrÃ©quence (plus frÃ©quent en haut)</option>
          <option value="alphaAsc">Nom A â†’ Z</option>
          <option value="alphaDesc">Nom Z â†’ A</option>
          <option value="original">Par dÃ©faut</option>
        </select>
      </label>
    </div>
    <div class="table-wrapper">
      <table id="destinationsTable" class="pricing-table">
        <thead>
          <tr>
            <th class="highlight-col">âš‘</th>
            <th class="dest">Destination</th>
            <th class="trajet">Trajet</th>

            <th class="group-VL col-no">NÂ° Fact. VL</th>
            <th class="group-VL col-ht">VL HT</th>
            <th class="group-VL col-ttc">VL TTC</th>
            <th class="group-VL col-evol">Ã‰vol. VL (%)</th>

            <th class="group-MC22 col-no">NÂ° Fact. Minicar 22</th>
            <th class="group-MC22 col-ht">Minicar 22 HT</th>
            <th class="group-MC22 col-ttc">Minicar 22 TTC</th>
            <th class="group-MC22 col-evol">Ã‰vol. Min. 22 (%)</th>

            <th class="group-MC33 col-no">NÂ° Fact. Minicar 33</th>
            <th class="group-MC33 col-ht">Minicar 33 HT</th>
            <th class="group-MC33 col-ttc">Minicar 33 TTC</th>
            <th class="group-MC33 col-evol">Ã‰vol. Min. 33 (%)</th>

            <th class="group-AC55 col-no">NÂ° Fact. Autocar 55</th>
            <th class="group-AC55 col-ht">Autocar 55 HT</th>
            <th class="group-AC55 col-ttc">Autocar 55 TTC</th>
            <th class="group-AC55 col-evol">Ã‰vol. A55 (%)</th>

            <th class="group-AC64 col-no">NÂ° Fact. Autocar 64</th>
            <th class="group-AC64 col-ht">Autocar 64 HT</th>
            <th class="group-AC64 col-ttc">Autocar 64 TTC</th>
            <th class="group-AC64 col-evol">Ã‰vol. A64 (%)</th>

            <th class="col-note">Note</th>
            <th>Suppr.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="toolbar">
      <button id="btnAddDestinationTop" type="button" class="btn">+ Ajouter une destination</button>
    </div>

    <p class="print-note">
      Les prix TTC sont calculÃ©s Ã  partir des valeurs HT et de la TVA paramÃ©trÃ©e.  
      Les pourcentages d'Ã©volution comparent avec l'annÃ©e prÃ©cÃ©dente, pour le mÃªme client, en recherchant la mÃªme destination et le mÃªme type de trajet.
    </p>
  </div>

<div class="card card-draggable" data-table-id="transferts">
    <div class="card-drag-handle" draggable="true">â‹®â‹®</div>
    <h2 id="transfertsTitle">ğŸš‰ Transferts (gares / aÃ©roports)</h2>
    <p>Lignes dÃ©diÃ©es aux transferts. Les rÃ¨gles sont identiques aux destinations (HT/TTC, Ã©volution, majoration, notes).</p>
    <div class="table-wrapper">
      <table id="transfertsTable" class="pricing-table">
        <thead>
          <tr>
            <th class="highlight-col">âš‘</th>
            <th class="dest">Transfert</th>
            <th class="trajet">Trajet</th>

            <th class="group-VL col-no">NÂ° Fact. VL</th>
            <th class="group-VL col-ht">VL HT</th>
            <th class="group-VL col-ttc">VL TTC</th>
            <th class="group-VL col-evol">Ã‰vol. VL (%)</th>

            <th class="group-MC22 col-no">NÂ° Fact. Minicar 22</th>
            <th class="group-MC22 col-ht">Minicar 22 HT</th>
            <th class="group-MC22 col-ttc">Minicar 22 TTC</th>
            <th class="group-MC22 col-evol">Ã‰vol. Min. 22 (%)</th>

            <th class="group-MC33 col-no">NÂ° Fact. Minicar 33</th>
            <th class="group-MC33 col-ht">Minicar 33 HT</th>
            <th class="group-MC33 col-ttc">Minicar 33 TTC</th>
            <th class="group-MC33 col-evol">Ã‰vol. Min. 33 (%)</th>

            <th class="group-AC55 col-no">NÂ° Fact. Autocar 55</th>
            <th class="group-AC55 col-ht">Autocar 55 HT</th>
            <th class="group-AC55 col-ttc">Autocar 55 TTC</th>
            <th class="group-AC55 col-evol">Ã‰vol. A55 (%)</th>

            <th class="group-AC64 col-no">NÂ° Fact. Autocar 64</th>
            <th class="group-AC64 col-ht">Autocar 64 HT</th>
            <th class="group-AC64 col-ttc">Autocar 64 TTC</th>
            <th class="group-AC64 col-evol">Ã‰vol. A64 (%)</th>

            <th class="col-note">Note</th>
            <th>Suppr.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="toolbar">
      <button id="btnAddTransfertTop" type="button" class="btn">+ Ajouter un transfert</button>
    </div>

  </div>
</div>

<datalist id="destinationsList"></datalist>

<script>
/*
 * ===============================================================
 * GRILLE TARIFAIRE AUTOCARS BALLANFAT - V11.0.22 FIX
 * ===============================================================
 * Date : 5 Janvier 2026
 * 
 * CORRECTIFS V11.0.22 (6 bugs critiques + TEST 1.1) :
 * 
 * 1. âœ… Erreurs HTTP 406 Supabase (BUG #1)
 *    - Meilleur fallback localStorage si cloud inaccessible
 *    - Logs d'erreur plus dÃ©taillÃ©s (code + message)
 *    - Continue de fonctionner mÃªme si Supabase Ã©choue
 * 
 * 2. âœ… SÃ©lecteur annÃ©es vide (BUG #2, TEST 1.6)
 *    - getStoredYearsForClient() gÃ¨re mieux erreurs 406
 *    - PrivilÃ©gie localStorage si cloud Ã©choue
 *    - Affiche log dÃ©taillÃ© du nombre d'annÃ©es trouvÃ©es
 * 
 * 3. âœ… Sauvegarde auto aprÃ¨s modif TTC (BUG #3, TEST 2.2)
 *    - updateFromTTC() dÃ©clenche saveGrid()
 *    - updateFromHT() dÃ©clenche saveGrid()
 *    - DonnÃ©es HT/TTC persistantes aprÃ¨s rechargement
 * 
 * 4. âœ… Sauvegarde auto aprÃ¨s Drag & Drop (BUG #4, TEST 2.4)
 *    - dragend sur tbody dÃ©clenche triggerAutoSave()
 *    - Ordre lignes sauvegardÃ© automatiquement
 * 
 * 5. âœ… AnnÃ©e supprimÃ©e rafraÃ®chit sÃ©lecteur (BUG #5, TEST 1.4)
 *    - populateYearSelectForClient() rechargÃ© aprÃ¨s suppression
 *    - SÃ©lecteur reconstruit avec annÃ©es restantes
 *    - Plus d'annÃ©es fantÃ´mes
 * 
 * 6. âœ… Calcul Ã©volutions N vs N-1 (BUG #6)
 *    - loadPreviousYearPayload() maintenant async
 *    - Essaie cloud SI localStorage vide
 *    - computeEvolutions() dÃ©clenche correctement
 *    - Wrapper triggerComputeEvolutions() pour event listeners
 * 
 * 7. âœ… Import JSON annÃ©es persistantes (TEST 1.1)
 *    - reader.onload maintenant async
 *    - await deserializeGrid() et populateYearSelectForClient()
 *    - AnnÃ©e importÃ©e apparaÃ®t immÃ©diatement dans sÃ©lecteur
 * 
 * HISTORIQUE:
 * V11.0.21 STABLE - 30 DÃ©c 2025 - Corrections P0/P1/P2
 * V11.0.20 STABLE - 28 DÃ©c 2025 - Corrections critiques
 * V11.0.19 COMPLETE - 24 DÃ©c 2025 - Version rÃ©fÃ©rence
 * ===============================================================
 */

// ================== SUPABASE CONFIGURATION V2 (21 Jan 2026) ==================
// Projet : twyacfsojmsmjabogort
const SUPABASE_URL = 'https://twyacfsojmsmjabogort.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3eWFjZnNvam1zbWphYm9nb3J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyODQ2ODksImV4cCI6MjA4Mzg2MDY4OX0.9e3YBdkPnE7uaNJYf9R-3d3bZICRJMxJHUtGQsV5CO8'; 

let supabaseClient = null;
let isSupabaseAvailable = false;

// Initialiser Supabase
async function initSupabase() {
  try {
    console.log('ğŸ”Œ Initialisation Supabase...');
    
    if (typeof supabase === 'undefined') {
      throw new Error('Supabase SDK non chargÃ©');
    }

    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Test connexion
    const { data, error } = await supabaseClient
      .from('clients')
      .select('count');
    
    if (error) throw error;
    
    isSupabaseAvailable = true;
    updateStatusIndicator('cloud', 'â˜ï¸ Cloud OK');
    console.log('âœ… Supabase initialisÃ©');
    
    // Charger les clients depuis le cloud
    await loadClientsFromCloud();
    
    return true;
  } catch (error) {
    console.error('âŒ Erreur Supabase:', error);
    isSupabaseAvailable = false;
    updateStatusIndicator('local', 'ğŸ“ Mode local');
    
    // Fallback clients par dÃ©faut
    loadDefaultClients();
    
    return false;
  }
}

function updateStatusIndicator(status, text) {
  const dot = document.getElementById('status-dot');
  const textEl = document.getElementById('status-text');
  
  if (dot) {
    const colors = {
      'cloud': '#10b981',
      'local': '#f59e0b',
      'saving': '#f59e0b',
      'error': '#ef4444'
    };
    dot.style.background = colors[status] || '#94a3b8';
  }
  
  if (textEl) {
    textEl.textContent = text;
  }
}

// ============================================================================
// BUGFIX V11.0.20 - Fonction globale normalisation texte (P0 Bug #2)
// ============================================================================
function normalizeText(text) {
  if (!text) return '';
  return text.trim()
    .toLowerCase()
    .replace(/\s+/g, ' ') // Normaliser espaces multiples
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, ''); // Supprimer accents
}

// Charger clients depuis Supabase
async function loadClientsFromCloud() {
  if (!isSupabaseAvailable) {
    console.warn('âš ï¸ Supabase indisponible');
    loadDefaultClients();
    return;
  }
  
  try {
    const { data: clients, error } = await supabaseClient
      .from('clients')
      .select('*')
      .order('name', { ascending: true });
    
    if (error) throw error;
    
   const clientSelect = document.getElementById('clientSelect');
    if (!clientSelect) return;
    
    // BUGFIX V11.0.28: Sauvegarder sÃ©lection actuelle
    const savedClient = clientSelect.value || localStorage.getItem('lastClient') || currentContext.client || "CFMM";
    
    // Vider sÃ©lecteur
    clientSelect.innerHTML = '';
    
    // Ajouter clients
    clients.forEach(client => {
      const option = document.createElement('option');
      option.value = client.name;
      option.textContent = client.name;
      clientSelect.appendChild(option);
    });
    
    // Ajouter "Nouveau client"
    const optNew = document.createElement('option');
    optNew.value = '__new_client__';
    optNew.textContent = '+ Nouveau client...';
    clientSelect.appendChild(optNew);
    
    // BUGFIX V11.0.28: Restaurer sÃ©lection
    if (savedClient && Array.from(clientSelect.options).some(o => o.value === savedClient)) {
      clientSelect.value = savedClient;
      console.log(`âœ… ${clients.length} clients chargÃ©s depuis cloud, "${savedClient}" sÃ©lectionnÃ©`);
    } else {
      // Si client sauvegardÃ© inexistant, sÃ©lectionner le premier
      clientSelect.value = clients[0]?.name || '';
      console.log(`âœ… ${clients.length} clients chargÃ©s depuis cloud, "${clientSelect.value}" sÃ©lectionnÃ© par dÃ©faut`);
    }
    
  } catch (error) {
    console.error('âŒ Erreur chargement clients:', error);
    loadDefaultClients();
  }
}
// ============================================================================
// BUGFIX V11.0.28: Fonction utilitaire conversion nom client â†’ UUID
// ============================================================================
/**
 * Convertit un nom de client en UUID Supabase
 * @param {string} clientName - Nom du client ou UUID dÃ©jÃ 
 * @returns {Promise<string|null>} UUID du client ou null si non trouvÃ©
 */
async function getClientUuid(clientName) {
  if (!clientName) return null;
  
  // Si dÃ©jÃ  un UUID (contient des tirets), retourner tel quel
  if (clientName.includes('-')) {
    return clientName;
  }
  
  // Sinon, chercher dans Supabase
  if (!isSupabaseAvailable) {
    console.warn('âš ï¸ Supabase non disponible pour conversion UUID');
    return null;
  }
  
  try {
    const { data: clientData, error } = await supabaseClient
      .from('clients')
      .select('id')
      .eq('name', clientName)
      .single();
    
    if (error || !clientData) {
      console.warn(`âš ï¸ Client "${clientName}" non trouvÃ© dans cloud`);
      return null;
    }
    
    console.log(`âœ… UUID client "${clientName}": ${clientData.id}`);
    return clientData.id;
  } catch (e) {
    console.error('âŒ Erreur conversion UUID:', e);
    return null;
  }
}
function loadDefaultClients() {
  const defaultClients = ['CFMM', 'OVAL', 'Ginkgo Ã‰vÃ©nement', 'Centre La Ruche'];
  const clientSelect = document.getElementById('clientSelect');
  if (!clientSelect) return;
  
  clientSelect.innerHTML = '';
  
  defaultClients.forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    clientSelect.appendChild(option);
  });
  
  const optNew = document.createElement('option');
  optNew.value = '__new_client__';
  optNew.textContent = '+ Nouveau client...';
  clientSelect.appendChild(optNew);
  
  console.log('âœ… Clients par dÃ©faut chargÃ©s');
}

// Charger grille depuis cloud
async function loadGridFromCloud(clientId, year) {
  try {
    // âœ… NOUVEAU : Convertir nom en UUID si nÃ©cessaire
    let actualClientId = clientId;
    
    // Si clientId n'est pas un UUID (pas de tirets), c'est un nom â†’ convertir
    if (clientId && !clientId.includes('-')) {
      console.log(`ğŸ”„ Conversion nom "${clientId}" â†’ UUID...`);
      const { data: clientData, error: clientError } = await supabaseClient
        .from('clients')
        .select('id')
        .eq('name', clientId)
        .single();
      
      if (clientError || !clientData) {
        console.warn(`âš ï¸ Client "${clientId}" non trouvÃ© dans cloud`);
        return null;
      }
      
      actualClientId = clientData.id;
      console.log(`âœ… UUID trouvÃ©: ${actualClientId}`);
    }
    
    console.log(`â˜ï¸ Chargement grille cloud: ${actualClientId} / ${year}`);
    
    const { data, error } = await supabaseClient
      .from('grilles')
      .select('*')
      .eq('client_id', actualClientId)
      .eq('year', year);
    
    // âœ… CORRECTION : Ignorer erreur 406 (Not Acceptable)
    if (error) {
      // Si erreur 406 â†’ Traiter comme "pas de donnÃ©es"
      if (error.message && (error.message.includes('406') || error.code === '406')) {
        console.log(`âš ï¸ HTTP 406 ignorÃ© pour annÃ©e ${year} (traitÃ© comme vide)`);
        return null;
      }
      // Autres erreurs â†’ lever exception
      throw error;
    }
    
    if (!data || data.length === 0) {
      console.log(`â„¹ï¸ Aucune grille cloud pour ${year}`);
      return null;
    }
    
    console.log('â˜ï¸ Grille chargÃ©e depuis cloud');
	return data[0].data;  // â† Retourner le champ 'data' uniquement
    
  } catch (error) {
    console.error('âŒ Erreur chargement cloud:', error);
    // âœ… Ne pas bloquer l'application sur erreur
    return null;
  }
}
	
// Sauvegarder grille vers cloud avec versioning
// Garantir que le client existe dans Supabase (crÃ©er si nÃ©cessaire)
async function ensureClientExists(clientName) {
  if (!isSupabaseAvailable) {
    console.warn('âš ï¸ Supabase indisponible');
    return null;
  }
  
  try {
    // VÃ©rifier si le client existe dÃ©jÃ 
    const { data: existingClient } = await supabaseClient
      .from('clients')
      .select('id')
      .eq('name', clientName)
      .single();
    
    if (existingClient) {
      console.log('âœ… Client trouvÃ© dans cloud:', clientName);
      return existingClient.id;
    }
    
    // Client n'existe pas, le crÃ©er
    console.log('ğŸ“ CrÃ©ation du client dans cloud:', clientName);
    const { data: newClient, error } = await supabaseClient
      .from('clients')
      .insert({ name: clientName })
      .select('id')
      .single();
    
    if (error) {
      console.error('âŒ Erreur crÃ©ation client:', error);
      return null;
    }
    
    console.log('âœ… Client crÃ©Ã© dans cloud:', clientName, '| ID:', newClient.id);
    return newClient.id;
    
  } catch (error) {
    console.error('âŒ Erreur ensureClientExists:', error);
    return null;
  }
}

async function saveGridToCloud(client, year, data) {
  if (!isSupabaseAvailable) {
    console.warn('âš ï¸ Supabase indisponible, sauvegarde locale uniquement');
    return false;
  }
  
  try {
    // BUGFIX V11.0.17: Garantir que le client existe (crÃ©er si nÃ©cessaire)
    const clientId = await ensureClientExists(client);
    
    if (!clientId) {
      console.error('âŒ Impossible de crÃ©er/trouver le client dans cloud');
      return false;
    }
    
    // VÃ©rifier si grille existe
    const { data: existingGrille } = await supabaseClient
      .from('grilles')
      .select('id')
      .eq('client_id', clientId)
      .eq('year', year)
      .single();
    
    let grilleId;
    
    if (!existingGrille) {
// CrÃ©er nouvelle grille
const { data: newGrille, error: insertError } = await supabaseClient
  .from('grilles')
  .insert({
    client_id: clientId,
    year: year,
    data: data,
    tva: data.tva || 10
  })
  .select('id')
  .single();

if (insertError) {
  // Si HTTP 409 (conflit/doublon), charger la grille existante
  if (insertError.code === '23505' || insertError.message?.includes('duplicate')) {
    console.log('âš ï¸ Grille existe dÃ©jÃ  (conflit ignorÃ©), chargement...');
    const { data: existingData } = await supabaseClient
      .from('grilles')
      .select('id')
      .eq('client_id', clientId)
      .eq('year', year)
      .single();
    
    if (existingData) {
      grilleId = existingData.id;
    } else {
      throw new Error('Impossible de crÃ©er ou charger la grille');
    }
  } else {
    throw insertError;
  }
} else {
  grilleId = newGrille.id;
  console.log('âœ… Nouvelle grille crÃ©Ã©e dans cloud');
}

    } else {
      // Mettre Ã  jour grille existante
      grilleId = existingGrille.id;
      
      await supabaseClient
        .from('grilles')
        .update({
          data: data,
          updated_at: new Date()
        })
        .eq('id', grilleId);
      
      console.log('âœ… Grille mise Ã  jour dans cloud');
    }
    
    // CrÃ©er version dans historique
    await createVersion(grilleId, clientId, year, data);
    
    return true;
    
  } catch (error) {
    console.error('âŒ Erreur sauvegarde cloud:', error);
    return false;
  }
}

// CrÃ©er une version dans l'historique
async function createVersion(grilleId, clientId, year, data) {
  try {
    // Compter versions existantes
    const { count } = await supabaseClient
      .from('grilles_versions')
      .select('*', { count: 'exact', head: true })
      .eq('grille_id', grilleId);
    
    const nextVersion = (count || 0) + 1;
    
  // InsÃ©rer nouvelle version
const { data: insertedVersion, error: insertError } = await supabaseClient
  .from('grilles_versions')
 .insert({
  grille_id: grilleId,
  version_number: nextVersion,
  data: data
})

  .select();

if (insertError) {
  console.error('âŒ Erreur INSERT version:', insertError);
  console.error('   Code:', insertError.code);
  console.error('   Message:', insertError.message);
  console.error('   Details:', insertError.details);
  console.error('   Hint:', insertError.hint);
  throw insertError;
}

console.log(`âœ… Version ${nextVersion} crÃ©Ã©e`, insertedVersion);

    
    // Nettoyer anciennes versions (garder 50 max)
    await cleanOldVersions(grilleId, 50);
    
    // Mettre Ã  jour compteur
    updateVersionCount(count + 1);
    
  } catch (error) {
    console.error('âŒ Erreur crÃ©ation version:', error);
  }
}

// Nettoyer anciennes versions
async function cleanOldVersions(grilleId, keepCount = 50) {
  try {
    const { data: versions } = await supabaseClient
      .from('grilles_versions')
      .select('id, version_number')
      .eq('grille_id', grilleId)
      .order('version_number', { ascending: false });
    
    if (versions && versions.length > keepCount) {
      const toDelete = versions.slice(keepCount);
      const idsToDelete = toDelete.map(v => v.id);
      
      await supabaseClient
        .from('grilles_versions')
        .delete()
        .in('id', idsToDelete);
      
      console.log(`ğŸ—‘ï¸ ${toDelete.length} anciennes versions supprimÃ©es`);
    }
  } catch (error) {
    console.error('âŒ Erreur nettoyage versions:', error);
  }
}

function updateVersionCount(count) {
  const badge = document.getElementById('versionCount');
  if (badge) {
    badge.textContent = Math.min(count, 50);
  }
}

// Charger compteur versions pour grille actuelle
async function updateVersionCountForCurrentGrid() {
  const badge = document.getElementById('versionCount');
  if (!badge) return;
  
  if (!isSupabaseAvailable) {
    badge.textContent = '0';
    return;
  }
  
  const client = getCurrentClient();
  const year = getCurrentYear();
  
  if (!client || !year || year === '__new_year__') {
    badge.textContent = '0';
    return;
  }
  
  try {
    // Trouver client_id
    const { data: clientData } = await supabaseClient
      .from('clients')
      .select('id')
      .eq('name', client)
      .single();
    
    if (!clientData) {
      badge.textContent = '0';
      return;
    }
    
    // Trouver grille_id
    const { data: grilleData } = await supabaseClient
      .from('grilles')
      .select('id')
      .eq('client_id', clientData.id)
      .eq('year', parseInt(year))
      .single();
    
    if (!grilleData) {
      badge.textContent = '0';
      return;
    }
    
    // Compter versions
    const { count } = await supabaseClient
      .from('grilles_versions')
      .select('*', { count: 'exact', head: true })
      .eq('grille_id', grilleData.id);
    
    badge.textContent = count || '0';
    
  } catch (error) {
    console.error('Erreur comptage versions:', error);
    badge.textContent = '0';
  }
}

// Initialiser au chargement
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSupabase);
} else {
  initSupabase();
}

// ================== FIN SUPABASE CONFIGURATION ==================


const NB_DEST_INIT = 1;
const NB_TRANS_INIT = 1;
const VEHICULES = ["VL","MC22","MC33","AC55","AC64"];

// CatÃ©gories par dÃ©faut V10.10.0
const DEFAULT_CATEGORIES = {
  VL: { name: "VÃ©hicule lÃ©ger", capacity: "â‰¤ 9 places", visible: true },
  MC22: { name: "Minicar 22 pax", capacity: "22 places", visible: true },
  MC33: { name: "Minicar 33 pax", capacity: "23 Ã  33 places", visible: true },
  AC55: { name: "Autocar 55 pax", capacity: "33 Ã  55 places", visible: true },
  AC64: { name: "Autocar 64 pax", capacity: "55 Ã  64 places", visible: true }
};

// CatÃ©gories courantes (peut Ãªtre personnalisÃ©es par client/annÃ©e)
let currentCategories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));

// === TABLEAUX DYNAMIQUES V10.4.0 ===
let tables = [
  { id: "destinations", name: "Destinations", icon: "ğŸ“", order: 0 },
  { id: "transferts", name: "Transferts (gares/aÃ©roports)", icon: "ğŸš‰", order: 1 }
];
let tableCounters = { destinations: 0, transferts: 0 };
// === FIN TABLEAUX DYNAMIQUES ===

// lecture seule possible via ?mode=readonly dans l'URL
const urlParams = new URLSearchParams(window.location.search);
const READ_ONLY = (urlParams.get("mode") === "readonly");

let destCounter = 0;
let transCounter = 0;
let destOriginalOrder = [];
let lastSaved = null;
let currentContext = { client: null, year: null };
let currentGridData = null; // SPRINT 2.6: Stocker grille actuelle en mÃ©moire

// Variables auto-save (BUGFIX v11.0.23)
let autoSaveTimeout = null;
const AUTO_SAVE_DELAY = 3000; // 3 secondes
const MAX_VERSIONS = 50; // Historique max

const STORAGE_PREFIX = "ballanfat_grille_v10_2_2::";

function setStatus(msg, isError){
  const el = document.getElementById("status");
  el.textContent = msg || "";
  el.classList.toggle("error", !!isError);
}
function updateLastSavedLabel(){
  const el = document.getElementById("lastSaved");
  if(!lastSaved){
    el.textContent = "";
    return;
  }
  const d = lastSaved;
  const pad = n => n.toString().padStart(2,"0");
  el.textContent = "Dernier enregistrement : " +
    pad(d.getDate()) + "/" + pad(d.getMonth()+1) + "/" + d.getFullYear() +
    " Ã  " + pad(d.getHours()) + "h" + pad(d.getMinutes()) + "min";
}

function parseNumberFR(val){
  if(val == null) return NaN;
  const s = String(val).trim().replace(/\s+/g,"").replace(",", ".");
  if(s === "") return NaN;
  const n = Number(s);
  return isNaN(n) ? NaN : n;
}
function formatNumberFR(val, decimals){
  if(!isFinite(val)) return "";
  const d = (typeof decimals === "number") ? decimals : 2;
  const fixed = Number(val).toFixed(d);
  const parts = fixed.split(".");
  let intPart = parts[0];
  const decPart = parts[1] || "00";
  intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  return intPart + "," + decPart;
}
function getTVA(){
  const input = document.getElementById("tvaInput");
  const n = parseNumberFR(input.value);
  if(isNaN(n) || n < 0) return 0;
  return n / 100;
}

function applyReadOnlyMode(){
  if(!READ_ONLY) return;
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if(el.id === "yearSelect" || el.id === "clientSelect") return;
    el.disabled = true;
  });
  const toDisable = [
    "#btnAddDestinationTop","#btnAddTransfertTop",
    "#btnSave","#btnDeleteClient"
  ];
  toDisable.forEach(sel => {
    const b = document.querySelector(sel);
    if(b){ b.disabled = true; }
  });
  document.querySelectorAll(".btn-delete").forEach(b => { b.style.display = "none"; });
  setStatus("Mode lecture seule â€“ aucune modification possible sur ce fichier.", false);
}

function createDeleteCell(){
  const td = document.createElement("td");
  td.className = "delete-cell";
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "btn-delete";
  btn.title = "Supprimer cette ligne";
  btn.textContent = "Ã—";
  td.appendChild(btn);
  return td;
}

function applyTooltip(el){
  if(!el) return;
  el.title = el.value || "";
}

function createRow(type){
  const isDest = type === "dest";
  const tableId = isDest ? "destinationsTable" : "transfertsTable";
  const tbody = document.querySelector("#" + tableId + " tbody");
  const index = (isDest ? ++destCounter : ++transCounter);
  
  // CORRECTION BUG DRAG & DROP : Utiliser timestamp unique au lieu d'index
  const uniqueId = Date.now() + "_" + Math.random().toString(36).substr(2, 9);
  const trajId = type + "_" + uniqueId;
  
  const tr = document.createElement("tr");
  tr.dataset.trajet = trajId;
  tr.dataset.index = String(index);
  tr.dataset.freq = "0";

  const tdMark = document.createElement("td");
  tdMark.className = "highlight-col";
  
  // Ajouter le handle de drag (â‹®â‹®) pour TOUS les tableaux
  const handle = document.createElement("span");
  handle.className = "drag-handle";
  handle.innerHTML = "â‹®â‹®";
  handle.title = "Glisser pour rÃ©organiser";
  handle.setAttribute("draggable", "true");
  tdMark.appendChild(handle);
  
  // Ajouter la checkbox de surlignage
  const mark = document.createElement("input");
  mark.type = "checkbox";
  mark.className = "highlight-toggle";
  mark.addEventListener("change", function(){
    tr.classList.toggle("row-highlight", mark.checked);
  });
  tdMark.appendChild(mark);
  tr.appendChild(tdMark);

  const tdDest = document.createElement("td");
  tdDest.className = "dest";
  const inputName = document.createElement("input");
  inputName.type = "text";
  inputName.className = "dest-name";
  inputName.value = (isDest ? "Destination " : "Transfert ") + index;
  inputName.setAttribute("list","destinationsList");
  applyTooltip(inputName);
  tdDest.appendChild(inputName);
  tr.appendChild(tdDest);

  const tdTrajet = document.createElement("td");
  tdTrajet.className = "trajet";
  const sel = document.createElement("select");
  sel.className = "trajet-select";
  [["aller_retour","Aller et retour"],["aller","Aller"],["retour","Retour"]].forEach(([val,lab])=>{
    const opt=document.createElement("option");
    opt.value=val;
    opt.textContent=lab;
    sel.appendChild(opt);
  });
  tdTrajet.appendChild(sel);
  tr.appendChild(tdTrajet);

  VEHICULES.forEach(cat => {
    const groupClass = "group-" + cat;

    let tdF = document.createElement("td");
    tdF.className = groupClass + " col-no";
    const inF = document.createElement("input");
    inF.type = "text";
    inF.className = "facture-input";
    applyTooltip(inF);
    tdF.appendChild(inF);
    tr.appendChild(tdF);

    tdF = document.createElement("td");
    tdF.className = groupClass + " col-ht";
    const inHT = document.createElement("input");
    inHT.type = "text";
    inHT.className = "price-input";
    inHT.dataset.key = trajId + "|" + cat + "|HT";
    applyTooltip(inHT);
    tdF.appendChild(inHT);
    tr.appendChild(tdF);

    tdF = document.createElement("td");
    tdF.className = groupClass + " col-ttc";
    const inTTC = document.createElement("input");
    inTTC.type = "text";
    inTTC.className = "ttc-input";
    inTTC.dataset.key = trajId + "|" + cat + "|TTC";
    applyTooltip(inTTC);
    tdF.appendChild(inTTC);
    tr.appendChild(tdF);

    const tdE = document.createElement("td");
    tdE.className = groupClass + " col-evol evol-cell right";
    tdE.dataset.evolCat = cat;
    tr.appendChild(tdE);
  });

  const tdNote = document.createElement("td");
  tdNote.className = "col-note";
  const inNote = document.createElement("input");
  inNote.type = "text";
  inNote.className = "note-input";
  inNote.maxLength = 200;
  applyTooltip(inNote);
  tdNote.appendChild(inNote);
  tr.appendChild(tdNote);

  tr.appendChild(createDeleteCell());

  tbody.appendChild(tr);
  return tr;
}

function renumberRows(){
  const destRows = document.querySelectorAll("#destinationsTable tbody tr");
  destCounter = destRows.length;
  destRows.forEach((tr, idx) => tr.dataset.index = String(idx+1));
  destOriginalOrder = Array.from(destRows);

  const transRows = document.querySelectorAll("#transfertsTable tbody tr");
  transCounter = transRows.length;
  transRows.forEach((tr, idx) => tr.dataset.index = String(idx+1));
}

function generateInitialRows(){
  const destTbody = document.querySelector("#destinationsTable tbody");
  const transTbody = document.querySelector("#transfertsTable tbody");
  destTbody.innerHTML = "";
  transTbody.innerHTML = "";
  destCounter = 0;
  transCounter = 0;
  for(let i=0;i<NB_DEST_INIT;i++) createRow("dest");
  for(let i=0;i<NB_TRANS_INIT;i++) createRow("transfert");
  renumberRows();
}

function applyRowVisibility(){
  document.querySelectorAll("#destinationsTable tbody tr, #transfertsTable tbody tr").forEach(tr => {
    tr.style.display = "";
  });
}

function applyColumnVisibility(){
  document.querySelectorAll(".toggle-cat").forEach(cb => {
    const cat = cb.dataset.cat;
    if(!cat) return;
    const visible = cb.checked;
    document.querySelectorAll(".group-" + cat).forEach(cell => {
      cell.style.display = visible ? "" : "none";
    });
  });
}

function toggleCategoriesPanel(){
  const content = document.getElementById("categoriesContent");
  const btn = document.getElementById("btnToggleCategories");
  if(!content || !btn) return;
  const collapsed = content.classList.toggle("collapsed");
  btn.textContent = collapsed ? "Afficher les catÃ©gories" : "RÃ©duire les catÃ©gories";
  btn.setAttribute("aria-expanded", collapsed ? "false" : "true");
}

function applyDestinationSort(mode){
  const tbody = document.querySelector("#destinationsTable tbody");
  let rows = Array.from(tbody.querySelectorAll("tr"));
  if(mode === "original"){
    rows = Array.from(destOriginalOrder);
  }else if(mode === "alphaAsc" || mode === "alphaDesc"){
    rows.sort((a,b) => {
      const sa = (a.querySelector(".dest-name")?.value || "").trim().toLowerCase();
      const sb = (b.querySelector(".dest-name")?.value || "").trim().toLowerCase();
      if(sa < sb) return mode === "alphaAsc" ? -1 : 1;
      if(sa > sb) return mode === "alphaAsc" ? 1 : -1;
      return 0;
    });
  }else if(mode === "freqDesc"){
    rows.sort((a,b) => {
      const fa = parseNumberFR(a.dataset.freq || "0") || 0;
      const fb = parseNumberFR(b.dataset.freq || "0") || 0;
      return fb - fa;
    });
  }
  rows.forEach(r => tbody.appendChild(r));
}

function updateFromHT(inputHT){
  const tva = getTVA();
  const ht = parseNumberFR(inputHT.value);
  const key = inputHT.dataset.key;
  if(!key) return;
  const ttcInput = document.querySelector('.ttc-input[data-key="' + key.replace("|HT","|TTC") + '"]');
  if(isNaN(ht)){
    if(ttcInput) ttcInput.value = "";
    return;
  }
  const ttc = ht * (1 + tva);
  if(ttcInput) ttcInput.value = formatNumberFR(ttc,2);
}

function updateFromTTC(inputTTC){
  const tva = getTVA();
  const ttc = parseNumberFR(inputTTC.value);
  const key = inputTTC.dataset.key;
  if(!key) return;
  const htInput = document.querySelector('.price-input[data-key="' + key.replace("|TTC","|HT") + '"]');
  if(isNaN(ttc)){
    if(htInput) htInput.value = "";
    return;
  }
  const denom = (1 + tva) || 1;
  const ht = ttc / denom;
  if(htInput) htInput.value = formatNumberFR(ht,2);
  
  // BUGFIX v11.0.22: DÃ©clencher sauvegarde auto aprÃ¨s modification TTC
  triggerAutoSave();
}

function syncAllTTCFromHT(){
  document.querySelectorAll(".price-input").forEach(inp => updateFromHT(inp));
}

// ========== AUTO-SAVE FUNCTIONS (BUGFIX v11.0.23: Moved to global scope) ==========
function showSaveIndicator(text, isError = false){
  const indicator = document.getElementById('saveIndicator');
  if(!indicator) return;
  
  indicator.style.display = 'block';
  indicator.style.background = isError ? '#d9534f' : '#5cb85c';
  indicator.textContent = text;
  
  setTimeout(() => {
    indicator.style.display = 'none';
  }, 2000);
}

function updateLastSavedIndicator(text){
  const elem = document.getElementById('lastSaved');
  if(!elem) return;
  elem.textContent = text;
  elem.style.color = '#999';
  elem.style.fontSize = '0.85rem';
}

function triggerAutoSave(){
  if(autoSaveTimeout) clearTimeout(autoSaveTimeout);
  
  autoSaveTimeout = setTimeout(() => {
    autoSaveGrid();
  }, AUTO_SAVE_DELAY);
}

function autoSaveGrid(){
  try {
    const client = getCurrentClient();
    const year = getCurrentYear();
    
    if(!client || !year || year === "__new_year__") return;
    
    // Sauvegarder version actuelle
    saveGrid();
    
    // Ajouter Ã  l'historique AUTO (sÃ©parÃ©)
    const historyKey = `history_auto_${client}_${year}`;
    let history = [];
    
    try {
      const raw = localStorage.getItem(historyKey);
      if(raw) history = JSON.parse(raw);
    } catch(e){}
    
    const data = serializeGrid();
    const now = new Date();
    const version = {
      timestamp: now.toISOString(),
      type: 'auto',
      data: data
    };
    
    history.unshift(version); // Ajouter au dÃ©but
    
    // Limiter Ã  MAX_VERSIONS
    if(history.length > MAX_VERSIONS){
      history = history.slice(0, MAX_VERSIONS);
    }
    
    localStorage.setItem(historyKey, JSON.stringify(history));
    
    // Afficher timestamp
    const timeStr = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    showSaveIndicator('âœ… SauvegardÃ©');
    updateLastSavedIndicator(`Dernier enregistrement : ${timeStr}`);
    
  } catch(e){
    console.error('Erreur auto-save:', e);
    showSaveIndicator('âŒ Erreur sauvegarde', true);
  }
}
// ========== FIN AUTO-SAVE FUNCTIONS ==========

function applySearchFilter(){
  const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();
  const matchRow = (tr) => {
    if(!q) return true;
    const name = (tr.querySelector(".dest-name")?.value || "").toLowerCase();
    const note = (tr.querySelector(".note-input")?.value || "").toLowerCase();
    const trajetSel = tr.querySelector(".trajet-select");
    const trajetText = trajetSel ? trajetSel.options[trajetSel.selectedIndex].text.toLowerCase() : "";
    return name.includes(q) || note.includes(q) || trajetText.includes(q);
  };
  
  // BUGFIX V11.0.16: Recherche dans TOUS les tableaux (destinations, transferts, personnalisÃ©s)
  tables.forEach(table => {
    const tableId = "#" + table.id + "Table";
    document.querySelectorAll(tableId + " tbody tr").forEach(tr => {
      tr.style.display = matchRow(tr) ? "" : "none";
    });
  });
}

// ============================================================================
// BUGFIX V11.0.20 P0 #1: Charger annÃ©es depuis cloud ET localStorage
// ============================================================================
async function getStoredYearsForClient(client){
  const years = new Set();
  const nowYear = new Date().getFullYear();
  
  // BUGFIX v11.0.23: Prioriser cloud sur localStorage
  let cloudSuccess = false;
  
  // 1. PRIORITÃ‰ : Supabase Cloud
  if (isSupabaseAvailable) {
    try {
      const { data: clientData, error: clientError } = await supabaseClient
        .from('clients')
        .select('id')
        .eq('name', client)
        .single();
      
      if (clientError) {
        console.warn(`âš ï¸ Client cloud inaccessible (${clientError.code || clientError.message})`);
      } else if (clientData) {
        const { data: grilles, error: grillesError } = await supabaseClient
          .from('grilles')
          .select('year')
          .eq('client_id', clientData.id);
        
       if (grillesError) {
  // Ignorer HTTP 406 silencieusement
  if (grillesError.message && (grillesError.message.includes('406') || grillesError.code === '406')) {
    console.log('âš ï¸ HTTP 406 ignorÃ© (aucune annÃ©e cloud)');
  } else {
    console.warn(`âš ï¸ AnnÃ©es cloud inaccessibles (${grillesError.code || grillesError.message})`);
  }
        } else if (grilles && grilles.length > 0) {
          grilles.forEach(g => {
            if (g.year && g.year > 1900 && g.year < 3001) {
              years.add(g.year);
            }
          });
          cloudSuccess = true;
          console.log(`âœ… ${years.size} annÃ©e(s) cloud pour ${client}:`, Array.from(years).sort((a,b)=>a-b));
        }
      }
    } catch (err) {
      console.warn('âš ï¸ Erreur chargement annÃ©es cloud:', err.message);
    }
  }
  
  // 2. FALLBACK : localStorage (UNIQUEMENT si cloud a Ã©chouÃ©)
if (!cloudSuccess) {
  console.log(`â„¹ï¸ Chargement annÃ©es depuis localStorage pour ${client}...`);
  const prefix = STORAGE_PREFIX + client + "::";
  for(let i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    if(!key || !key.startsWith(prefix)) continue;
    const yStr = key.substring(prefix.length);
    const yNum = parseInt(yStr,10);
    if(yNum && yNum>1900 && yNum<3001) years.add(yNum);
  }
  
  // Si toujours rien aprÃ¨s localStorage, ajouter annÃ©e courante
  if (years.size === 0) {
    console.log(`â„¹ï¸ Aucune annÃ©e trouvÃ©e pour ${client}, ajout annÃ©e courante ${nowYear}`);
    years.add(nowYear);
 	 }
  }
  console.log(`âœ… Total ${years.size} annÃ©e(s) pour ${client}:`, Array.from(years).sort((a,b)=>a-b));
return Array.from(years).sort((a,b)=>a-b);
}

// BUGFIX V11.0.20: async car getStoredYearsForClient est async
async function populateYearSelectForClient(client, preferYear){
  const sel = document.getElementById("yearSelect");
  if(!sel) return;
  const currentYear = new Date().getFullYear();
  const years = await getStoredYearsForClient(client || "CFMM"); // await ajoutÃ©
  sel.innerHTML = "";
  years.forEach(y => {
    const opt = document.createElement("option");
    opt.value = String(y);
    opt.textContent = String(y);
    sel.appendChild(opt);
  });
  const optNew = document.createElement("option");
  optNew.value = "__new_year__";
  optNew.textContent = "+ Nouvelle annÃ©eâ€¦";
  sel.appendChild(optNew);
  let target = preferYear || currentYear;
  if(!years.includes(target)) target = years[years.length-1];
  sel.value = String(target);
}

function getCurrentYear(){
  const sel = document.getElementById("yearSelect");
  return sel ? sel.value : "";
}
function getCurrentClient(){
  const sel = document.getElementById("clientSelect");
  if(!sel) return "";
  const val = sel.value;
  if(val === "__new_client__") return "";
  return val;
}
function getCurrentClientLabel(){
  const sel = document.getElementById("clientSelect");
  if(!sel) return "";
  const opt = sel.options[sel.selectedIndex];
  if(!opt) return "";
  if(opt.value === "__new_client__") return "";
  return opt.text;
}
function updateTitleSubtitle(){
  const sub = document.getElementById("titleSub");
  const clientLabel = getCurrentClientLabel() || "Client";
  const year = getCurrentYear() || "----";
  sub.textContent = "Grille tarifaire â€“ " + clientLabel + " â€“ " + year;
}

function getContextKey(client, year){
  return STORAGE_PREFIX + client + "::" + year;
}

function resetGridToInitial(){
  // RÃ©initialiser les tableaux dynamiques
  tables = [
    { id: "destinations", name: "Destinations", icon: "ğŸ“", order: 0 },
    { id: "transferts", name: "Transferts (gares/aÃ©roports)", icon: "ğŸš‰", order: 1 }
  ];
  tableCounters = { destinations: 0, transferts: 0 };
  
  // Supprimer les tableaux personnalisÃ©s du DOM
  document.querySelectorAll('.card').forEach(card => {
    const tableElem = card.querySelector('table.pricing-table');
    if(tableElem){
      const tableId = tableElem.id.replace('Table', '');
      if(tableId !== 'destinations' && tableId !== 'transferts'){
        card.remove();
      }
    }
  });
  
  // RÃ©afficher destinations/transferts si masquÃ©s
  ['destinations', 'transferts'].forEach(id => {
    const tableEl = document.getElementById(id + 'Table');
    if(tableEl){
      const card = tableEl.closest('.card');
      if(card) card.style.display = '';
    }
  });
  
  generateInitialRows();
  applyRowVisibility();
  applyColumnVisibility();
  destOriginalOrder = Array.from(document.querySelectorAll("#destinationsTable tbody tr"));
  syncAllTTCFromHT();
  refreshDestinationSuggestions();
  
  // BUGFIX v11.0.24: Retirer await (fonction non-async)
  computeEvolutions(); // ExÃ©cution asynchrone en parallÃ¨le
  markUnchangedPrices();
  
  renderTablesManager();
  
  // Vider majorations V10.8
  const conditionsTextarea = document.getElementById("conditionsText");
  if(conditionsTextarea){
    conditionsTextarea.value = "";
  }
}

function loadGridForCurrentContext(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  if(!client || !year || year === "__new_year__"){
    resetGridToInitial();
    return;
  }
  const key = getContextKey(client, year);
  const raw = localStorage.getItem(key);
  if(!raw){
    resetGridToInitial();
    setStatus("Nouvelle grille pour " + client + " â€“ " + year + " (aucune sauvegarde trouvÃ©e).", false);
    return;
  }
  try{
    const data = JSON.parse(raw);
    deserializeGrid(data);
    setStatus("Grille chargÃ©e pour " + client + " â€“ " + year + ".", false);
  }catch(e){
    console.error(e);
    resetGridToInitial();
    setStatus("Erreur lors du chargement, grille rÃ©initialisÃ©e pour " + client + " â€“ " + year + ".", true);
  }
}

function serializeGrid(){
  // Format v10.4.3 avec tableaux dynamiques
  const tablesData = {};
  
  tables.forEach(table => {
    const tbody = document.querySelector(`#${table.id}Table tbody`);
    if(!tbody) return;
    
    const rows = [];
    tbody.querySelectorAll("tr").forEach(tr => {
      const dest = tr.querySelector(".dest-name")?.value || "";
      const trajet = tr.querySelector(".trajet-select")?.value || "";
      const note = tr.querySelector(".note-input")?.value || "";
      const factures = {};
      const tarifs = {};
      VEHICULES.forEach(cat => {
        const f = tr.querySelector(".group-" + cat + " .facture-input");
        const h = tr.querySelector(".group-" + cat + " .price-input");
        factures[cat] = f ? f.value : "";
        const v = h ? parseNumberFR(h.value) : NaN;
        tarifs[cat] = isNaN(v) ? null : v;
      });
      rows.push({ dest, trajet, note, factures, tarifs });
    });
    
    tablesData[table.id] = {
      name: table.name,
      icon: table.icon,
      order: table.order,
      rows: rows
    };
  });

  return {
    version: "10.10.0",
    tva: parseNumberFR(document.getElementById("tvaInput")?.value || "10") || 10,
    savedAt: new Date().toISOString(),
    tables: tablesData,
    tablesOrder: tables.map(t => t.id),
    conditionsText: document.getElementById("conditionsText")?.value || "",
    categories: currentCategories // V10.10.0
  };
}

async function deserializeGrid(payload){
  if(!payload) return;
  
  // ========== COMPATIBILITÃ‰ ASCENDANTE v10.3.x â†’ v10.4.3 ==========
  if(Array.isArray(payload.rows) && !payload.tables){
    // Ancien format dÃ©tectÃ©, convertir en nouveau format
    console.log("Migration format v10.3.x â†’ v10.4.3");
    const destRows = payload.rows.filter(r => r.type === "destination");
    const transRows = payload.rows.filter(r => r.type === "transfert" || r.type === "transfer");
    
    payload.tables = {
      destinations: {
        name: "Destinations",
        icon: "ğŸ“",
        order: 0,
        rows: destRows.map(r => ({dest: r.dest, trajet: r.trajet, note: r.note, factures: r.factures, tarifs: r.tarifs}))
      },
      transferts: {
        name: "Transferts (gares/aÃ©roports)",
        icon: "ğŸš‰",
        order: 1,
        rows: transRows.map(r => ({dest: r.dest, trajet: r.trajet, note: r.note, factures: r.factures, tarifs: r.tarifs}))
      }
    };
    payload.tablesOrder = ["destinations", "transferts"];
  }
  
  // ========== CHARGEMENT FORMAT v10.4.3 ==========
  if(payload.tables){
    // RÃ©initialiser les tableaux
    tables = [];
    tableCounters = {};
    
    // Reconstruire la liste des tableaux
    const order = payload.tablesOrder || Object.keys(payload.tables);
    order.forEach((tableId, index) => {
      const tableData = payload.tables[tableId];
      if(tableData){
        tables.push({
          id: tableId,
          name: tableData.name || tableId,
          icon: tableData.icon || "ğŸ“‹",
          order: tableData.order != null ? tableData.order : index
        });
        tableCounters[tableId] = 0;
      }
    });
    
    // Supprimer les tableaux personnalisÃ©s existants (pas destinations/transferts)
    document.querySelectorAll('.card').forEach(card => {
      const tableElem = card.querySelector('table.pricing-table');
      if(tableElem){
        const tableId = tableElem.id.replace('Table', '');
        if(tableId !== 'destinations' && tableId !== 'transferts'){
          card.remove();
        }
      }
    });
    
 // CrÃ©er les tableaux personnalisÃ©s
const customTables = tables.filter(t => t.id !== 'destinations' && t.id !== 'transferts');
customTables.forEach(table => {
  const card = createTableHTML(table);
  if(card){
    // BUGFIX V11.0.25 P0-2: InsÃ©rer AVANT la section majorations
    const majorationsCard = document.querySelector('.card-majorations');
    if(majorationsCard){
      majorationsCard.parentNode.insertBefore(card, majorationsCard);
    } else {
      // Fallback: insÃ©rer Ã  la fin si section majorations introuvable
      const lastCard = document.querySelector('.card:last-of-type');
      if(lastCard){
        lastCard.parentNode.insertBefore(card, lastCard.nextSibling);
      } else {
        document.querySelector('.page').appendChild(card);
      }
    }
  }
});

    
   // Charger les donnÃ©es dans chaque tableau
tables.forEach(table => {
  const tableData = payload.tables[table.id];
  
  if(tableData && Array.isArray(tableData.rows)){
    const tbody = document.querySelector(`#${table.id}Table tbody`);
    if(tbody){
      
      tbody.innerHTML = "";
      tableCounters[table.id] = 0;
      
      tableData.rows.forEach((r, rowIndex) => {
        
        // Pour destinations et transferts, utiliser createRow
        if(table.id === 'destinations' || table.id === 'transferts'){
          const tr = createRow(table.id === 'transferts' ? 'transfert' : 'dest');
          
          const inputName = tr.querySelector(".dest-name");
          const trajetSel = tr.querySelector(".trajet-select");
          const noteEl = tr.querySelector(".note-input");
          if(inputName) { inputName.value = r.dest || ""; applyTooltip(inputName); }
          if(trajetSel && r.trajet) trajetSel.value = r.trajet;
          if(noteEl) { noteEl.value = r.note || ""; applyTooltip(noteEl); }
          
          VEHICULES.forEach(cat => {
            const factVal = r.factures && r.factures[cat] != null ? r.factures[cat] : "";
            const tarifVal = r.tarifs && typeof r.tarifs[cat] === "number" ? r.tarifs[cat] : null;
            const f = tr.querySelector(".group-" + cat + " .facture-input");
            const h = tr.querySelector(".group-" + cat + " .price-input");
            if(f) { f.value = factVal; applyTooltip(f); }
            if(h) { h.value = tarifVal != null ? formatNumberFR(tarifVal,2) : ""; applyTooltip(h); }
          });
          
        } else {
          // Pour les tableaux personnalisÃ©s, utiliser addRowToCustomTable
          addRowToCustomTable(table.id);
          const rows = tbody.querySelectorAll('tr');
          const tr = rows[rows.length - 1];
          
          const inputName = tr.querySelector(".dest-name");
          const trajetSel = tr.querySelector(".trajet-select");
          const noteEl = tr.querySelector(".note-input");
          if(inputName) { inputName.value = r.dest || ""; applyTooltip(inputName); }
          if(trajetSel && r.trajet) trajetSel.value = r.trajet;
          if(noteEl) { noteEl.value = r.note || ""; applyTooltip(noteEl); }
          
          VEHICULES.forEach(cat => {
            const factVal = r.factures && r.factures[cat] != null ? r.factures[cat] : "";
            const tarifVal = r.tarifs && typeof r.tarifs[cat] === "number" ? r.tarifs[cat] : null;
            const f = tr.querySelector(".group-" + cat + " .facture-input");
            const h = tr.querySelector(".group-" + cat + " .price-input");
            if(f) { f.value = factVal; applyTooltip(f); }
            if(h) { h.value = tarifVal != null ? formatNumberFR(tarifVal,2) : ""; applyTooltip(h); }
          });
        }
      });
      
    } else {
    }
  }
});

  // Restaurer TVA
  if(payload.tva != null){
    const tvaInput = document.getElementById("tvaInput");
    if(tvaInput) tvaInput.value = String(payload.tva).replace(".",",");
  }
  
  // Restaurer timestamp
  if(payload.savedAt){
    lastSaved = new Date(payload.savedAt);
    updateLastSavedLabel();
  }
  
  // Charger majorations V10.8
  const conditionsTextarea = document.getElementById("conditionsText");
  if(conditionsTextarea){
    conditionsTextarea.value = payload.conditionsText || "";
  }
  
  // Charger catÃ©gories V10.10.0
  if(payload.categories){
    currentCategories = payload.categories;
  } else {
    currentCategories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
  }
  renderVehicleCategoriesEditor();
  updateTableHeaders();
  
  // Mettre Ã  jour l'interface
  renderTablesManager();
  applyColumnVisibility();
  syncAllTTCFromHT();
  refreshDestinationSuggestions();
  checkDuplicateDestinations(); // BUGFIX V11.0.21 P0 #3

	  syncAllTTCFromHT();
  refreshDestinationSuggestions();
  checkDuplicateDestinations(); // BUGFIX V11.0.21 P0 #3
  
  // BUGFIX V11.0.28: Restaurer les noms personnalisÃ©s des tableaux
  tables.forEach(table => {
    const titleEl = document.getElementById(table.id + 'Title');
    if(titleEl){
      titleEl.textContent = `${table.icon} ${table.name}`;
    }
  });
	  
 await computeEvolutions(); markUnchangedPrices();

  // BUGFIX V11.0.27: RÃ©organiser les cards selon tablesOrder sauvegardÃ©
  if (payload.tablesOrder && payload.tablesOrder.length > 0) {
    const majorationsCard = document.querySelector('.card-majorations');
    if (majorationsCard) {
      // RÃ©organiser dans l'ordre inverse pour que le premier soit juste aprÃ¨s majorations
      const order = [...payload.tablesOrder].reverse();
      order.forEach(tableId => {
        const card = document.querySelector(`.card[data-table-id="${tableId}"]`);
        if (card) {
          // InsÃ©rer juste aprÃ¨s majorations
          majorationsCard.parentNode.insertBefore(card, majorationsCard.nextSibling);
        }
      });
      console.log('âœ… Ordre tableaux restaurÃ©:', payload.tablesOrder);
    }
  }

enableDragAndDrop();

  }  // â† Ferme le if(payload.tables)
}    // â† Ferme la fonction deserializeGrid

async function saveGrid(){
  if(READ_ONLY){
    setStatus("Mode lecture seule : enregistrement dÃ©sactivÃ©.", true);
    return;
  }
  const client = getCurrentClient();
  const year = getCurrentYear();
  if(!client || !year || year === "__new_year__"){
    setStatus("SÃ©lectionner d'abord un client et une annÃ©e valide.", true);
    return;
  }
  const data = serializeGrid();
  const key = getContextKey(client, year);
  
  // 1. TOUJOURS localStorage (backup)
  try{
    localStorage.setItem(key, JSON.stringify(data));
    lastSaved = new Date(data.savedAt);
    updateLastSavedLabel();
    console.log('ğŸ’¾ Sauvegarde locale OK');
  }catch(e){
    console.error('âŒ Erreur locale:', e);
    setStatus("Erreur lors de l'enregistrement local.", true);
    updateStatusIndicator('error', 'Erreur locale');
    return;
  }
  
  // 2. TENTER Supabase cloud avec versioning
  if (isSupabaseAvailable) {
    try {
      updateStatusIndicator('saving', 'ğŸ’¾ Sauvegarde cloud...');
      await saveGridToCloud(client, parseInt(year), data);
      setStatus("âœ… SauvegardÃ© (local + cloud) " + client + " â€“ " + year, false);
      updateStatusIndicator('cloud', 'â˜ï¸ Cloud OK');
    } catch(e) {
      console.warn('âš ï¸ Cloud Ã©chouÃ©, local OK:', e);
      setStatus("âš ï¸ SauvegardÃ© localement " + client + " â€“ " + year, false);
      updateStatusIndicator('local', 'ğŸ“ Local uniquement');
    }
  } else {
    setStatus("ğŸ’¾ SauvegardÃ© localement " + client + " â€“ " + year, false);
    updateStatusIndicator('local', 'ğŸ“ Local uniquement');
  }
}
	
/**
 * ============================================================
 * SPRINT 2.6 V2 FINAL : TABLEAU DESTINATIONS IMPORTÃ‰ES
 * - Parser intelligent (dÃ©tection destination + vÃ©hicules)
 * - Tableau identique architecture existante
 * - Drag & drop lignes vers tableaux principaux
 * ============================================================
 */

// ========================================
// PARSER INTELLIGENT
// ========================================

/**
 * Parser principal - Analyse un service complet
 */
function parseService(service, factureNum) {
  const desc = service.desc || service.description || '';
  const prixHT = parsePrice(service.pu || service.prix_ht);
  const qty = parseInt(service.qty || service.quantite || 1);
  const tva = parseTVA(service.tva);
  
  return {
    destination: extractDestination(desc),
    trajet: extractTrajet(desc),
    vehicules: detectVehicules(desc, prixHT),
    prix_ht: prixHT,
    prix_unitaire: qty > 1 ? prixHT / qty : prixHT,
    quantite: qty,
    tva: tva,
    facture: factureNum,
    description_complete: desc,
    date_service: extractDate(desc)
  };
}

/**
 * Extraire destination depuis description
 */
function extractDestination(desc) {
  const patterns = [
    /(?:AR|A\/R|aller\s+retour|Aller\s+retour)\s+(?:Ã |au|aux)?\s*([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹]+(?:\s+[A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹]+)*)/i,
    /(?:vers|pour|direction|destination)\s+([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹\s\-]+)/i,
    /Gare\s+(?:d'|de\s+)?([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹\s]+)/i,
    /AÃ©roport\s+(?:d'|de\s+)?([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹\s]+)/i,
    />\s*([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹\s\-]+?)(?:\s+\d+\s*pl|\s*$)/i,
    /:\s+(?:Ã |au)\s+([A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹\s\-]+)/i
  ];
  
  for (const pattern of patterns) {
    const match = desc.match(pattern);
    if (match && match[1]) {
      let dest = match[1].trim();
      dest = dest.replace(/\s+journÃ©e.*$/i, '');
      dest = dest.replace(/\s+\d+\s*pl\.?.*$/i, '');
      return normalizeDestination(dest);
    }
  }
  
  // Fallback : mots capitalisÃ©s
  const words = desc.split(/\s+/);
  const caps = [];
  for (const word of words) {
    if (/^[A-ZÃ‰ÃˆÃŠÃ€Ã‚][a-zÃ©Ã¨ÃªÃ Ã¢Ã´Ã¹]+$/.test(word) && 
        word.length > 2 && 
        !['AR', 'Service', 'Aller'].includes(word)) {
      caps.push(word);
      if (caps.length >= 2) break;
    }
  }
  
  return caps.length > 0 ? caps.join(' ') : 'Destination non identifiÃ©e';
}

/**
 * Normaliser nom de destination
 */
function normalizeDestination(dest) {
  const mapping = {
    'Annecy Albigny': 'Annecy Albigny',
    'Albigny': 'Annecy Albigny',
    'Gd Bornand': 'Le Grand Bornand',
    'Grand Bornand': 'Le Grand Bornand',
    'St Jean de Sixt': 'Saint Jean de Sixt',
    'St Jean': 'Saint Jean de Sixt',
    'Gare Annecy': 'Gare d\'Annecy',
    'Thones': 'ThÃ´nes',
    'Aravis': 'Col des Aravis',
    'Merdassier': 'Merdassier',
    'Prises': 'Les Prises'
  };
  
  return mapping[dest] || dest;
}

/**
 * Extraire type de trajet
 */
function extractTrajet(desc) {
  if (/\bAR\b|A\/R|aller\s+retour|aller\s+et\s+retour/i.test(desc)) {
    return 'Aller et retour';
  }
  if (/\baller\b|\bdÃ©part\b/i.test(desc)) {
    return 'Aller';
  }
  if (/\bretour\b/i.test(desc)) {
    return 'Retour';
  }
  return 'Aller et retour';
}

/**
 * DÃ©tecter vÃ©hicules - RÃˆGLES EXACTES
 * "car" â†’ Autocar 55
 * "car 60", "60 pl" â†’ Autocar 64
 * "minicar" â†’ Minicar 22
 * "minicar 33" â†’ Minicar 33
 */
function detectVehicules(desc, prixHT) {
  const vehicules = [];
  const descLower = desc.toLowerCase();
  
  // DÃ©tection places
  const placesMatch = desc.match(/(\d+)\s*pl(?:\.|aces)?/i);
  const nbPlaces = placesMatch ? parseInt(placesMatch[1]) : null;
  
  // Mots-clÃ©s
  const hasAutocar = /\bcar\b|\bautocar\b/i.test(desc);
  const hasMinicar = /minicar|minibus/i.test(desc);
  const hasVL = /\bVL\b|vÃ©hicule\s+lÃ©ger/i.test(desc);
  
  // QuantitÃ©s ("1 car + 1 minicar")
  const carMatch = desc.match(/(\d+)\s+(?:auto)?car(?!\s*minicar)/i);
  const minicarMatch = desc.match(/(\d+)\s+minicar/i);
  const vlMatch = desc.match(/(\d+)\s+VL/i);
  
  // AUTOCAR
  if (hasAutocar || (nbPlaces && nbPlaces >= 45)) {
    if (nbPlaces && nbPlaces >= 60) {
      vehicules.push({ type: 'Autocar 64', count: carMatch ? parseInt(carMatch[1]) : 1 });
    } else if (nbPlaces && nbPlaces >= 55) {
      vehicules.push({ type: 'Autocar 55', count: carMatch ? parseInt(carMatch[1]) : 1 });
    } else {
      vehicules.push({ type: 'Autocar 55', count: carMatch ? parseInt(carMatch[1]) : 1 });
    }
  }
  
  // MINICAR
  if (hasMinicar || (nbPlaces && nbPlaces >= 22 && nbPlaces < 45)) {
    if (nbPlaces && nbPlaces >= 30) {
      vehicules.push({ type: 'Minicar 33', count: minicarMatch ? parseInt(minicarMatch[1]) : 1 });
    } else {
      vehicules.push({ type: 'Minicar 22', count: minicarMatch ? parseInt(minicarMatch[1]) : 1 });
    }
  }
  
  // VL
  if (hasVL || (nbPlaces && nbPlaces < 9)) {
    vehicules.push({ type: 'VL', count: vlMatch ? parseInt(vlMatch[1]) : 1 });
  }
  
  // FALLBACK PAR PRIX
  if (vehicules.length === 0) {
    if (prixHT > 600) vehicules.push({ type: 'Autocar 64', count: 1 });
    else if (prixHT > 350) vehicules.push({ type: 'Autocar 55', count: 1 });
    else if (prixHT > 200) vehicules.push({ type: 'Minicar 33', count: 1 });
    else if (prixHT > 100) vehicules.push({ type: 'Minicar 22', count: 1 });
    else vehicules.push({ type: 'VL', count: 1 });
  }
  
  return vehicules;
}

/**
 * Extraire date du service
 */
function extractDate(desc) {
  const match = desc.match(/(\d{2})\/(\d{2})\/(\d{4})/);
  return match ? `${match[3]}-${match[2]}-${match[1]}` : null;
}

/**
 * Parser prix (format "880,00 â‚¬" â†’ 880.00)
 */
function parsePrice(prix) {
  if (typeof prix === 'number') return prix;
  if (!prix) return 0;
  
  const cleaned = String(prix)
    .replace(/\s/g, '')
    .replace('â‚¬', '')
    .replace(',', '.');
  
  return parseFloat(cleaned) || 0;
}

/**
 * Parser TVA (format "10%" â†’ 10)
 */
function parseTVA(tva) {
  if (typeof tva === 'number') return tva;
  if (!tva) return 10;
  
  const match = String(tva).match(/(\d+)/);
  return match ? parseInt(match[1]) : 10;
}

// ========================================
// GÃ‰NÃ‰RATION TABLEAU
// ========================================

/**
 * GÃ©nÃ©rer HTML du tableau Destinations ImportÃ©es
 */
function renderImportedTable(gridData) {
  if (!gridData.destinations_importees || gridData.destinations_importees.length === 0) {
    return '';
  }
  
  const imported = gridData.destinations_importees;
  
  // Parser chaque item
  const rows = [];
  
  imported.forEach((item, index) => {
    const factureNum = item.facture || item.facture_num || 'FACT-XXXX';
    
    // Parser le service
    const parsed = parseService({
      desc: item.description || item.desc,
      pu: item.prix_ht,
      qty: item.quantite || 1,
      tva: item.tva || 10
    }, factureNum);
    
    // CrÃ©er row
    const totalVehicules = parsed.vehicules.reduce((sum, v) => sum + v.count, 0);
    const prixParVehicule = totalVehicules > 0 ? parsed.prix_ht / totalVehicules : parsed.prix_ht;
    
    const row = {
      id: item.id || `import-${Date.now()}-${index}`,
      destination: parsed.destination,
      trajet: parsed.trajet,
      date_service: parsed.date_service,
      description: parsed.description_complete,
      facture: factureNum,
      tva: parsed.tva,
      vehicules: {}
    };
    
    // Remplir prix par vÃ©hicule
    parsed.vehicules.forEach(veh => {
      const prix = veh.count > 1 ? prixParVehicule * veh.count : prixParVehicule;
      row.vehicules[veh.type] = {
        prix_ht: prix,
        facture: factureNum,
        count: veh.count
      };
    });
    
    rows.push(row);
  });
  
  // GÃ©nÃ©rer HTML
  let html = `
<div class="card card-draggable imported-table-card" data-table-id="imported">
  <div class="card-drag-handle" draggable="true">â‹®â‹®</div>
  <h2>ğŸ“¥ Destinations ImportÃ©es (${rows.length})</h2>
  <p class="imported-table-info">
    âš ï¸ Glissez-dÃ©posez les lignes ci-dessous vers les tableaux "Destinations" ou "Transferts" pour les intÃ©grer.
  </p>
  
  <div class="table-wrapper">
    <table class="pricing-table imported-table">
      <thead>
        <tr>
          <th class="drag-col">â‹®â‹®</th>
          <th class="dest">Destination</th>
          <th class="trajet">Trajet</th>
          
          <th class="col-no">NÂ° Fact. VL</th>
          <th class="col-ht">VL HT</th>
          <th class="col-ttc">VL TTC</th>
          
          <th class="col-no">NÂ° Fact. M22</th>
          <th class="col-ht">Minicar 22 HT</th>
          <th class="col-ttc">M22 TTC</th>
          
          <th class="col-no">NÂ° Fact. M33</th>
          <th class="col-ht">Minicar 33 HT</th>
          <th class="col-ttc">M33 TTC</th>
          
          <th class="col-no">NÂ° Fact. A55</th>
          <th class="col-ht">Autocar 55 HT</th>
          <th class="col-ttc">A55 TTC</th>
          
          <th class="col-no">NÂ° Fact. A64</th>
          <th class="col-ht">Autocar 64 HT</th>
          <th class="col-ttc">A64 TTC</th>
          
          <th class="col-note">Description</th>
          <th>Suppr.</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  rows.forEach(row => {
    html += renderImportedRow(row);
  });
  
  html += `
      </tbody>
    </table>
  </div>
  
  <div class="imported-table-actions">
    <button class="btn" onclick="clearAllImportedRows()">
      ğŸ—‘ï¸ Supprimer toutes les lignes importÃ©es
    </button>
  </div>
</div>
  `;
  
  return html;
}

/**
 * GÃ©nÃ©rer HTML d'une ligne importÃ©e
 */
function renderImportedRow(row) {
  const vehiculeCategories = ['VL', 'Minicar 22', 'Minicar 33', 'Autocar 55', 'Autocar 64'];
  const ttcMultiplier = 1 + (row.tva / 100);
  
  let html = `
<tr class="imported-row" 
    draggable="true" 
    data-import-id="${row.id}"
    data-destination="${escapeHtml(row.destination)}"
    data-trajet="${escapeHtml(row.trajet)}"
    ondragstart="handleRowDragStart(event)"
    ondragend="handleRowDragEnd(event)">
  
  <td class="drag-handle-cell">â‹®â‹®</td>
  <td class="dest">${escapeHtml(row.destination)}</td>
  <td class="trajet">${escapeHtml(row.trajet)}</td>
  `;
  
  vehiculeCategories.forEach(veh => {
    const vehData = row.vehicules[veh];
    
    if (vehData && vehData.prix_ht) {
      const ttc = vehData.prix_ht * ttcMultiplier;
      html += `
      <td class="col-no" data-vehicule="${veh}">${escapeHtml(vehData.facture)}</td>
      <td class="col-ht" data-vehicule="${veh}" data-prix-ht="${vehData.prix_ht}">${vehData.prix_ht.toFixed(2)} â‚¬</td>
      <td class="col-ttc" data-vehicule="${veh}">${ttc.toFixed(2)} â‚¬</td>
      `;
    } else {
      html += `
      <td class="col-no"></td>
      <td class="col-ht"></td>
      <td class="col-ttc"></td>
      `;
    }
  });
  
  html += `
  <td class="col-note" style="font-size: 0.75rem; color: #666;">${escapeHtml(row.description.substring(0, 50))}...</td>
  <td style="text-align: center;">
    <button class="btn-delete" onclick="deleteImportedRow('${row.id}')" title="Supprimer">ğŸ—‘ï¸</button>
  </td>
</tr>
  `;
  
  return html;
}

/**
 * Escape HTML
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// ========================================
// DRAG & DROP LIGNES
// ========================================

let currentDraggedRow = null;
let currentRowData = null;

/**
 * DÃ©but drag ligne
 */
function handleRowDragStart(event) {
  const row = event.currentTarget;
  currentDraggedRow = row;
  
  currentRowData = {
    id: row.dataset.importId,
    destination: row.dataset.destination,
    trajet: row.dataset.trajet,
    vehicules: []
  };
  
  // Extraire prix par vÃ©hicule
  const prixCells = row.querySelectorAll('[data-prix-ht]');
  prixCells.forEach(cell => {
    const veh = cell.dataset.vehicule;
    const prix = parseFloat(cell.dataset.prixHt);
    const factureCell = cell.previousElementSibling;
    const facture = factureCell ? factureCell.textContent.trim() : '';
    
    if (veh && !isNaN(prix)) {
      currentRowData.vehicules.push({
        type: veh,
        prix_ht: prix,
        facture: facture
      });
    }
  });
  
  console.log('ğŸ¯ Drag ligne:', currentRowData);
  
  row.classList.add('dragging-row');
  row.style.opacity = '0.5';
  
  event.dataTransfer.effectAllowed = 'move';
  event.dataTransfer.setData('text/plain', currentRowData.id);
}

/**
 * Fin drag
 */
function handleRowDragEnd(event) {
  event.currentTarget.classList.remove('dragging-row');
  event.currentTarget.style.opacity = '1';
  
  document.querySelectorAll('.table-drop-target').forEach(t => {
    t.classList.remove('table-drop-target');
  });
}

/**
 * Initialiser drop zones sur tableaux existants
 */
function initializeTableDropZones() {
  const tables = document.querySelectorAll('#destinationsTable, #transfertsTable');
  
  tables.forEach(table => {
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    
    tbody.addEventListener('dragover', handleTableDragOver);
    tbody.addEventListener('dragleave', handleTableDragLeave);
    tbody.addEventListener('drop', handleTableDrop);
  });
  
  console.log('âœ… Drop zones initialisÃ©es');
}

/**
 * Drag over tableau
 */
function handleTableDragOver(event) {
  if (!currentRowData) return;
  
  event.preventDefault();
  event.stopPropagation();
  event.dataTransfer.dropEffect = 'move';
  
  const tbody = event.currentTarget;
  const table = tbody.closest('table');
  table.classList.add('table-drop-target');
}

/**
 * Drag leave tableau
 */
function handleTableDragLeave(event) {
  const tbody = event.currentTarget;
  const table = tbody.closest('table');
  
  if (!event.currentTarget.contains(event.relatedTarget)) {
    table.classList.remove('table-drop-target');
  }
}

/**
 * Drop ligne dans tableau
 */
async function handleTableDrop(event) {
  event.preventDefault();
  event.stopPropagation();
  
  const tbody = event.currentTarget;
  const table = tbody.closest('table');
  table.classList.remove('table-drop-target');
  
  if (!currentRowData) {
    console.error('âŒ Pas de donnÃ©es');
    showToast('error', 'Erreur : Pas de donnÃ©es Ã  placer');
    return;
  }
  
  const tableId = table.id;
  const tableType = tableId === 'destinationsTable' ? 'destinations' : 'transferts';
  
  console.log(`ğŸ“ Drop dans: ${tableType}`);
  
  const confirmMsg = `IntÃ©grer cette ligne dans "${tableType}" ?\n\n` +
    `Destination: ${currentRowData.destination}\n` +
    `Trajet: ${currentRowData.trajet}\n` +
    `VÃ©hicules: ${currentRowData.vehicules.map(v => v.type).join(', ')}\n\n` +
    `Confirmer ?`;
  
  if (!confirm(confirmMsg)) {
    currentDraggedRow = null;
    currentRowData = null;
    return;
  }
  
  try {
    // Supprimer ligne du tableau importÃ©
    if (currentDraggedRow) {
      currentDraggedRow.remove();
    }
    
    // VÃ©rifier si tableau importÃ© vide
    const importedTable = document.querySelector('.imported-table tbody');
    if (importedTable && importedTable.children.length === 0) {
      document.querySelector('.imported-table-card').remove();
      showToast('success', 'âœ… Toutes les destinations importÃ©es ont Ã©tÃ© intÃ©grÃ©es !');
    } else {
      showToast('success', `âœ… Ligne intÃ©grÃ©e dans ${tableType}`);
    }
    
    // Note: L'intÃ©gration rÃ©elle dans la grille sera faite manuellement
    // Ce code place juste visuellement - vous ajusterez les cellules vous-mÃªme
    
  } catch (err) {
    console.error('âŒ Erreur:', err);
    showToast('error', 'Erreur : ' + err.message);
  }
  
  currentDraggedRow = null;
  currentRowData = null;
}

/**
 * Supprimer une ligne importÃ©e
 */
function deleteImportedRow(rowId) {
  if (!confirm('Supprimer cette ligne importÃ©e ?')) {
    return;
  }
  
  const row = document.querySelector(`[data-import-id="${rowId}"]`);
  if (row) {
    row.remove();
    
    const tbody = document.querySelector('.imported-table tbody');
    if (tbody && tbody.children.length === 0) {
      document.querySelector('.imported-table-card').remove();
      showToast('success', 'âœ… Toutes les lignes supprimÃ©es');
    } else {
      showToast('success', 'âœ… Ligne supprimÃ©e');
    }
  }
}

/**
 * Supprimer toutes les lignes importÃ©es
 */
function clearAllImportedRows() {
  if (!confirm('Supprimer TOUTES les lignes importÃ©es ?')) {
    return;
  }
  
  document.querySelector('.imported-table-card').remove();
  showToast('success', 'âœ… Toutes les lignes supprimÃ©es');
}

/**
 * Toast notification
 */
function showToast(type, message, duration = 3000) {
  document.querySelectorAll('.toast-notification').forEach(t => t.remove());

  const toast = document.createElement('div');
  toast.className = `toast-notification ${type}`;
  toast.textContent = message;

  document.body.appendChild(toast);

  if (duration > 0) {
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }
}

console.log('âœ… Sprint 2.6 V2 : Tableau importÃ© avec parser intelligent chargÃ©');


async function loadGrid(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  if(!client || !year || year === "__new_year__"){
    setStatus("SÃ©lectionner d'abord un client et une annÃ©e valide.", true);
    return;
  }
  
  updateStatusIndicator('saving', 'â³ Chargement...');
  
  // 1. Essayer cloud d'abord
  if (isSupabaseAvailable) {
    try {
      const cloudData = await loadGridFromCloud(client, parseInt(year));
 if (cloudData) {
        deserializeGrid(cloudData);
        
        // SPRINT 2.6: Stocker en mÃ©moire
        currentGridData = cloudData;
        
        // SPRINT 2.6: Render section importÃ©es
        const container = document.getElementById('importedSectionContainer');
        if (container) {
     container.innerHTML = renderImportedTable(cloudData);

		// Initialiser drop zones APRÃˆS render
		setTimeout(() => {
  			initializeTableDropZones();
			}, 100);
        }
        
        setStatus("â˜ï¸ ChargÃ© depuis cloud " + client + " â€“ " + year, false);
        updateStatusIndicator('cloud', 'â˜ï¸ Cloud OK');
        return;
      }
    } catch(e) {
      console.warn('âš ï¸ Cloud Ã©chouÃ©, essai local:', e);
    }
  }
  
  // 2. Fallback localStorage
  const key = getContextKey(client, year);
  const raw = localStorage.getItem(key);
  if(!raw){
    // BUGFIX V11.0.20 P0 #5: Vider interface pour nouveau client
    resetGridToInitial();
    setStatus("Aucune sauvegarde pour " + client + " â€“ " + year + " (nouvelle grille crÃ©Ã©e)", false);
    updateStatusIndicator('local', 'ğŸ“ Nouvelle grille');
    return;
  }
  try{
    const data = JSON.parse(raw);
  deserializeGrid(data);
    
    // SPRINT 2.6: Stocker en mÃ©moire
    currentGridData = data;
    
    // SPRINT 2.6: Render section importÃ©es
    const container = document.getElementById('importedSectionContainer');
    if (container) {
      container.innerHTML = renderImportedTable(data);

	// Initialiser drop zones APRÃˆS render
		setTimeout(() => {
 		 initializeTableDropZones();
		}, 100);
    }
    
    setStatus("ğŸ’¾ ChargÃ© depuis local " + client + " â€“ " + year, false);
    updateStatusIndicator('local', 'ğŸ“ Local');
  }catch(e){
    console.error(e);
    setStatus("Erreur lors du chargement local.", true);
    updateStatusIndicator('error', 'âŒ Erreur');
  }
}

// ========================================
// NOUVELLES FONCTIONNALITÃ‰S V10.3.0
// ========================================

// Export JSON
function exportGridJSON(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  if(!client || !year || year === "__new_year__"){
    setStatus("SÃ©lectionner d'abord un client et une annÃ©e valide.", true);
    return;
  }
  
  const data = serializeGrid();
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `grille_tarifaire_${client}_${year}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  setStatus(`Grille exportÃ©e : grille_tarifaire_${client}_${year}.json`, false);
}

// Import JSON
function importGridJSON(){
  const fileInput = document.getElementById('importFileInput');
  fileInput.click();
}

function handleImportFile(event){
  const file = event.target.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = async function(e){ // BUGFIX V11.0.17: async
    try{
      const data = JSON.parse(e.target.result);
      
      // VÃ©rifier que c'est bien une grille valide
      if(!data.client || !data.year || !Array.isArray(data.rows)){
        setStatus("Fichier JSON invalide : format de grille non reconnu.", true);
        return;
      }
      
      // Demander confirmation
      const msg = `Importer la grille de ${data.client} â€“ ${data.year} ?\n` +
                  `Cela va :\n` +
                  `1. Changer le client vers "${data.client}"\n` +
                  `2. Changer l'annÃ©e vers "${data.year}"\n` +
                  `3. Remplacer toutes les donnÃ©es actuelles\n` +
                  `4. CrÃ©er le client dans le cloud si nÃ©cessaire\n\n` +
                  `Les donnÃ©es actuelles seront Ã©crasÃ©es. Continuer ?`;
      
      if(!confirm(msg)) return;
      
      // Charger la grille importÃ©e
      deserializeGrid(data);
      
      // Mettre Ã  jour les sÃ©lecteurs
      const clientSel = document.getElementById('clientSelect');
      
      // BUGFIX V11.0.16: VÃ©rifier doublons avec normalisation complÃ¨te (casse, espaces, accents)
      function normalizeClientName(name) {
        return name.trim()
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, ''); // Supprimer les accents
      }
      
      const clientNameNormalized = normalizeClientName(data.client);
      let clientOpt = null;
      
      for(const opt of clientSel.options){
        if(opt.value === "__new_client__") continue;
        const optTextNormalized = normalizeClientName(opt.textContent);
        const optValueNormalized = normalizeClientName(opt.value);
        
        if(optTextNormalized === clientNameNormalized || optValueNormalized === clientNameNormalized){
          clientOpt = opt;
          break;
        }
      }
      
      if(!clientOpt){
        clientOpt = document.createElement('option');
        clientOpt.value = data.client.trim();
        clientOpt.textContent = data.client.trim();
        clientSel.insertBefore(clientOpt, clientSel.querySelector('option[value="__new_client__"]'));
        console.log('âœ… Nouveau client ajoutÃ© au select:', data.client);
      } else {
        console.log('âœ… Client existant trouvÃ©:', clientOpt.textContent);
      }
      
      clientSel.value = clientOpt.value;
      
      await populateYearSelectForClient(data.client, data.year); // BUGFIX V11.0.20: await
      
      // BUGFIX V11.0.18: Forcer l'ajout de l'annÃ©e importÃ©e si elle n'existe pas dans le select
      const yearSelect = document.getElementById("yearSelect");
      if(yearSelect && !Array.from(yearSelect.options).some(o => o.value === String(data.year))){
        const optYear = document.createElement("option");
        optYear.value = String(data.year);
        optYear.textContent = String(data.year);
        
        // Trouver la position correcte pour insertion (ordre chronologique)
        const yearNum = parseInt(data.year);
        let insertBefore = null;
        
        for(let opt of yearSelect.options){
          if(opt.value === "__new_year__"){
            insertBefore = opt;
            break;
          }
          const optYear = parseInt(opt.value);
          if(!isNaN(optYear) && optYear > yearNum){
            insertBefore = opt;
            break;
          }
        }
        
        if(insertBefore){
          yearSelect.insertBefore(optYear, insertBefore);
        } else {
          yearSelect.appendChild(optYear);
        }
        
        console.log('âœ… AnnÃ©e importÃ©e ajoutÃ©e au select:', data.year);
      }
      
      yearSelect.value = String(data.year);
      currentContext.client = data.client;
      currentContext.year = String(data.year);
      updateTitleSubtitle();
      
      setStatus(`âœ“ Grille importÃ©e : ${data.client} â€“ ${data.year} | Sauvegarde en cours...`, false);
      
      // BUGFIX V11.0.17: Sauvegarder avec crÃ©ation auto du client dans cloud
      await saveGrid();
      
      // BUGFIX v11.0.23: Recharger annÃ©es depuis cloud aprÃ¨s sauvegarde
      console.log('ğŸ”„ Rechargement annÃ©es depuis cloud aprÃ¨s import...');
      await populateYearSelectForClient(data.client, data.year);
      yearSelect.value = String(data.year); // Re-sÃ©lectionner l'annÃ©e importÃ©e
      
      setStatus(`âœ… Grille importÃ©e et sauvegardÃ©e : ${data.client} â€“ ${data.year}`, false);
      
    }catch(err){
      console.error(err);
      setStatus("Erreur lors de l'import : fichier JSON corrompu.", true);
    }
  };
  
  reader.readAsText(file);
  event.target.value = ''; // Reset input
}

// Export CSV
function exportGridCSV(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  if(!client || !year || year === "__new_year__"){
    setStatus("SÃ©lectionner d'abord un client et une annÃ©e valide.", true);
    return;
  }
  
  const data = serializeGrid();
  
  // En-tÃªtes CSV
  let csv = 'Destination;Trajet;VL HT;VL TTC;VL NÂ° Fact;MC22 HT;MC22 TTC;MC22 NÂ° Fact;MC33 HT;MC33 TTC;MC33 NÂ° Fact;AC55 HT;AC55 TTC;AC55 NÂ° Fact;AC64 HT;AC64 TTC;AC64 NÂ° Fact;Note\n';
  
  // Lignes de donnÃ©es
  data.rows.forEach(row => {
    const dest = (row.dest || '').replace(/;/g, ','); // Ã‰chapper points-virgules
    const trajet = (row.trajet || '').replace(/_/g, ' ');
    const note = (row.note || '').replace(/;/g, ',');
    
    const tva = getTVA();
    const formatPrice = (ht) => {
      if(!ht) return '';
      const ttc = ht * (1 + tva);
      return `${ht.toFixed(2)};${ttc.toFixed(2)}`;
    };
    
    csv += `${dest};${trajet};`;
    
    VEHICULES.forEach(cat => {
      const ht = row.tarifs && row.tarifs[cat] ? row.tarifs[cat] : null;
      const facture = row.factures && row.factures[cat] ? row.factures[cat] : '';
      
      if(ht){
        const ttc = ht * (1 + tva);
        csv += `${ht.toFixed(2)};${ttc.toFixed(2)};${facture};`;
      } else {
        csv += `;;${facture};`;
      }
    });
    
    csv += `${note}\n`;
  });
  
  // TÃ©lÃ©charger
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `grille_tarifaire_${client}_${year}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  setStatus(`Grille exportÃ©e en CSV : grille_tarifaire_${client}_${year}.csv`, false);
}

// Dupliquer annÃ©e
function duplicateYear(){
  const client = getCurrentClient();
  const currentYear = getCurrentYear();
  
  if(!client || !currentYear || currentYear === "__new_year__"){
    setStatus("SÃ©lectionner d'abord un client et une annÃ©e source valide.", true);
    return;
  }
  
  const newYearStr = prompt(`Dupliquer l'annÃ©e ${currentYear} vers quelle nouvelle annÃ©e ?\n(Format : AAAA, exemple : ${parseInt(currentYear,10) + 1})`);
  
  if(!newYearStr) return; // AnnulÃ©
  
  const newYear = parseInt(newYearStr, 10);
  
  // Validation
  if(isNaN(newYear) || newYear < 2000 || newYear > 2099){
    setStatus("AnnÃ©e invalide. Utilisez un format AAAA entre 2000 et 2099.", true);
    return;
  }
  
  // VÃ©rifier si l'annÃ©e existe dÃ©jÃ 
  const existingYears = getStoredYearsForClient(client);
  if(existingYears.includes(newYear)){
    if(!confirm(`L'annÃ©e ${newYear} existe dÃ©jÃ  pour ${client}. Ã‰craser les donnÃ©es ?`)){
      return;
    }
  }
  
  // Dupliquer les donnÃ©es
  const currentData = serializeGrid();
  const newData = {
    version: currentData.version || "10.4.3",
    tva: currentData.tva,
    savedAt: new Date().toISOString(),
    tables: JSON.parse(JSON.stringify(currentData.tables || {})), // Deep copy
    tablesOrder: currentData.tablesOrder ? [...currentData.tablesOrder] : []
  };
  
  // Sauvegarder la nouvelle annÃ©e
  const newKey = getContextKey(client, newYear);
  try{
    localStorage.setItem(newKey, JSON.stringify(newData));
    
    // Passer Ã  la nouvelle annÃ©e
    populateYearSelectForClient(client, newYear);
    currentContext.year = newYear;
    updateTitleSubtitle();
    loadGridForCurrentContext();
    
    const totalRows = Object.values(newData.tables).reduce((sum, t) => sum + (t.rows?.length || 0), 0);
    setStatus(`AnnÃ©e ${currentYear} dupliquÃ©e vers ${newYear} avec succÃ¨s ! ${totalRows} lignes copiÃ©es dans ${Object.keys(newData.tables).length} tableau(x).`, false);
  }catch(e){
    console.error(e);
    setStatus("Erreur lors de la duplication de l'annÃ©e.", true);
  }
}

// Renommer un client
function renameClient(){
  const currentClient = getCurrentClient();
  
  if(!currentClient || currentClient === "__new_client__"){
    setStatus("SÃ©lectionner d'abord un client valide Ã  renommer.", true);
    return;
  }
  
  const newName = prompt(`Renommer le client "${currentClient}" vers quel nouveau nom ?`, currentClient);
  
  if(!newName) return; // AnnulÃ©
  if(newName === currentClient){
    setStatus("Le nouveau nom est identique Ã  l'ancien.", false);
    return;
  }
  
  // Normaliser (trim seulement) v11.0.6
  const newClientName = newName.trim();
  
  if(!newClientName){
    setStatus("Le nom du client ne peut pas Ãªtre vide.", true);
    return;
  }
  
  // VÃ©rifier si le nouveau nom existe dÃ©jÃ 
  const clientsList = JSON.parse(localStorage.getItem(STORAGE_PREFIX + "CLIENTS_LIST") || "[]");
  if(clientsList.includes(newClientName)){
    setStatus(`Le client "${newClientName}" existe dÃ©jÃ . Choisissez un autre nom.`, true);
    return;
  }
  
  // Confirmation
  const yearsCount = getStoredYearsForClient(currentClient).length;
  const msg = `Renommer "${currentClient}" en "${newClientName}" ?\n\n` +
              `Cela va renommer le client pour ${yearsCount} annÃ©e(s) sauvegardÃ©e(s).\n\n` +
              `Cette opÃ©ration est irrÃ©versible. Continuer ?`;
  
  if(!confirm(msg)) return;
  
  try {
    // 1. RÃ©cupÃ©rer toutes les clÃ©s localStorage du client actuel
    const keysToRename = [];
    for(let i = 0; i < localStorage.length; i++){
      const key = localStorage.key(i);
      if(key && key.startsWith(STORAGE_PREFIX + currentClient + "::")){
        keysToRename.push(key);
      }
    }
    
    // 2. Copier les donnÃ©es avec le nouveau nom
    keysToRename.forEach(oldKey => {
      const data = localStorage.getItem(oldKey);
      if(data){
        try {
          const parsed = JSON.parse(data);
          parsed.client = newClientName; // Mettre Ã  jour le nom dans les donnÃ©es
          
          const newKey = oldKey.replace(STORAGE_PREFIX + currentClient + "::", STORAGE_PREFIX + newClientName + "::");
          localStorage.setItem(newKey, JSON.stringify(parsed));
        } catch(e){
          console.error("Erreur parsing:", oldKey, e);
        }
      }
    });
    
    // 3. Supprimer les anciennes clÃ©s
    keysToRename.forEach(oldKey => {
      localStorage.removeItem(oldKey);
    });
    
    // 4. Mettre Ã  jour la liste des clients
    const index = clientsList.indexOf(currentClient);
    if(index > -1){
      clientsList[index] = newClientName;
      localStorage.setItem(STORAGE_PREFIX + "CLIENTS_LIST", JSON.stringify(clientsList));
    }
    
    // 5. Mettre Ã  jour le sÃ©lecteur et recharger
    const clientSel = document.getElementById("clientSelect");
    const option = Array.from(clientSel.options).find(o => o.value === currentClient);
    if(option){
      option.value = newClientName;
      option.textContent = newClientName;
    }
    
    clientSel.value = newClientName;
    currentContext.client = newClientName;
    updateTitleSubtitle();
    
    setStatus(`Client renommÃ© avec succÃ¨s : "${currentClient}" â†’ "${newClientName}" (${yearsCount} annÃ©e(s) mises Ã  jour)`, false);
    
    // Recharger la grille actuelle
    loadGridForCurrentContext();
    
  } catch(e){
    console.error(e);
    setStatus("Erreur lors du renommage du client.", true);
  }
}

// ========================================
// TABLEAUX DYNAMIQUES V10.4.0 - VERSION SIMPLE
// ========================================

function renderTablesManager(){
  try {
    const container = document.getElementById("tablesManager");
    if(!container) return;
    
    container.innerHTML = "";
    
    // S'assurer que les tableaux HTML correspondants sont visibles
    tables.forEach(table => {
      const tableElement = document.getElementById(table.id + 'Table');
      if(tableElement){
        const card = tableElement.closest('.card');
        if(card){
          card.style.display = '';
          delete card.dataset.deleted;
        }
      }
    });
    
    // Masquer les tableaux qui ne sont plus dans la liste
    document.querySelectorAll('[id$="Table"]').forEach(tableElement => {
      const tableId = tableElement.id.replace('Table', '');
      if(tableId === 'destinations' || tableId === 'transferts'){
        const exists = tables.some(t => t.id === tableId);
        if(!exists){
          const card = tableElement.closest('.card');
          if(card){
            card.style.display = 'none';
            card.dataset.deleted = 'true';
          }
        }
      }
    });
    
    tables.forEach((table, index) => {
      const div = document.createElement("div");
      div.className = "table-item";
      div.draggable = true;
      div.dataset.tableId = table.id;
      div.style.cursor = 'move';
      
      div.innerHTML = `
        <span style="font-size:1.5rem; cursor:move;">â˜° ${table.icon}</span>
        <div class="table-info">
          <div class="table-name">${table.name}</div>
          <div class="table-meta">ID: ${table.id}</div>
        </div>
        <div class="table-actions">
          <button type="button" class="btn" onclick="changeTableIcon('${table.id}')" title="Changer l'icÃ´ne">ğŸ¨</button>
          <button type="button" class="btn" onclick="renameTable('${table.id}')" title="Renommer">âœï¸</button>
          ${tables.length > 1 ? `<button type="button" class="btn btn-ghost" onclick="deleteTable('${table.id}')" title="Supprimer">ğŸ—‘ï¸</button>` : ''}
        </div>
      `;
      
      // Drag & Drop events
      div.addEventListener('dragstart', function(e){
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', table.id);
        this.style.opacity = '0.5';
      });
      
      div.addEventListener('dragend', function(){
        this.style.opacity = '1';
      });
      
      div.addEventListener('dragover', function(e){
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.style.borderTop = '3px solid #428bca';
      });
      
      div.addEventListener('dragleave', function(){
        this.style.borderTop = '';
      });
      
      div.addEventListener('drop', function(e){
        e.preventDefault();
        this.style.borderTop = '';
        
        const draggedId = e.dataTransfer.getData('text/plain');
        const targetId = this.dataset.tableId;
        
        if(draggedId === targetId) return;
        
        // RÃ©organiser
        const draggedIndex = tables.findIndex(t => t.id === draggedId);
        const targetIndex = tables.findIndex(t => t.id === targetId);
        
        const [draggedTable] = tables.splice(draggedIndex, 1);
        tables.splice(targetIndex, 0, draggedTable);
        
        // RÃ©organiser les cards HTML
        reorderTableCards();
        
        renderTablesManager();
        console.log('âœ… Tableaux rÃ©organisÃ©s:', tables.map(t => t.name));
      });
      
      container.appendChild(div);
    });
  } catch(e){
    console.error("Erreur renderTablesManager:", e);
  }
}

// RÃ©organiser les cards HTML selon l'ordre des tableaux
function reorderTableCards(){
  const majorationsCard = document.querySelector('.card-majorations');
  
  if(!majorationsCard) {
    console.warn('Card majorations non trouvÃ©e');
    return;
  }
  
  // Placer chaque tableau APRÃˆS la card majorations, dans l'ordre
  tables.forEach((table, index) => {
    const tableElement = document.getElementById(table.id + 'Table');
    if(tableElement){
      const card = tableElement.closest('.card');
      if(card && card !== majorationsCard){
        // InsÃ©rer aprÃ¨s majorations (ou aprÃ¨s le tableau prÃ©cÃ©dent)
        if(index === 0){
          // Premier tableau : aprÃ¨s majorations
          majorationsCard.parentNode.insertBefore(card, majorationsCard.nextSibling);
        } else {
          // Tableaux suivants : aprÃ¨s le prÃ©cÃ©dent
          const prevTableId = tables[index - 1].id;
          const prevTableElement = document.getElementById(prevTableId + 'Table');
          if(prevTableElement){
            const prevCard = prevTableElement.closest('.card');
            if(prevCard){
              prevCard.parentNode.insertBefore(card, prevCard.nextSibling);
            }
          }
        }
      }
    }
  });
}

function createTable(){
  try {
    const name = prompt("Nom du nouveau tableau :", "Nouveau tableau");
    if(!name) return;
    
    const nameTrimmed = name.trim();
    if(!nameTrimmed){
      alert("Le nom du tableau ne peut pas Ãªtre vide.");
      return;
    }
    
    const id = nameTrimmed.toLowerCase().replace(/[^a-z0-9]+/g, '_') + '_' + Date.now();
    const icons = ['ğŸ“‹', 'ğŸ¯', 'ğŸš€', 'â­', 'ğŸ¨', 'ğŸ”§', 'ğŸ“¦', 'ğŸª', 'ğŸŒŸ', 'ğŸ’¼'];
    const icon = icons[Math.floor(Math.random() * icons.length)];
    
    const newTable = {
      id: id,
      name: nameTrimmed,
      icon: icon,
      order: tables.length
    };
    
    tables.push(newTable);
    tableCounters[id] = 0;
    
    // CrÃ©er le HTML du tableau
    const card = createTableHTML(newTable);
    if(card){
      // InsÃ©rer APRÃˆS la card majorations
      const majorationsCard = document.querySelector('.card-majorations');
      if(majorationsCard){
        majorationsCard.parentNode.insertBefore(card, majorationsCard.nextSibling);
      } else {
        // Fallback : Ã  la fin
        document.querySelector('.page').appendChild(card);
      }
      
      // Ajouter une ligne par dÃ©faut
      addRowToCustomTable(id);
      
      // Appliquer la visibilitÃ© des colonnes
      applyColumnVisibility();
      
      // RÃ©activer le drag & drop pour le nouveau tableau
      enableDragAndDrop();
    }
    
    setStatus(`Tableau "${nameTrimmed}" crÃ©Ã© avec succÃ¨s !`, false);
    renderTablesManager();
    
    // Sauvegarder automatiquement
    saveGrid();
    
  } catch(e){
    console.error("Erreur createTable:", e);
    alert("Erreur lors de la crÃ©ation du tableau : " + e.message);
  }
}

function renameTable(tableId){
  try {
    const table = tables.find(t => t.id === tableId);
    if(!table) return;
    
    const newName = prompt(`Renommer le tableau "${table.name}" :`, table.name);
    if(!newName) return;
    
    const nameTrimmed = newName.trim();
    if(!nameTrimmed){
      alert("Le nom du tableau ne peut pas Ãªtre vide.");
      return;
    }
    
    table.name = nameTrimmed;
    setStatus(`Tableau renommÃ© : "${nameTrimmed}"`, false);
    
    // Mettre Ã  jour le titre HTML (pour tous les tableaux)
    const titleEl = document.getElementById(tableId + 'Title');
    if(titleEl){
      titleEl.textContent = `${table.icon} ${nameTrimmed}`;
    }
    
    // Mettre Ã  jour le bouton "Ajouter ligne" si c'est un tableau personnalisÃ©
    const card = document.getElementById(tableId + 'Card');
    if(card){
      const btn = card.querySelector('.toolbar button');
      if(btn){
        btn.textContent = `+ Ajouter une ligne Ã  ${nameTrimmed}`;
      }
    }
    
    renderTablesManager();
    
    // Sauvegarder automatiquement
    saveGrid();
  } catch(e){
    console.error("Erreur renameTable:", e);
  }
}

function changeTableIcon(tableId){
  try {
    const table = tables.find(t => t.id === tableId);
    if(!table) return;
    
    const icons = ['ğŸ“', 'ğŸš‰', 'ğŸ“‹', 'ğŸ¯', 'ğŸš€', 'â­', 'ğŸ¨', 'ğŸ”§', 'ğŸ“¦', 'ğŸª', 'ğŸŒŸ', 'ğŸ’¼', 'ğŸ–ï¸', 'ğŸ“', 'ğŸ¢', 'ğŸšŒ', 'âœˆï¸', 'ğŸ­', 'ğŸ¬', 'ğŸ®', 'ğŸ“š', 'ğŸ†', 'ğŸ¸'];
    
    let iconList = "Choisissez une icÃ´ne (entrez le numÃ©ro) :\n\n";
    icons.forEach((ic, idx) => {
      iconList += `${idx + 1}. ${ic}  `;
      if((idx + 1) % 6 === 0) iconList += "\n";
    });
    
    const choice = prompt(iconList + `\n\nActuel : ${table.icon}`, "");
    if(!choice) return;
    
    const index = parseInt(choice, 10) - 1;
    if(isNaN(index) || index < 0 || index >= icons.length){
      alert("NumÃ©ro invalide.");
      return;
    }
    
    table.icon = icons[index];
    
    // Mettre Ã  jour le titre HTML
    const titleEl = document.getElementById(tableId + 'Title');
    if(titleEl){
      titleEl.textContent = `${table.icon} ${table.name}`;
    }
    
    renderTablesManager();
    setStatus(`IcÃ´ne du tableau "${table.name}" changÃ©e en ${table.icon}`, false);
    
    // Sauvegarder automatiquement
    saveGrid();
  } catch(e){
    console.error("Erreur changeTableIcon:", e);
  }
}

function deleteTable(tableId){
  try {
    const table = tables.find(t => t.id === tableId);
    if(!table) return;
    
    if(tables.length <= 1){
      alert("Impossible de supprimer le dernier tableau.");
      return;
    }
    
    if(!confirm(`Supprimer le tableau "${table.name}" ?`)){
      return;
    }
    
    // Supprimer de la liste
    tables = tables.filter(t => t.id !== tableId);
    delete tableCounters[tableId];
    
    // Supprimer le HTML
    const tableElement = document.getElementById(tableId + 'Table');
    if(tableElement){
      const card = tableElement.closest('.card');
      if(card){
        // Pour les tableaux par dÃ©faut (destinations/transferts), juste masquer
        if(tableId === 'destinations' || tableId === 'transferts'){
          card.style.display = 'none';
          card.dataset.deleted = 'true';
        } else {
          // Pour les tableaux personnalisÃ©s, supprimer complÃ¨tement
          card.remove();
        }
      }
    }
    
    setStatus(`Tableau "${table.name}" supprimÃ©.`, false);
    renderTablesManager();
    
    // Sauvegarder automatiquement
    saveGrid();
  } catch(e){
    console.error("Erreur deleteTable:", e);
  }
}

// ========================================
// FIN TABLEAUX DYNAMIQUES V10.4.0
// ========================================

// CrÃ©er dynamiquement le HTML d'un tableau complet
function createTableHTML(table){
  try {
    // CrÃ©er la carte
const card = document.createElement('div');
card.className = 'card card-draggable';
card.id = table.id + 'Card';
card.setAttribute('data-table-id', table.id);

// Ajouter handle de drag
const dragHandle = document.createElement('div');
dragHandle.className = 'card-drag-handle';
dragHandle.setAttribute('draggable', 'true');
dragHandle.textContent = 'â‹®â‹®';
card.appendChild(dragHandle);

// Titre
const h2 = document.createElement('h2');
h2.id = table.id + 'Title';
h2.textContent = `${table.icon} ${table.name}`;
card.appendChild(h2);
    
    // Description
    const p = document.createElement('p');
    p.textContent = `Tableau personnalisÃ© : ${table.name}`;
    card.appendChild(p);
    
    // Wrapper du tableau
    const wrapper = document.createElement('div');
    wrapper.className = 'table-wrapper';
    
    // Tableau
    const tableElem = document.createElement('table');
    tableElem.id = table.id + 'Table';
    tableElem.className = 'pricing-table';
    
    // Header (identique Ã  Destinations)
    tableElem.innerHTML = `
      <thead>
        <tr>
          <th class="highlight-col">âš‘</th>
          <th class="dest">Destination</th>
          <th class="trajet">Trajet</th>
          <th class="group-VL col-no">NÂ° Fact. VL</th>
          <th class="group-VL col-ht">VL HT</th>
          <th class="group-VL col-ttc">VL TTC</th>
          <th class="group-VL col-evol">Ã‰vol. VL (%)</th>
          <th class="group-MC22 col-no">NÂ° Fact. Minicar 22</th>
          <th class="group-MC22 col-ht">Minicar 22 HT</th>
          <th class="group-MC22 col-ttc">Minicar 22 TTC</th>
          <th class="group-MC22 col-evol">Ã‰vol. Min. 22 (%)</th>
          <th class="group-MC33 col-no">NÂ° Fact. Minicar 33</th>
          <th class="group-MC33 col-ht">Minicar 33 HT</th>
          <th class="group-MC33 col-ttc">Minicar 33 TTC</th>
          <th class="group-MC33 col-evol">Ã‰vol. Min. 33 (%)</th>
          <th class="group-AC55 col-no">NÂ° Fact. Autocar 55</th>
          <th class="group-AC55 col-ht">Autocar 55 HT</th>
          <th class="group-AC55 col-ttc">Autocar 55 TTC</th>
          <th class="group-AC55 col-evol">Ã‰vol. A55 (%)</th>
          <th class="group-AC64 col-no">NÂ° Fact. Autocar 64</th>
          <th class="group-AC64 col-ht">Autocar 64 HT</th>
          <th class="group-AC64 col-ttc">Autocar 64 TTC</th>
          <th class="group-AC64 col-evol">Ã‰vol. A64 (%)</th>
          <th class="col-note">Note</th>
          <th>Suppr.</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    
    wrapper.appendChild(tableElem);
    card.appendChild(wrapper);
    
    // Toolbar avec bouton ajouter ligne
    const toolbar = document.createElement('div');
    toolbar.className = 'toolbar';
    
    const btnAdd = document.createElement('button');
    btnAdd.type = 'button';
    btnAdd.className = 'btn';
    btnAdd.textContent = `+ Ajouter une ligne Ã  ${table.name}`;
    btnAdd.onclick = function(){ addRowToCustomTable(table.id); };
    toolbar.appendChild(btnAdd);
    
    card.appendChild(toolbar);
    
    return card;
  } catch(e){
    console.error("Erreur createTableHTML:", e);
    return null;
  }
}

// Ajouter une ligne Ã  un tableau personnalisÃ©
function addRowToCustomTable(tableId){
  try {
    const table = tables.find(t => t.id === tableId);
    if(!table){
      console.error("Tableau introuvable:", tableId);
      return;
    }
    
    // Utiliser createRow avec un type custom
    const tbody = document.querySelector(`#${tableId}Table tbody`);
    if(!tbody){
      console.error("Tbody introuvable pour:", tableId);
      return;
    }
    
    // CrÃ©er une ligne similaire Ã  createRow mais pour tableau custom
    const index = ++tableCounters[tableId];
    const uniqueId = Date.now() + "_" + Math.random().toString(36).substr(2, 9);
    const trajId = tableId + "_" + uniqueId;
    
    const tr = document.createElement("tr");
    tr.dataset.trajet = trajId;
    tr.dataset.index = String(index);
    tr.dataset.freq = "0";
    
    // Colonne highlight
    const tdMark = document.createElement("td");
    tdMark.className = "highlight-col";
    
    // Ajouter le handle de drag (â‹®â‹®)
    const handle = document.createElement("span");
    handle.className = "drag-handle";
    handle.innerHTML = "â‹®â‹®";
    handle.title = "Glisser pour rÃ©organiser";
    handle.setAttribute("draggable", "true");
    tdMark.appendChild(handle);
    
    const mark = document.createElement("input");
    mark.type = "checkbox";
    mark.className = "highlight-toggle";
    mark.addEventListener("change", function(){
      tr.classList.toggle("row-highlight", mark.checked);
    });
    tdMark.appendChild(mark);
    tr.appendChild(tdMark);
    
    // Destination
    const tdDest = document.createElement("td");
    tdDest.className = "dest";
    const inputName = document.createElement("input");
    inputName.type = "text";
    inputName.className = "dest-name";
    inputName.value = `${table.name} ${index}`;
    inputName.setAttribute("list","destinationsList");
    applyTooltip(inputName);
    tdDest.appendChild(inputName);
    tr.appendChild(tdDest);
    
    // Trajet
    const tdTrajet = document.createElement("td");
    tdTrajet.className = "trajet";
    const sel = document.createElement("select");
    sel.className = "trajet-select";
    [["aller_retour","Aller et retour"],["aller","Aller"],["retour","Retour"]].forEach(([val,lab])=>{
      const opt=document.createElement("option");
      opt.value=val;
      opt.textContent=lab;
      sel.appendChild(opt);
    });
    tdTrajet.appendChild(sel);
    tr.appendChild(tdTrajet);
    
    // Colonnes vÃ©hicules
    VEHICULES.forEach(cat => {
      const groupClass = "group-" + cat;
      
      // NÂ° Facture
      let tdF = document.createElement("td");
      tdF.className = groupClass + " col-no";
      const inF = document.createElement("input");
      inF.type = "text";
      inF.className = "facture-input";
      applyTooltip(inF);
      tdF.appendChild(inF);
      tr.appendChild(tdF);
      
      // HT
      tdF = document.createElement("td");
      tdF.className = groupClass + " col-ht";
      const inHT = document.createElement("input");
      inHT.type = "text";
      inHT.className = "price-input";
      inHT.dataset.key = trajId + "|" + cat + "|HT";
      applyTooltip(inHT);
      tdF.appendChild(inHT);
      tr.appendChild(tdF);
      
      // TTC
      tdF = document.createElement("td");
      tdF.className = groupClass + " col-ttc";
      const inTTC = document.createElement("input");
      inTTC.type = "text";
      inTTC.className = "ttc-input";
      inTTC.dataset.key = trajId + "|" + cat + "|TTC";
      applyTooltip(inTTC);
      tdF.appendChild(inTTC);
      tr.appendChild(tdF);
      
      // Ã‰volution
      tdF = document.createElement("td");
      tdF.className = groupClass + " col-evol evol-cell";
      tr.appendChild(tdF);
    });
    
    // Note
    const tdNote = document.createElement("td");
    tdNote.className = "col-note";
    const inputNote = document.createElement("input");
    inputNote.type = "text";
    inputNote.className = "note-input";
    inputNote.maxLength = 200;
    applyTooltip(inputNote);
    tdNote.appendChild(inputNote);
    tr.appendChild(tdNote);
    
    // Delete
    const tdDel = createDeleteCell();
    tdDel.querySelector('.btn-delete').addEventListener('click', function(){
      if(confirm("Supprimer cette ligne ?")){
        tr.remove();
      }
    });
    tr.appendChild(tdDel);
    
    tbody.appendChild(tr);
    
    // RÃ©attacher les event listeners HT/TTC
    attachPriceListeners();
    
  } catch(e){
    console.error("Erreur addRowToCustomTable:", e);
  }
}

// Attacher les event listeners pour HT/TTC (aprÃ¨s crÃ©ation dynamique)
function attachPriceListeners(){
  document.querySelectorAll('.price-input').forEach(input => {
    if(!input.dataset.listenerAttached){
      input.addEventListener('input', function(){ updateFromHT(input); });
      input.addEventListener('blur', function(){
        const v = parseNumberFR(input.value);
        if(!isNaN(v)) input.value = formatNumberFR(v, 2);
      });
      input.dataset.listenerAttached = 'true';
    }
  });
  
  document.querySelectorAll('.ttc-input').forEach(input => {
    if(!input.dataset.listenerAttached){
      input.addEventListener('input', function(){ updateFromTTC(input); });
      input.addEventListener('blur', function(){
        const v = parseNumberFR(input.value);
        if(!isNaN(v)) input.value = formatNumberFR(v, 2);
      });
      input.dataset.listenerAttached = 'true';
    }
  });
}

// Drag & Drop pour tri manuel des destinations
let draggedRow = null;

function enableDragAndDrop(){
  // Activer le drag & drop pour TOUS les tableaux (destinations, transferts, personnalisÃ©s)
  tables.forEach(table => {
    const tbody = document.querySelector(`#${table.id}Table tbody`);
    if(!tbody) return;
    
    // Ã‰viter de rÃ©attacher plusieurs fois
    if(tbody.dataset.dragEnabled) return;
    tbody.dataset.dragEnabled = 'true';
    
    tbody.addEventListener('dragstart', function(e){
      if(e.target.classList.contains('drag-handle')){
        const tr = e.target.closest('tr');
        if(tr){
          draggedRow = tr;
          tr.style.opacity = '0.5';
        }
      } else {
        e.preventDefault();
        return false;
      }
    });
    
    tbody.addEventListener('dragend', function(e){
      if(draggedRow){
        draggedRow.style.opacity = '';
        draggedRow = null;
        
        // BUGFIX v11.0.22: Sauvegarder aprÃ¨s rÃ©organisation des lignes
        triggerAutoSave();
      }
    });
    
    tbody.addEventListener('dragover', function(e){
      e.preventDefault();
      const targetRow = e.target.closest('tr');
      if(targetRow && targetRow !== draggedRow && draggedRow){
        const rect = targetRow.getBoundingClientRect();
        const midpoint = rect.top + rect.height / 2;
        
        if(e.clientY < midpoint){
          tbody.insertBefore(draggedRow, targetRow);
        } else {
          tbody.insertBefore(draggedRow, targetRow.nextSibling);
        }
      }
    });
  });
  
  // Ajouter les handles sur toutes les lignes existantes
  addDragHandlesToRows();
}

// Ajouter un handle de drag (â‹®â‹®) Ã  toutes les lignes de tous les tableaux
function addDragHandlesToRows(){
  tables.forEach(table => {
    document.querySelectorAll(`#${table.id}Table tbody tr`).forEach(tr => {
      // VÃ©rifier si le handle existe dÃ©jÃ 
      if(tr.querySelector('.drag-handle')) return;
      
      // Trouver la premiÃ¨re cellule (celle avec âš‘)
      const firstCell = tr.querySelector('td.highlight-col');
      if(!firstCell) return;
      
      // CrÃ©er le handle de drag
      const handle = document.createElement('span');
      handle.className = 'drag-handle';
      handle.innerHTML = 'â‹®â‹®';
      handle.title = 'Glisser pour rÃ©organiser';
      handle.setAttribute('draggable', 'true');
      
      // InsÃ©rer le handle au dÃ©but de la cellule
      firstCell.insertBefore(handle, firstCell.firstChild);
    });
  });
}

function makeRowsDraggable(){
  // Cette fonction est maintenant gÃ©rÃ©e par addDragHandlesToRows
  addDragHandlesToRows();
}

async function loadPreviousYearPayload(){
  const client = getCurrentClient();
  const year = parseInt(getCurrentYear(),10);
  if(!client || !year || isNaN(year)) return null;
  const prevYear = year - 1;
  
  // 1. Essayer localStorage d'abord (plus rapide)
  const key = getContextKey(client, prevYear);
  const raw = localStorage.getItem(key);
  if(raw) {
    try{
      return JSON.parse(raw);
    }catch{
      // Continue to cloud
    }
  }
  
  // 2. Fallback Supabase cloud (si localStorage vide/erreur)
  if(isSupabaseAvailable){
    try {
      const cloudData = await loadGridFromCloud(client, prevYear);
      if(cloudData) {
        console.log(`âœ… AnnÃ©e N-1 (${prevYear}) chargÃ©e depuis cloud pour Ã©volutions`);
        return cloudData;
      }
    } catch(err) {
      console.warn('âš ï¸ Erreur chargement N-1 cloud:', err);
    }
  }
  
  return null;
}

// ========== DÃ‰TECTION PRIX DUPLIQUÃ‰S V11.0.6 ==========
function markUnchangedPrices(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  
  if(!client || !year) return;
  
  const prevYear = (parseInt(year, 10) - 1).toString();
  const prevKey = 'grille_' + client + '_' + prevYear;
  const prevDataStr = localStorage.getItem(prevKey);
  
  if(!prevDataStr) {
    // Supprimer toutes les classes unchanged
    document.querySelectorAll('.price-unchanged').forEach(el => {
      el.classList.remove('price-unchanged');
    });
    return;
  }
  
  try {
    const prevData = JSON.parse(prevDataStr);
    
    // Pour chaque tableau
    tables.forEach(table => {
      const prevTable = prevData.tables ? prevData.tables[table.id] : null;
      if(!prevTable) return;
      
      const tableElement = document.getElementById(table.id + 'Table');
      if(!tableElement) return;
      
      const rows = tableElement.querySelectorAll('tbody tr');
      
      rows.forEach(tr => {
        const destName = (tr.querySelector('.dest-name')?.value || "").trim();
        const trajetSel = tr.querySelector('.trajet-select');
        const trajetVal = trajetSel?.value || "";
        
        // Trouver ligne prÃ©cÃ©dente (mÃªme dest + trajet)
        const prevRow = (prevTable.rows || []).find(r => 
          r.dest === destName && r.trajet === trajetVal
        );
        
        if(!prevRow) return;
        
        // Comparer prix HT
        VEHICULES.forEach(catKey => {
          const htInput = tr.querySelector('.group-' + catKey + '.col-ht .price-input');
          const ttcInput = tr.querySelector('.group-' + catKey + '.col-ttc .ttc-input');
          
          if(!htInput) return;
          
          const currentPrice = parseFloat(htInput.value) || 0;
          const prevPrice = (prevRow.tarifs && prevRow.tarifs[catKey]) || 0;
          
          if(currentPrice > 0 && currentPrice === prevPrice){
            htInput.classList.add('price-unchanged');
            if(ttcInput) ttcInput.classList.add('price-unchanged');
          } else {
            htInput.classList.remove('price-unchanged');
            if(ttcInput) ttcInput.classList.remove('price-unchanged');
          }
        });
      });
    });
  } catch(e){
    console.error('Erreur markUnchangedPrices:', e);
  }
}

// ========== Ã‰VOLUTIONS ==========
async function computeEvolutions(){
  const prev = await loadPreviousYearPayload();
  document.querySelectorAll(".evol-cell").forEach(td => {
    td.textContent = "";
    td.classList.remove("evol-pos","evol-neg");
  });
  
  // VÃ©rifier format (ancien ou nouveau)
  const hasOldFormat = prev && Array.isArray(prev.rows);
  const hasNewFormat = prev && prev.tables && typeof prev.tables === 'object';
  
  if(!hasOldFormat && !hasNewFormat){
    const y = getCurrentYear();
    const c = getCurrentClient() || "CFMM";
    if(y){
      setStatus("Aucune Ã©volution calculÃ©e : aucune sauvegarde trouvÃ©e pour le client Â« " + c + " Â» en " + (parseInt(y,10)-1) + ".", false);
    }
    return;
  }

  // Construire la map des prix de l'annÃ©e prÃ©cÃ©dente
  const prevMap = {};
  
  if(hasOldFormat){
    // Ancien format
    prev.rows.forEach(r => {
      const dest = (r.dest || "").trim().toLowerCase().replace(/\s+/g, " ");
      const trajet = (r.trajet || "").trim().toLowerCase();
      VEHICULES.forEach(cat => {
        const val = r.tarifs && typeof r.tarifs[cat] === "number" ? r.tarifs[cat] : null;
        if(val != null){
          const key = dest + "|" + trajet + "|" + cat;
          prevMap[key] = val;
        }
      });
    });
  } else {
    // Nouveau format v11.0.6 - INCLURE tableId dans la clÃ©
    Object.entries(prev.tables).forEach(([tableId, tableData]) => {
      if(Array.isArray(tableData.rows)){
        tableData.rows.forEach(r => {
          const dest = (r.dest || "").trim().toLowerCase().replace(/\s+/g, " ");
          const trajet = (r.trajet || "").trim().toLowerCase();
          VEHICULES.forEach(cat => {
            const val = r.tarifs && typeof r.tarifs[cat] === "number" ? r.tarifs[cat] : null;
            if(val != null){
              const key = tableId + "|" + dest + "|" + trajet + "|" + cat; // V11.0.6 - Ajout tableId
              prevMap[key] = val;
            }
          });
        });
      }
    });
  }

  // Calculer les Ã©volutions pour TOUS les tableaux V11.0.6
  tables.forEach(table => {
    const allRows = document.querySelectorAll(`#${table.id}Table tbody tr`);
    allRows.forEach(tr => {
      const destName = (tr.querySelector(".dest-name")?.value || "").trim().toLowerCase().replace(/\s+/g, " ");
      const trajetSel = tr.querySelector(".trajet-select");
      const trajetVal = (trajetSel?.value || "").trim().toLowerCase();
      VEHICULES.forEach(cat => {
        const htInput = tr.querySelector(".group-" + cat + ".col-ht .price-input");
        const evolCell = tr.querySelector(".group-" + cat + ".col-evol");
        if(!htInput || !evolCell) return;
        const ht = parseNumberFR(htInput.value);
        const key = table.id + "|" + destName + "|" + trajetVal + "|" + cat; // V11.0.6 - Inclure table.id
        const prevVal = prevMap[key];
        if(!isFinite(ht) || prevVal == null || !isFinite(prevVal) || prevVal === 0){
          evolCell.textContent = "";
          return;
        }
        const evol = (ht - prevVal) / prevVal * 100;
        const arrow = evol >= 0 ? "â–²" : "â–¼";
        const value = Math.abs(evol);
        const txt = arrow + " " + formatNumberFR(value,1) + " %";
        evolCell.classList.remove("evol-pos","evol-neg");
        evolCell.classList.add(evol >= 0 ? "evol-pos" : "evol-neg");
        evolCell.textContent = txt;
      });
    });
  });
}

// BUGFIX V11.0.22: Wrapper pour appels async de computeEvolutions
function triggerComputeEvolutions(){
  computeEvolutions().then(() => markUnchangedPrices()).catch(err => {
    console.error('âŒ Erreur calcul Ã©volutions:', err);
  });
}

function refreshDestinationSuggestions(){
  const datalist = document.getElementById("destinationsList");
  if(!datalist) return;
  const namesSet = new Set();
  document.querySelectorAll(".dest-name").forEach(inp => {
    const v = (inp.value || "").trim();
    if(v.length >= 2) namesSet.add(v);
  });
  datalist.innerHTML = "";
  Array.from(namesSet).sort((a,b)=>a.localeCompare(b,"fr")).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    datalist.appendChild(opt);
  });
}

// ============================================================================
// BUGFIX V11.0.21 P0 #3: DÃ©tection doublons destinations (ignorer accents)
// ============================================================================
function checkDuplicateDestinations(){
  // Parcourir TOUS les tableaux
  const allDestInputs = document.querySelectorAll('.dest-name');
  const destMap = new Map(); // key = destination normalisÃ©e, value = array de rows
  
  // 1. Construire la map des destinations
  allDestInputs.forEach(input => {
    const destRaw = (input.value || '').trim();
    if(!destRaw) return; // Ignorer vides
    
    const destNormalized = normalizeText(destRaw);
    if(!destMap.has(destNormalized)){
      destMap.set(destNormalized, []);
    }
    destMap.get(destNormalized).push(input.closest('tr'));
  });
  
  // 2. Retirer tous les fonds jaunes
  allDestInputs.forEach(input => {
    input.style.background = '';
  });
  
  // 3. Appliquer fond jaune aux doublons
  destMap.forEach((rows, destNormalized) => {
    if(rows.length > 1){
      // C'est un doublon !
      rows.forEach(tr => {
        const input = tr.querySelector('.dest-name');
        if(input){
          input.style.background = '#fff9c4'; // Jaune clair
          input.title = `âš ï¸ Destination en double : ${rows.length} fois`;
        }
      });
    }
  });
}

// ========== Ã‰DITEUR CATÃ‰GORIES V10.10.0 ==========
function renderVehicleCategoriesEditor(){
  // v11.0.6 - DÃ©sactivÃ© : utiliser popup modale
  // Container supprimÃ©, bouton "Ã‰diter" utilisÃ© Ã  la place
}

function updateTableHeaders(){
  // Mettre Ã  jour les headers avec les nouveaux noms
  document.querySelectorAll('th.group-VL:not(.col-no):not(.col-evol)').forEach(th => {
    if(th.classList.contains('col-ht')){
      th.textContent = currentCategories.VL.name + ' HT';
    } else if(th.classList.contains('col-ttc')){
      th.textContent = currentCategories.VL.name + ' TTC';
    }
  });
  
  document.querySelectorAll('th.group-MC22:not(.col-no):not(.col-evol)').forEach(th => {
    if(th.classList.contains('col-ht')){
      th.textContent = currentCategories.MC22.name + ' HT';
    } else if(th.classList.contains('col-ttc')){
      th.textContent = currentCategories.MC22.name + ' TTC';
    }
  });
  
  document.querySelectorAll('th.group-MC33:not(.col-no):not(.col-evol)').forEach(th => {
    if(th.classList.contains('col-ht')){
      th.textContent = currentCategories.MC33.name + ' HT';
    } else if(th.classList.contains('col-ttc')){
      th.textContent = currentCategories.MC33.name + ' TTC';
    }
  });
  
  document.querySelectorAll('th.group-AC55:not(.col-no):not(.col-evol)').forEach(th => {
    if(th.classList.contains('col-ht')){
      th.textContent = currentCategories.AC55.name + ' HT';
    } else if(th.classList.contains('col-ttc')){
      th.textContent = currentCategories.AC55.name + ' TTC';
    }
  });
  
  document.querySelectorAll('th.group-AC64:not(.col-no):not(.col-evol)').forEach(th => {
    if(th.classList.contains('col-ht')){
      th.textContent = currentCategories.AC64.name + ' HT';
    } else if(th.classList.contains('col-ttc')){
      th.textContent = currentCategories.AC64.name + ' TTC';
    }
  });
}

// ========== POPUP Ã‰DITION CATÃ‰GORIES V11.0.6 ==========
let categoriesBackup = null;

function openCategoriesModal(){
  const modal = document.getElementById('categoriesModal');
  const tbody = document.getElementById('categoriesEditTable');
  const title = document.getElementById('categoriesModalTitle');
  
  // Sauvegarder Ã©tat actuel
  categoriesBackup = JSON.parse(JSON.stringify(currentCategories));
  
  // Titre avec client/annÃ©e
  const client = getCurrentClient();
  const year = getCurrentYear();
  title.textContent = `Ã‰diter les catÃ©gories - ${client} ${year}`;
  
  // GÃ©nÃ©rer lignes
  tbody.innerHTML = '';
  VEHICULES.forEach(catKey => {
    const cat = currentCategories[catKey];
    
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #e2e8f0';
    
    tr.innerHTML = `
      <td style="padding:12px 8px; text-align:center;">
        <input type="checkbox" class="cat-visible-check" data-cat="${catKey}" ${cat.visible ? 'checked' : ''} 
               style="width:18px; height:18px; cursor:pointer;">
      </td>
      <td style="padding:12px 8px;">
        <input type="text" class="cat-name-edit" data-cat="${catKey}" value="${cat.name}"
               style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:0.95rem;">
      </td>
      <td style="padding:12px 8px;">
        <input type="text" class="cat-capacity-edit" data-cat="${catKey}" value="${cat.capacity}"
               style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:0.95rem;">
      </td>
    `;
    
    tbody.appendChild(tr);
  });
  
  modal.style.display = 'block';
}

function closeCategoriesModal(){
  const modal = document.getElementById('categoriesModal');
  
  // Demander confirmation si changements
  const hasChanges = JSON.stringify(currentCategories) !== JSON.stringify(categoriesBackup);
  if(hasChanges){
    if(!confirm('Fermer sans sauvegarder ? Les modifications seront perdues.')){
      return;
    }
    // Restaurer backup
    currentCategories = categoriesBackup;
  }
  
  modal.style.display = 'none';
  categoriesBackup = null;
}

function saveCategoriesEdits(){
  const modal = document.getElementById('categoriesModal');
  
  // Lire valeurs
  document.querySelectorAll('.cat-visible-check').forEach(cb => {
    currentCategories[cb.dataset.cat].visible = cb.checked;
  });
  
  document.querySelectorAll('.cat-name-edit').forEach(input => {
    const val = input.value.trim();
    if(val){
      currentCategories[input.dataset.cat].name = val;
    }
  });
  
  document.querySelectorAll('.cat-capacity-edit').forEach(input => {
    const val = input.value.trim();
    if(val){
      currentCategories[input.dataset.cat].capacity = val;
    }
  });
  
  // Appliquer changements
  applyColumnVisibility();
  updateTableHeaders();
  
  // Sauvegarder
  saveGrid();
  
  setStatus('CatÃ©gories mises Ã  jour', false);
  
  modal.style.display = 'none';
  categoriesBackup = null;
}

// ========== FIN Ã‰DITEUR CATÃ‰GORIES ==========

// ========== IMPRESSION AVANCÃ‰E V11.0 ==========
function showPrintModal(){
  const modal = document.getElementById('printModal');
  
  // GÃ©nÃ©rer checkboxes catÃ©gories
  const catContainer = document.getElementById('printCategoriesCheckboxes');
  catContainer.innerHTML = '';
  VEHICULES.forEach(catKey => {
    const cat = currentCategories[catKey];
    const label = document.createElement('label');
    label.style.cssText = 'display:block; margin:5px 0; cursor:pointer;';
    label.innerHTML = `<input type="checkbox" class="print-cat" data-cat="${catKey}" checked> ${cat.name}`;
    catContainer.appendChild(label);
  });
  
  // GÃ©nÃ©rer checkboxes tableaux
  const tablesContainer = document.getElementById('printTablesCheckboxes');
  tablesContainer.innerHTML = '';
  tables.forEach(table => {
    const label = document.createElement('label');
    label.style.cssText = 'display:block; margin:5px 0; cursor:pointer;';
    label.innerHTML = `<input type="checkbox" class="print-table" data-table="${table.id}" checked> ${table.icon} ${table.name}`;
    tablesContainer.appendChild(label);
  });
  
  modal.style.display = 'flex';
}

function generatePrintView(){
  const client = getCurrentClient();
  const year = getCurrentYear();
  
  // RÃ©cupÃ©rer options
  const opts = {
    logo: document.getElementById('printLogo').checked,
    title: document.getElementById('printTitle').checked,
    clientYear: document.getElementById('printClientYear').checked,
    date: document.getElementById('printDate').checked,
    destination: document.getElementById('printDestination').checked,
    trajet: document.getElementById('printTrajet').checked,
    facture: document.getElementById('printFacture').checked,
    notes: document.getElementById('printNotes').checked,
    majorations: document.getElementById('printMajorations').checked,
    evolutions: document.getElementById('printEvolutions').checked,
    format: document.getElementById('printFormat').value,
    fontSize: document.getElementById('printFontSize').value + 'pt',
    compact: document.getElementById('printCompact').checked,
    colors: document.getElementById('printColors').checked,
    categories: [],
    tables: []
  };
  
  // CatÃ©gories sÃ©lectionnÃ©es
  document.querySelectorAll('.print-cat:checked').forEach(cb => {
    opts.categories.push(cb.dataset.cat);
  });
  
  // Tableaux sÃ©lectionnÃ©s
  document.querySelectorAll('.print-table:checked').forEach(cb => {
    opts.tables.push(cb.dataset.table);
  });
  
  // GÃ©nÃ©rer HTML impression
  let html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Grille ${client} ${year}</title>
  <style>
    /* Reset et base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    @page { 
      size: ${opts.format === 'a3-landscape' ? 'A3 landscape' : opts.format === 'a4-landscape' ? 'A4 landscape' : 'A4 portrait'}; 
      margin: ${opts.compact ? '8mm' : '12mm'}; 
    }
    
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      font-size: ${opts.fontSize};
      color: #000;
      line-height: 1.4;
      background: white;
    }
    
    
/* Header restructurÃ© V11.0.26 */
header {
  background: white;
  border-bottom: 2px solid var(--border);
  padding: 16px 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.header-bar {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 24px;
  max-width: 1800px;
  margin: 0 auto;
}

.header-left {
  display: flex;
  flex-direction: column;
  gap: 4px;
  justify-self: start;
}

.header-center {
  display: flex;
  justify-content: center;
}

.header-right {
  display: flex;
  flex-direction: column;
  gap: 12px;
  justify-self: end;
  align-items: flex-end;
}

.title-main {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  letter-spacing: -0.02em;
}

.title-sub {
  font-size: 1rem;
  color: var(--muted);
  font-weight: 500;
}

.header-logo img {
  max-width: 280px;
  max-height: 120px;
  object-fit: contain;
}

.selectors {
  display: flex;
  gap: 8px;
  align-items: center;
}

.button-row {
  display: flex;
  gap: 6px;
  align-items: center;
  justify-content: flex-end;
}

    .header { 
      text-align: center; 
      margin-bottom: 25px; 
      border-bottom: 4px solid ${opts.colors ? '#428bca' : '#333'};
      padding-bottom: 20px;
      page-break-after: avoid;
    }
    .header .logo {
      font-size: 2.5em; 
      margin-bottom: 15px;
      letter-spacing: 2px;
      font-weight: bold;
    }
    .header h1 { 
      margin: 15px 0; 
      color: ${opts.colors ? '#428bca' : '#333'}; 
      font-size: ${parseInt(opts.fontSize) * 2.2}px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .header .client-info {
      font-size: ${parseInt(opts.fontSize) * 1.3}px;
      margin: 12px 0;
      font-weight: 600;
      color: #333;
    }
    .header .print-date {
      color: #666;
      font-size: ${parseInt(opts.fontSize) * 0.95}px;
      margin-top: 10px;
    }
    
    /* Tableaux */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 25px;
      font-size: ${opts.fontSize};
      page-break-inside: avoid;
    }
    
    thead {
      display: table-header-group;
    }
    
    tbody {
      display: table-row-group;
    }
    
    th { 
      background: ${opts.colors ? 'linear-gradient(180deg, #5a9fd4 0%, #428bca 100%)' : '#e0e0e0'}; 
      color: ${opts.colors ? 'white' : '#000'}; 
      padding: ${opts.compact ? '8px 6px' : '12px 10px'}; 
      border: 1px solid ${opts.colors ? '#3a7cb8' : '#999'};
      font-weight: 700;
      text-align: center;
      font-size: ${parseInt(opts.fontSize) * 0.95}px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    td { 
      padding: ${opts.compact ? '6px 5px' : '10px 8px'}; 
      border: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
    }
    
    tr:nth-child(even) {
      background: ${opts.colors ? '#f8f9fa' : '#fafafa'};
    }
    
    tr:hover {
      background: ${opts.colors ? '#e9f5ff' : '#f0f0f0'};
    }
    
    /* Titre tableau */
    .table-title {
      font-size: ${parseInt(opts.fontSize) * 1.6}px;
      font-weight: 700;
      margin: 30px 0 15px 0;
      color: ${opts.colors ? '#428bca' : '#333'};
      border-bottom: 3px solid ${opts.colors ? '#428bca' : '#333'};
      padding-bottom: 8px;
      page-break-after: avoid;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    /* Majorations */
    .majorations {
      background: ${opts.colors ? 'linear-gradient(135deg, #fffef0 0%, #fff9e6 100%)' : '#f5f5f5'};
      padding: 20px;
      border-left: 5px solid ${opts.colors ? '#ffc107' : '#999'};
      border-radius: 4px;
      margin: 25px 0;
      white-space: pre-wrap;
      font-size: ${parseInt(opts.fontSize) * 0.95}px;
      line-height: 1.6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .majorations strong {
      display: block;
      margin-bottom: 10px;
      font-size: ${parseInt(opts.fontSize) * 1.1}px;
      color: ${opts.colors ? '#d19000' : '#333'};
    }
    
    /* Colonne destination */
    .destination-col { 
      font-weight: 700;
      text-align: left;
      padding-left: 10px;
      color: #000;
    }
    
    /* Impression */
    @media print {
      body { 
        print-color-adjust: exact; 
        -webkit-print-color-adjust: exact;
      }
      
      /* Masquer headers/footers navigateur */
      @page {
        margin-top: 8mm;
        margin-bottom: 8mm;
      }
      
      /* Ã‰viter coupures */
      .header, .table-title, .majorations {
        page-break-inside: avoid;
        page-break-after: avoid;
      }
      
      table {
        page-break-inside: auto;
      }
      
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      thead {
        display: table-header-group;
      }
      
      /* Masquer URL et autres infos navigateur */
      a[href]:after {
        content: none !important;
      }
    }
    
    /* Optimisations visuelles V11.0.2 */
    .price-ht {
      background: ${opts.colors ? 'linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%)' : '#f5f5f5'} !important;
      color: ${opts.colors ? '#1b5e20' : '#000'};
      font-weight: 700;
      text-align: center;
      padding: 10px 8px !important;
    }
    
    .price-ttc {
      background: ${opts.colors ? 'linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%)' : '#f5f5f5'} !important;
      color: ${opts.colors ? '#0d47a1' : '#000'};
      font-weight: 700;
      text-align: center;
      padding: 10px 8px !important;
    }
    
    /* Footer professionnel (optionnel) */
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      text-align: center;
      font-size: ${parseInt(opts.fontSize) * 0.8}px;
      color: #666;
      padding: 10px;
      border-top: 1px solid #ddd;
      background: white;
    }
  
/* Tooltip destination au survol */
td.dest input:hover::after {
  content: attr(value);
  position: absolute;
  left: 0;
  top: 100%;
  background: rgba(0,0,0,0.9);
  color: white;
  padding: 8px 12px;
  border-radius: 4px;
  white-space: nowrap;
  z-index: 1000;
  font-size: 0.85rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  pointer-events: none;
}

</style>
</head>
<body>
`;
  
  // En-tÃªte
  if(opts.logo || opts.title || opts.clientYear || opts.date){
    html += '<div class="header">';
    if(opts.logo) html += '<div class="logo">ğŸš AUTOCARS BALLANFAT</div>';
    if(opts.title) html += '<h1>Grille Tarifaire</h1>';
    if(opts.clientYear) html += `<div class="client-info">${client} â€¢ ${year}</div>`;
    if(opts.date) html += `<div class="print-date">ImprimÃ© le ${new Date().toLocaleDateString('fr-FR', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div>`;
    html += '</div>';
  }
  
  // Majorations
  if(opts.majorations){
    const majorationsText = document.getElementById('conditionsText')?.value || '';
    if(majorationsText){
      html += `<div class="majorations"><strong>ğŸ“‹ Conditions et Majorations</strong>${majorationsText}</div>`;
    }
  }
  
  // Tableaux
  opts.tables.forEach(tableId => {
    const table = tables.find(t => t.id === tableId);
    if(!table) return;
    
    const tableElem = document.querySelector(`#${tableId}Table`);
    if(!tableElem) return;
    
    html += `<div class="table-title">${table.icon} ${table.name}</div>`;
    html += '<table>';
    
    // Headers
    html += '<thead><tr>';
    if(opts.destination) html += '<th>Destination</th>';
    if(opts.trajet) html += '<th>Trajet</th>';
    
    opts.categories.forEach(catKey => {
      const cat = currentCategories[catKey];
      if(opts.facture) html += `<th>NÂ° ${cat.name}</th>`;
      html += `<th>${cat.name} HT</th>`;
      html += `<th>${cat.name} TTC</th>`;
      if(opts.evolutions) html += `<th>Ã‰vol. %</th>`;
    });
    
    if(opts.notes) html += '<th>Note</th>';
    html += '</tr></thead><tbody>';
    
    // DonnÃ©es
    const rows = tableElem.querySelectorAll('tbody tr');
    rows.forEach(tr => {
      if(tr.style.display === 'none') return;
      
      html += '<tr>';
      
      if(opts.destination){
        const dest = tr.querySelector('.dest-name')?.value || '';
        html += `<td class="destination-col">${dest}</td>`;
      }
      
      if(opts.trajet){
        const trajetSel = tr.querySelector('.trajet-select');
        const trajetText = trajetSel ? trajetSel.options[trajetSel.selectedIndex].text : '';
        html += `<td>${trajetText}</td>`;
      }
      
      opts.categories.forEach(catKey => {
        if(opts.facture){
          const factureInputs = tr.querySelectorAll('.facture-input');
          let factureVal = '';
          factureInputs.forEach(inp => {
            if(inp.closest('td').classList.contains('group-' + catKey)){
              factureVal = inp.value || '';
            }
          });
          html += `<td>${factureVal}</td>`;
        }
        
        // HT
        const htInputs = tr.querySelectorAll('.price-input');
        let htVal = '';
        htInputs.forEach(inp => {
          if(inp.dataset.key && inp.dataset.key.includes(catKey + '|HT')){
            htVal = inp.value || '';
          }
        });
        html += `<td class="price-ht">${htVal ? htVal + ' â‚¬' : ''}</td>`;
        
        // TTC
        const ttcInputs = tr.querySelectorAll('.ttc-input');
        let ttcVal = '';
        ttcInputs.forEach(inp => {
          if(inp.dataset.key && inp.dataset.key.includes(catKey + '|TTC')){
            ttcVal = inp.value || '';
          }
        });
        html += `<td class="price-ttc">${ttcVal ? ttcVal + ' â‚¬' : ''}</td>`;
        
        // Ã‰vol
        if(opts.evolutions){
          const evolCells = tr.querySelectorAll('.evol-cell');
          let evolVal = '';
          evolCells.forEach(cell => {
            if(cell.classList.contains('group-' + catKey)){
              evolVal = cell.textContent.trim();
            }
          });
          html += `<td>${evolVal}</td>`;
        }
      });
      
      if(opts.notes){
        const note = tr.querySelector('.note-input')?.value || '';
        html += `<td>${note}</td>`;
      }
      
      html += '</tr>';
    });
    
    html += '</tbody></table>';
  });
  
  html += '</body></html>